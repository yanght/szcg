/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/IdentityManagerBase",["dijit","dojo","dojox","dojo/require!dojo/cookie,esri/utils"],function(_1,_2,_3){_2.provide("esri.IdentityManagerBase");_2.require("dojo.cookie");_2.require("esri.utils");(function(){var _4={};var _5=function(_6,_7){var _8=new _2._Url(_6).host,_9=new _2._Url(_7.server).host,_a=/.+\.arcgis\.com$/i;return (_a.test(_8)&&_a.test(_9));};_2.declare("esri.IdentityManagerBase",null,{constructor:function(){this._portalConfig=_2.getObject("esriGeowConfig");this.serverInfos=[];this.credentials=[];this._soReqs=[];this._xoReqs=[];this._portals=[];},tokenValidity:60,signInPage:null,_busy:null,_gwTokenUrl:"/sharing/generateToken",_agsRest:"/rest/services",_agsAdmin:/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i,_agolSuffix:".arcgis.com",_gwDomains:[{regex:/https?:\/\/www\.arcgis\.com/i,tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/dev\.arcgis\.com/i,tokenServiceUrl:"https://dev.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*dev[^.]*\.arcgis\.com/i,tokenServiceUrl:"https://devext.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*qa[^.]*\.arcgis\.com/i,tokenServiceUrl:"https://qaext.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*.arcgis\.com/i,tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"}],_regexSDirUrl:/http.+\/rest\/services\/?/ig,_regexServerType:/(\/(MapServer|GeocodeServer|GPServer|GeometryServer|ImageServer|NAServer|FeatureServer|GeoDataServer|GlobeServer|MobileServer)).*/ig,_gwUser:/http.+\/users\/([^\/]+)\/?.*/i,_gwItem:/http.+\/items\/([^\/]+)\/?.*/i,_gwGroup:/http.+\/groups\/([^\/]+)\/?.*/i,_errorCodes:[499,498,403,401],_publicUrls:[/\/arcgis\/tokens/i,/\/sharing\/generatetoken/i,/\/rest\/info/i],registerServers:function(_b){var _c=this.serverInfos;if(_c){_b=_2.filter(_b,function(_d){return !this.findServerInfo(_d.server);},this);this.serverInfos=_c.concat(_b);}else{this.serverInfos=_b;}_2.forEach(_b,function(_e){if(_e.owningSystemUrl){this._portals.push(_e.owningSystemUrl);}},this);},toJson:function(){return esri._sanitize({"serverInfos":_2.map(this.serverInfos,function(_f){return _f.toJson();}),"credentials":_2.map(this.credentials,function(crd){return crd.toJson();})});},initialize:function(_10){if(!_10){return;}if(_2.isString(_10)){_10=_2.fromJson(_10);}var _11=_10.serverInfos,_12=_10.credentials;if(_11){var _13=[];_2.forEach(_11,function(_14){if(_14.server&&_14.tokenServiceUrl){_13.push(_14.declaredClass?_14:new esri.ServerInfo(_14));}});if(_13.length){this.registerServers(_13);}}if(_12){_2.forEach(_12,function(crd){if(crd.userId&&crd.server&&crd.token&&crd.expires&&(crd.expires>(new Date()).getTime())){crd=crd.declaredClass?crd:new esri.Credential(crd);crd.onTokenChange();this.credentials.push(crd);}},this);}},findServerInfo:function(_15){var _16;_15=this._sanitizeUrl(_15);_2.some(this.serverInfos,function(_17){if(esri._hasSameOrigin(_17.server,_15,true)){_16=_17;}return !!_16;});return _16;},findCredential:function(_18,_19){var _1a;_18=this._sanitizeUrl(_18);if(_19){_2.some(this.credentials,function(crd){if(esri._hasSameOrigin(_18,crd.server,true)&&_19===crd.userId){_1a=crd;}return !!_1a;},this);}else{_2.some(this.credentials,function(crd){if(esri._hasSameOrigin(_18,crd.server,true)&&this._getIdenticalSvcIdx(_18,crd)!==-1){_1a=crd;}return !!_1a;},this);}return _1a;},getCredential:function(_1b,_1c){var _1d,_1e;if(esri._isDefined(_1c)){if(_2.isObject(_1c)){_1d=!!_1c.token;_1e=_1c.error;}else{_1d=_1c;}}_1b=this._sanitizeUrl(_1b);var dfd=new _2.Deferred(esri._dfdCanceller),err,_1f=this._isAdminResource(_1b),_20=(_1d&&this._doPortalSignIn(_1b))?_2.cookie("esri_auth"):null;if(_20){_20=_2.fromJson(_20);err=new Error("You are currently signed in as: '"+_20.email+"'. You do not have access to this resource: "+_1b);err.code="IdentityManagerBase."+1;err.messageCode=_1e?_1e.messageCode:null;err.subcode=_1e?_1e.subcode:null;err.log=_2.config.isDebug;dfd.errback(err);return dfd;}var _21=this._findCredential(_1b,_1c);if(_21){dfd.callback(_21);return dfd;}var _22=this.findServerInfo(_1b);if(!_22){var _23=this._getTokenSvcUrl(_1b);if(!_23){err=new Error("Unknown resource - could not find token service endpoint.");err.code="IdentityManagerBase."+2;err.log=_2.config.isDebug;dfd.errback(err);return dfd;}_22=new esri.ServerInfo();_22.server=this._getOrigin(_1b);if(_2.isString(_23)){_22.tokenServiceUrl=_23;}else{_22._restInfoDfd=_23;}this.registerServers([_22]);}return this._enqueue(_1b,_22,_1c,dfd,_1f);},getResourceName:function(_24){if(this._isRESTService(_24)){return _24.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"";}else{return (this._gwUser.test(_24)&&_24.replace(this._gwUser,"$1"))||(this._gwItem.test(_24)&&_24.replace(this._gwItem,"$1"))||(this._gwGroup.test(_24)&&_24.replace(this._gwGroup,"$1"))||"";}},generateToken:function(_25,_26,_27){var _28,_29,_2a;if(_27){_28=_27.isAdmin;_29=_27.serverUrl;_2a=_27.token;}var _2b=esri.request({url:_28?_25.adminTokenServiceUrl:_25.tokenServiceUrl,content:{request:"getToken",username:_26&&_26.username,password:_26&&_26.password,serverUrl:_29,token:_2a,expiration:esri.id.tokenValidity,referer:(_28||_25.tokenServiceUrl.toLowerCase().indexOf("/sharing/generatetoken")!==-1)?window.location.host:null,client:_28?"referer":null,f:"json"},handleAs:"json"},{usePost:true,disableIdentityLookup:true,useProxy:this._useProxy(_25,_27)});_2b.addCallback(function(_2c){if(!_2c||!_2c.token){var err=new Error("Unable to generate token");err.code="IdentityManagerBase."+3;err.log=_2.config.isDebug;return err;}var _2d=_25.server;if(!_4[_2d]){_4[_2d]={};}if(_26){_4[_2d][_26.username]=_26.password;}return _2c;});_2b.addErrback(function(_2e){});return _2b;},isBusy:function(){return !!this._busy;},setRedirectionHandler:function(_2f){this._redirectFunc=_2f;},setProtocolErrorHandler:function(_30){this._protocolFunc=_30;},signIn:function(){},_findCredential:function(_31,_32){var idx=-1,_33,_34,_35,_36,_37=_32&&_32.token,_38=_32&&_32.resource,_39=_2.filter(this.credentials,function(crd){return esri._hasSameOrigin(crd.server,_31,true);});_31=_38||_31;if(_39.length){if(_39.length===1){_33=_39[0];_36=this.findServerInfo(_33.server);_34=_36&&_36.owningSystemUrl;_35=_34&&!_5(_34,_36)&&this.findCredential(_34,_33.userId);idx=this._getIdenticalSvcIdx(_31,_33);if(_37){if(idx!==-1){_33.resources.splice(idx,1);this._removeResource(_31,_35);}}else{if(idx===-1){_33.resources.push(_31);}this._addResource(_31,_35);return _33;}}else{var _3a,i;_2.some(_39,function(crd){i=this._getIdenticalSvcIdx(_31,crd);if(i!==-1){_3a=crd;_36=this.findServerInfo(_3a.server);_34=_36&&_36.owningSystemUrl;_35=_34&&!_5(_34,_36)&&this.findCredential(_34,_3a.userId);idx=i;return true;}return false;},this);if(_37){if(_3a){_3a.resources.splice(idx,1);this._removeResource(_31,_35);}}else{if(_3a){this._addResource(_31,_35);return _3a;}}}}},_addResource:function(_3b,_3c){if(_3c){if(this._getIdenticalSvcIdx(_3b,_3c)===-1){_3c.resources.push(_3b);}}},_removeResource:function(_3d,_3e){var idx=-1;if(_3e){idx=this._getIdenticalSvcIdx(_3d,_3e);if(idx>-1){_3e.resources.splice(idx,1);}}},_useProxy:function(_3f,_40){return (_40&&_40.isAdmin)||(!this._isPortalDomain(_3f.tokenServiceUrl)&&_3f.currentVersion==10.1&&!esri._hasSameOrigin(_3f.tokenServiceUrl,window.location.href));},_getOrigin:function(_41){var uri=new _2._Url(_41);return uri.scheme+"://"+uri.host+(esri._isDefined(uri.port)?(":"+uri.port):"");},_sanitizeUrl:function(url){url=_2.trim(url);var _42=(esri.config.defaults.io.proxyUrl||"").toLowerCase(),_43=_42?url.toLowerCase().indexOf(_42+"?"):-1;if(_43!==-1){url=url.substring(_43+_42.length+1);}return esri.urlToObject(url).path;},_isRESTService:function(_44){return (_44.indexOf(this._agsRest)>-1);},_isAdminResource:function(_45){return this._agsAdmin.test(_45);},_isIdenticalService:function(_46,_47){var _48;if(this._isRESTService(_46)&&this._isRESTService(_47)){var _49=this._getSuffix(_46).toLowerCase(),_4a=this._getSuffix(_47).toLowerCase();_48=(_49===_4a);if(!_48){var _4b=/(.*)\/(MapServer|FeatureServer).*/ig;_48=(_49.replace(_4b,"$1")===_4a.replace(_4b,"$1"));}}else{if(this._isPortalDomain(_46)){_48=true;}else{if(this._isAdminResource(_46)&&this._isAdminResource(_47)){return true;}}}return _48;},_isPortalDomain:function(_4c){_4c=_4c.toLowerCase();var _4d=(new _2._Url(_4c)).authority,_4e=this._portalConfig,_4f=(_4d.indexOf(this._agolSuffix)!==-1);if(!_4f&&_4e){_4f=esri._hasSameOrigin(_4e.restBaseUrl,_4c,true);}if(!_4f){if(!this._arcgisUrl){var _50=_2.getObject("esri.arcgis.utils.arcgisUrl");if(_50){this._arcgisUrl=(new _2._Url(_50)).authority;}}if(this._arcgisUrl){_4f=(this._arcgisUrl.toLowerCase()===_4d);}}if(!_4f){_4f=_2.some(this._portals,function(_51){return esri._hasSameOrigin(_51,_4c,true);});}return _4f;},_isIdProvider:function(_52,_53){var i=-1,j=-1;_2.forEach(this._gwDomains,function(_54,idx){if(i===-1&&_54.regex.test(_52)){i=idx;}if(j===-1&&_54.regex.test(_53)){j=idx;}});var _55=false;if(i>-1&&j>-1){if(i===0||i===4){if(j===0||j===4){_55=true;}}else{if(i===1){if(j===1||j===2){_55=true;}}else{if(i===2){if(j===2){_55=true;}}else{if(i===3){if(j===3){_55=true;}}}}}}if(!_55){var _56=this.findServerInfo(_53),_57=_56&&_56.owningSystemUrl;if(_57&&_5(_57,_56)&&this._isPortalDomain(_57)&&this._isIdProvider(_52,_57)){_55=true;}}return _55;},_isPublic:function(_58){_58=this._sanitizeUrl(_58);return _2.some(this._publicUrls,function(_59){return _59.test(_58);});},_getIdenticalSvcIdx:function(_5a,_5b){var idx=-1;_2.some(_5b.resources,function(_5c,i){if(this._isIdenticalService(_5a,_5c)){idx=i;return true;}return false;},this);return idx;},_getSuffix:function(_5d){return _5d.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1");},_getTokenSvcUrl:function(_5e){var _5f,dfd,_60;if(this._isRESTService(_5e)){_60=_5e.toLowerCase().indexOf(this._agsRest);_5f=_5e.substring(0,_60)+"/admin/generateToken";_5e=_5e.substring(0,_60+"/rest/".length)+"info";if(this._isPortalDomain(_5e)){_5e=_5e.replace(/http:/i,"https:");}dfd=esri.request({url:_5e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"});dfd.adminUrl_=_5f;return dfd;}else{if(this._isPortalDomain(_5e)){var url="";_2.some(this._gwDomains,function(_61){if(_61.regex.test(_5e)){url=_61.tokenServiceUrl;return true;}return false;});if(!url){var _62=this._getOrigin(_5e);url=_62.replace(/http:/i,"https:")+this._gwTokenUrl;}return url;}else{if(_5e.toLowerCase().indexOf("premium.arcgisonline.com")!==-1){return "https://premium.arcgisonline.com/server/tokens";}else{if(this._isAdminResource(_5e)){_60=_5e.toLowerCase().indexOf("/admin/");_5f=_5e.substring(0,_60+"/admin/".length)+"generateToken";_5e=_5e.substring(0,_60)+"/rest/info";dfd=esri.request({url:_5e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"});dfd.adminUrl_=_5f;return dfd;}}}}},_hasPortalSession:function(){return _2.cookie.isSupported()?!!_2.cookie("esri_auth"):false;},_doPortalSignIn:function(_63){if(_2.cookie.isSupported()){var _64=_2.cookie("esri_auth"),_65=this._portalConfig,_66=window.location.href,_67=this.findServerInfo(_63);if((_65||this._isPortalDomain(_66)||_64)&&(this._isPortalDomain(_63)||(_67&&_67.owningSystemUrl&&this._isPortalDomain(_67.owningSystemUrl)))&&(this._isIdProvider(_66,_63)||(_65&&(esri._hasSameOrigin(_65.restBaseUrl,_63,true)||this._isIdProvider(_65.restBaseUrl,_63)))||esri._hasSameOrigin(_66,_63,true))){return true;}}return false;},_checkProtocol:function(_68,_69,_6a){var _6b=true,_6c=_69.tokenServiceUrl;if(_2.trim(_6c).toLowerCase().indexOf("https:")===0&&window.location.href.toLowerCase().indexOf("https:")!==0&&!esri._canDoXOXHR(_6c)&&!esri._canDoXOXHR(esri._getProxyUrl(true).path)){_6b=this._protocolFunc?!!this._protocolFunc({resourceUrl:_68,serverInfo:_69}):false;if(!_6b){var err=new Error("Aborted the Sign-In process to avoid sending password over insecure connection.");err.code="IdentityManagerBase."+4;err.log=_2.config.isDebug;console.log(err.message);_6a(err);}}return _6b;},_enqueue:function(_6d,_6e,_6f,dfd,_70){if(!dfd){dfd=new _2.Deferred(esri._dfdCanceller);}dfd.resUrl_=_6d;dfd.sinfo_=_6e;dfd.options_=_6f;dfd.admin_=_70;if(this._busy){if(esri._hasSameOrigin(_6d,this._busy.resUrl_,true)){this._soReqs.push(dfd);}else{this._xoReqs.push(dfd);}}else{this._doSignIn(dfd);}return dfd;},_doSignIn:function(dfd){this._busy=dfd;var _71=this;var _72=function(_73){var _74=dfd.options_&&dfd.options_.resource;if(!_73.resources){_73.resources=[];}_73.resources.push(_74||dfd.resUrl_);_73.onTokenChange();if(_2.indexOf(_71.credentials,_73)===-1){_71.credentials.push(_73);}var _75=_71._soReqs,_76={};_71._soReqs=[];_2.forEach(_75,function(_77){if(!this._isIdenticalService(dfd.resUrl_,_77.resUrl_)){var _78=this._getSuffix(_77.resUrl_);if(!_76[_78]){_76[_78]=true;_73.resources.push(_77.resUrl_);}}},_71);dfd.callback(_73);_2.forEach(_75,function(_79){_79.callback(_73);});_71._busy=dfd.resUrl_=dfd.sinfo_=null;if(_71._xoReqs.length){_71._doSignIn(_71._xoReqs.shift());}},_7a=function(_7b){dfd.errback(_7b);_71._busy=dfd.resUrl_=dfd.sinfo_=null;if(_71._soReqs.length){_71._doSignIn(_71._soReqs.shift());}if(_71._xoReqs.length){_71._doSignIn(_71._xoReqs.shift());}},_7c=function(){if(_71._doPortalSignIn(dfd.resUrl_)){var _7d=_2.cookie("esri_auth"),_7e=_71._portalConfig;if(_7d){_7d=_2.fromJson(_7d);_72(new esri.Credential({userId:_7d.email,server:dfd.sinfo_.server,token:_7d.token,expires:null}));return;}else{var _7f="",_80=window.location.href;if(_71.signInPage){_7f=_71.signInPage;}else{if(_7e){_7f=_7e.baseUrl+_7e.signin;}else{if(_71._isIdProvider(_80,dfd.resUrl_)){_7f=_71._getOrigin(_80)+"/home/signin.html";}else{_7f=dfd.sinfo_.server+"/home/signin.html";}}}_7f=_7f.replace(/http:/i,"https:");if(_7e&&_7e.useSSL===false){_7f=_7f.replace(/https:/i,"http:");}if(_80.toLowerCase().replace("https","http").indexOf(_7f.toLowerCase().replace("https","http"))===0){var err=new Error("Cannot redirect to Sign-In page from within Sign-In page. URL of the resource that triggered this workflow: "+dfd.resUrl_);err.code="IdentityManagerBase."+5;err.log=_2.config.isDebug;_7a(err);}else{if(_71._redirectFunc){_71._redirectFunc({signInPage:_7f,returnUrlParamName:"returnUrl",returnUrl:_80,resourceUrl:dfd.resUrl_,serverInfo:dfd.sinfo_});}else{window.location=_7f+"?returnUrl="+window.escape(_80);}}return;}}else{if(_71._checkProtocol(dfd.resUrl_,dfd.sinfo_,_7a)){var _81=dfd.options_;if(dfd.admin_){_81=_81||{};_81.isAdmin=true;}dfd._pendingDfd=_71.signIn(dfd.resUrl_,dfd.sinfo_,_81).addCallbacks(_72,_7a);}}},_82=function(){var _83=dfd.sinfo_,_84=_83.owningSystemUrl,_85=dfd.options_,_86,_87,_88;if(_85){_86=_85.token;_87=_85.error;}_88=_71._findCredential(_84,{token:_86,resource:dfd.resUrl_});if(_88){var _89=_71.findCredential(dfd.resUrl_,_88.userId);if(_89){_72(_89);return;}var _8a=(dfd._pendingDfd=_71.generateToken(_71.findServerInfo(_88.server),null,{serverUrl:dfd.resUrl_,token:_88.token}));_8a.addCallbacks(function(_8b){_72(new esri.Credential({userId:_88.userId,server:_83.server,token:_8b.token,expires:esri._isDefined(_8b.expires)?Number(_8b.expires):null,ssl:!!_8b.ssl,isAdmin:dfd.admin_,validity:_83.shortLivedTokenValidity}));},_7a);}else{_71._busy=null;if(_86){dfd.options_.token=null;}var _8c=(dfd._pendingDfd=_71.getCredential(_84,{resource:dfd.resUrl_,token:_86,error:_87}));_8c.addCallbacks(function(_8d){_71._enqueue(dfd.resUrl_,dfd.sinfo_,dfd.options_,dfd,dfd.admin_);},function(_8e){_7a(_8e);});}};var _8f=dfd.sinfo_.tokenServiceUrl,_90=dfd.sinfo_.owningSystemUrl;if(_8f){if(_90&&!_5(_90,dfd.sinfo_)){_82();}else{_7c();}}else{dfd.sinfo_._restInfoDfd.addCallbacks(function(_91){var _92=dfd.sinfo_;_92.adminTokenServiceUrl=_92._restInfoDfd.adminUrl_;_92._restInfoDfd=null;_92.tokenServiceUrl=_2.getObject("authInfo.tokenServicesUrl",false,_91)||_2.getObject("authInfo.tokenServiceUrl",false,_91)||_2.getObject("tokenServiceUrl",false,_91);_92.shortLivedTokenValidity=_2.getObject("authInfo.shortLivedTokenValidity",false,_91);_92.currentVersion=_91.currentVersion;_92.owningTenant=_91.owningTenant;var _93=(_92.owningSystemUrl=_91.owningSystemUrl);if(_93){_71._portals.push(_93);if(_5(_93,_92)){var _94=_71.findCredential(_93);if(!_94){_2.some(_71.credentials,function(_95){if(this._isIdProvider(_93,_95.server)){_94=_95;}return !!_94;},_71);}if(_94){_94=_94.toJson();_94.resources=null;_94.server=_92.server;_72(new esri.Credential(_94));return;}_7c();}else{_82();}}else{_7c();}},function(){dfd.sinfo_._restInfoDfd=null;var err=new Error("Unknown resource - could not find token service endpoint.");err.code="IdentityManagerBase."+2;err.log=_2.config.isDebug;_7a(err);});}}});_2.declare("esri.ServerInfo",null,{constructor:function(_96){_2.mixin(this,_96);},toJson:function(){return esri._sanitize({server:this.server,tokenServiceUrl:this.tokenServiceUrl,adminTokenServiceUrl:this.adminTokenServiceUrl,shortLivedTokenValidity:this.shortLivedTokenValidity,owningSystemUrl:this.owningSystemUrl,owningTenant:this.owningTenant,currentVersion:this.currentVersion});}});_2.declare("esri.Credential",null,{tokenRefreshBuffer:2,constructor:function(_97){_2.mixin(this,_97);this.resources=this.resources||[];if(!esri._isDefined(this.creationTime)){this.creationTime=(new Date()).getTime();}},refreshToken:function(){var _98=this,_99=esri.id.findServerInfo(this.server),_9a=_99&&_99.owningSystemUrl,_9b=_9a&&!_5(_9a,_99),_9c=this.resources&&this.resources[0],_9d=_4[this.server],_9e=_9d&&_9d[this.userId];if(!_9e&&!_9b){var dfd;if(_9c){_9c=esri.id._sanitizeUrl(_9c);this._enqueued=1;dfd=esri.id._enqueue(_9c,_99,null,null,this.isAdmin);dfd.addBoth(function(){_98._enqueued=0;});}return dfd;}var _9f,_a0,_a1;if(_9b){_a0=esri.id.findServerInfo(_9a);_a1=_a0&&esri.id.findCredential(_a0.server,_98.userId);if(!_a1){return;}_9f={serverUrl:_9c,token:_a1&&_a1.token};}else{if(_98.isAdmin){_9f={isAdmin:true};}}return esri.id.generateToken(_9b?_a0:_99,_9b?null:{username:_98.userId,password:_9e},_9f).addCallback(function(_a2){_98.token=_a2.token;_98.expires=esri._isDefined(_a2.expires)?Number(_a2.expires):null;_98.creationTime=(new Date()).getTime();_98.onTokenChange();var _a3=_2.filter(esri.id.credentials,function(_a4){var _a5=esri.id.findServerInfo(_a4.server),_9a=_a5&&_a5.owningSystemUrl;return (_a4.userId===_98.userId&&_9a&&!_5(_9a,_a5)&&esri._hasSameOrigin(_98.server,_9a,true))?true:false;});_2.forEach(_a3,function(_a6){_a6.refreshToken();});}).addErrback(function(){});},onTokenChange:function(){clearTimeout(this._refreshTimer);var _a7=this.server&&esri.id.findServerInfo(this.server),_a8=_a7&&_a7.owningSystemUrl;if((!_a8||_5(_a8,_a7))&&(esri._isDefined(this.expires)||esri._isDefined(this.validity))){this._startRefreshTimer();}},onDestroy:function(){},destroy:function(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null;var _a9=_2.indexOf(esri.id.credentials,this);if(_a9>-1){esri.id.credentials.splice(_a9,1);}this.onTokenChange();this.onDestroy();},toJson:function(){return this._toJson();},_toJson:function(){var _aa=esri._sanitize({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime});var _ab=this.resources;if(_ab&&_ab.length>0){_aa.resources=_ab;}return _aa;},_startRefreshTimer:function(){clearTimeout(this._refreshTimer);var _ac=this.tokenRefreshBuffer*60000,_ad=this.validity?(this.creationTime+(this.validity*60000)):this.expires,_ae=(_ad-(new Date()).getTime());if(_ae<0){_ae=0;}this._refreshTimer=setTimeout(_2.hitch(this,this.refreshToken),(_ae>_ac)?(_ae-_ac):_ae);}});}());});