/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/MapNavigationManager",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/sniff","dojo/_base/connect","dojo/_base/event","dojo/mouse","dojo/keys","esri","esri/MouseEvents","esri/TouchEvents","esri/utils","esri/geometry","esri/symbol","esri/graphic","esri/fx"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c=_5.connect,_d=_5.disconnect,_e=_9.geometry.ScreenPoint,_f=_9.geometry.Extent,_10=_9.geometry.Rect,_11=1,_12=-1,_13=100,_14=10,_15=[_8.NUMPAD_PLUS,61,_8.NUMPAD_MINUS,_8.UP_ARROW,_8.NUMPAD_8,_8.RIGHT_ARROW,_8.NUMPAD_6,_8.DOWN_ARROW,_8.NUMPAD_2,_8.LEFT_ARROW,_8.NUMPAD_4,_8.PAGE_UP,_8.NUMPAD_9,_8.PAGE_DOWN,_8.NUMPAD_3,_8.END,_8.NUMPAD_1,_8.HOME,_8.NUMPAD_7];var _16=_1(null,{eventModel:"",constructor:function(map,_17){this.map=map;_2.mixin(this,_17);var _18=map.__container;if(_9.isTouchEnabled){this.touchEvents=new _b(_18,{map:map});this.eventModel="touch";}else{this.mouseEvents=new _a(_18,{map:map});this.eventModel="mouse";this._zoomRect=new _9.Graphic(null,new _9.symbol.SimpleFillSymbol(_9.config.defaults.map.zoomSymbol));}this._keyDx=this._keyDy=0;this._adjustPinch=dojo.hitch(this,this._adjustPinch);this._adjustPinchEnd=dojo.hitch(this,this._adjustPinchEnd);},_panInit:function(evt){var _19=this.mouseEvents;if(_7.isLeft(evt)&&this.map.isPan&&!evt.shiftKey){this._dragOrigin=new _e(0,0);_2.mixin(this._dragOrigin,evt.screenPoint);this._panStartHandle=_c(_19,"onMouseDragStart",this,this._panStart);this._panHandle=_c(_19,"onMouseDrag",this,this._pan);this._panEndHandle=_c(_19,"onMouseUp",this,this._panEnd);if(_4("chrome")){evt.preventDefault();}}},_panStart:function(evt){this.map.setCursor("move");this.map.__panStart(evt.screenPoint.x,evt.screenPoint.y);},_pan:function(evt){this.map.__pan(evt.screenPoint.x-this._dragOrigin.x,evt.screenPoint.y-this._dragOrigin.y);},_panEnd:function(evt){_d(this._panStartHandle);_d(this._panHandle);_d(this._panEndHandle);this._panStartHandle=this._panHandle=this._panEndHandle=null;var map=this.map;if(map.__panning){map.__panEnd(evt.screenPoint.x-this._dragOrigin.x,evt.screenPoint.y-this._dragOrigin.y);map.resetMapCursor();}},_zoomInit:function(evt){var map=this.map,_1a=this.mouseEvents;if(_7.isLeft(evt)&&map.isRubberBandZoom&&evt.shiftKey){map.setCursor("crosshair");this._dragOrigin=_2.mixin({},evt.screenPoint);this._zoomDir=(evt.ctrlKey||evt.metaKey)?_12:_11;this._zoomHandle=_c(_1a,"onMouseDrag",this,this._zoom);this._zoomEndHandle=_c(_1a,"onMouseUp",this,this._zoomEnd);if(_4("chrome")){evt.preventDefault();}}},_zoom:function(evt){var map=this.map,_1b=this._normalizeRect(evt).offset(map.__visibleRect.x,map.__visibleRect.y),g=map.graphics,_1c=this._zoomRect;if(!_1c.geometry){map.setCursor("crosshair");}if(_1c.geometry){g.remove(_1c,true);}var tl=map.toMap(new _e(_1b.x,_1b.y)),br=map.toMap(new _e(_1b.x+_1b.width,_1b.y+_1b.height));_1b=new _10(tl.x,tl.y,br.x-tl.x,tl.y-br.y,map.spatialReference);_1b._originOnly=true;_1c.setGeometry(_1b);g.add(_1c,true);},_zoomEnd:function(evt){var _1d=this._zoomRect,map=this.map,ext=map.extent,sr=map.spatialReference;_d(this._zoomHandle);_d(this._zoomEndHandle);this._zoomHandle=this._zoomEndHandle=null;if(map._canZoom(this._zoomDir)&&_1d.getDojoShape()){map.graphics.remove(_1d);_1d.geometry=null;var _1e=this._normalizeRect(evt);_1e.x+=map.__visibleRect.x;_1e.y+=map.__visibleRect.y;var _1f;if(this._zoomDir===_12){var _20=ext.getWidth(),_21=(_20*map.width)/_1e.width,_22=(_21-_20)/2;_1f=new _f(ext.xmin-_22,ext.ymin-_22,ext.xmax+_22,ext.ymax+_22,sr);}else{var min=map.toMap({x:_1e.x,y:(_1e.y+_1e.height)}),max=map.toMap({x:(_1e.x+_1e.width),y:_1e.y});_1f=new _f(min.x,min.y,max.x,max.y,sr);}map._extentUtil(null,null,_1f);}if(_1d.getDojoShape()){map.graphics.remove(_1d,true);}this._zoomDir=0;map.resetMapCursor();},_wheelZoom:function(evt,_23){var map=this.map;if(!_23){if(map.smartNavigation&&!evt.shiftKey&&!map._isPanningOrZooming()){map.disableScrollWheelZoom();this._setScrollWheelPan(true);this._wheelPan(evt);return;}var _24=evt.timeStamp;if(!_9._isDefined(_24)||_24<=0){_24=(new Date()).getTime();}var _25=this._mwts?(_24-this._mwts):_24;if(_25<_13){return;}this._mwts=_24;}if(!map._canZoom(evt.value)){return;}map._extentUtil({numLevels:evt.value,mapAnchor:evt.mapPoint,screenAnchor:evt.screenPoint});},_wheelPan:function(evt){var map=this.map;if(evt.shiftKey&&!map._isPanningOrZooming()){this._setScrollWheelPan(false);map.enableScrollWheelZoom();this._wheelZoom(evt);return;}var dx=0,dy=0;if(_4("ff")){if(evt.axis===evt.HORIZONTAL_AXIS){dx=-evt.detail;}else{dy=-evt.detail;}}else{dx=evt.wheelDeltaX;dy=evt.wheelDeltaY;}map.translate(dx,dy);},_setScrollWheelPan:function(_26){var map=this.map;map.isScrollWheelPan=_26;this.mouseEvents.enableMouseWheel(_26);_d(this._mwMacHandle);this._mwMacHandle=null;if(_26){this._mwMacHandle=_c(this.mouseEvents,"onMouseWheel",this,this._wheelPan);}},_recenter:function(evt){if(evt.shiftKey&&!this.map._isPanningOrZooming()){this.map.centerAt(evt.mapPoint);}},_recenterZoom:function(evt){if(evt.shiftKey&&!this.map._isPanningOrZooming()){evt.value=(evt.ctrlKey||evt.metaKey)?_12:_11;this._wheelZoom(evt,true);}},_dblClickZoom:function(evt){if(!this.map._isPanningOrZooming()){evt.value=1;this._wheelZoom(evt,true);}},_twoFingerTap:function(evt){if(!this.map._isPanningOrZooming()){evt.value=-1;this._wheelZoom(evt,true);}},_keyDown:function(evt){var _27=evt.keyCode,map=this.map;if(_3.indexOf(_15,_27)!==-1){if(_27===_8.NUMPAD_PLUS||_27===61){map._extentUtil({numLevels:1});}else{if(_27===_8.NUMPAD_MINUS){map._extentUtil({numLevels:-1});}else{if(!map.__panning){map.__panStart(0,0);}switch(_27){case _8.UP_ARROW:case _8.NUMPAD_8:this._keyDy+=_14;break;case _8.RIGHT_ARROW:case _8.NUMPAD_6:this._keyDx-=_14;break;case _8.DOWN_ARROW:case _8.NUMPAD_2:this._keyDy-=_14;break;case _8.LEFT_ARROW:case _8.NUMPAD_4:this._keyDx+=_14;break;case _8.PAGE_UP:case _8.NUMPAD_9:this._keyDx-=_14;this._keyDy+=_14;break;case _8.PAGE_DOWN:case _8.NUMPAD_3:this._keyDx-=_14;this._keyDy-=_14;break;case _8.END:case _8.NUMPAD_1:this._keyDx+=_14;this._keyDy-=_14;break;case _8.HOME:case _8.NUMPAD_7:this._keyDx+=_14;this._keyDy+=_14;break;default:return;}map.__pan(this._keyDx,this._keyDy);}}_6.stop(evt);}},_keyEnd:function(evt){var map=this.map;if(map.__panning&&(evt.keyCode!==_8.SHIFT)){map.__panEnd(this._keyDx,this._keyDy);this._keyDx=this._keyDy=0;}},_swipeInit:function(evt){var map=this.map,_28=map._zoomAnim||map._panAnim;if(_28&&_28._active){_28.stop();_28._fire("onEnd",[_28.node]);}this._dragOrigin=new _e(0,0);_2.mixin(this._dragOrigin,evt.screenPoint);_d(this._swipeHandle);_d(this._swipeEndHandle);this._swipeHandle=_c(this.touchEvents,"onSwipeMove",this,this._swipe);this._swipeEndHandle=_c(this.touchEvents,"onSwipeEnd",this,this._swipeEnd);},_swipe:function(evt){var map=this.map;if(map.__panning){this._panX=evt.screenPoint.x;this._panY=evt.screenPoint.y;map.__pan(evt.screenPoint.x-this._dragOrigin.x,evt.screenPoint.y-this._dragOrigin.y);}else{map.setCursor("move");map.__panStart(evt.screenPoint.x,evt.screenPoint.y);}},_swipeEnd:function(evt){_d(this._swipeHandle);_d(this._swipeEndHandle);this._swipeHandle=this._swipeEndHandle=null;var map=this.map;if(map.__panning){map.resetMapCursor();map.__panEnd(evt.screenPoint.x-this._dragOrigin.x,evt.screenPoint.y-this._dragOrigin.y);}},_pinchInit:function(evt){var map=this.map,_29=map._zoomAnim||map._panAnim;if(_29&&_29._active){_29.stop();_29._fire("onEnd",[_29.node]);}else{if(map.__panning){evt.screenPoint=new _e(this._panX,this._panY);evt.mapPoint=map.toMap(evt.screenPoint);this._swipeEnd(evt);}}_d(this._pinchHandle);_d(this._pinchEndHandle);this._pinchHandle=_c(this.touchEvents,"onPinchMove",this,this._pinch);this._pinchEndHandle=_c(this.touchEvents,"onPinchEnd",this,this._pinchEnd);},_pinch:function(evt){var map=this.map;if(evt.screenPoints){this.currLength=_9.geometry.getLength(evt.screenPoints[0],evt.screenPoints[1]);if(map.__zooming){var _2a=this.currLength/this._length;this._zoomStartExtent=this.__scaleExtent(map.extent,_2a,this._dragOrigin);map.__zoom(this._zoomStartExtent,_2a,this._dragOrigin);}else{this._dragOrigin=new _e((evt.screenPoints[0].x+evt.screenPoints[1].x)/2,(evt.screenPoints[0].y+evt.screenPoints[1].y)/2);this._length=this.currLength;map.__zoomStart(map.extent,this._dragOrigin);}map._fireOnScale(this.currLength/this._length,this._dragOrigin,true);}},_pinchEnd:function(evt){var map=this.map;_d(this._pinchHandle);_d(this._pinchEndHandle);this._pinchHandle=this._pinchEndHandle=null;if(map.__zooming&&map._zoomAnim===null){var _2b=this.currLength/this._length,_2c=map.extent.getWidth();this._zoomAnimAnchor=map.toMap(this._dragOrigin);this._zoomStartExtent=this.__scaleExtent(map.extent,1/_2b,this._zoomAnimAnchor);if(map.__tileInfo){var ct=_9.TileUtils.getCandidateTileInfo(map,map.__tileInfo,this._zoomStartExtent),_2d=map.__getExtentForLevel(ct.lod.level,this._zoomAnimAnchor),_2e=map.getMinZoom(),_2f=map.getMaxZoom(),_30=_2d.extent,_31=_2d.lod,_32=_2c/_30.getWidth(),_33=ct.lod.level;if(_2b<1){if(_32>_2b){_33--;}}else{if(_32<_2b){_33++;}}if(_33<_2e){_33=_2e;}else{if(_33>_2f){_33=_2f;}}if(_33!==ct.lod.level){_2d=map.__getExtentForLevel(_33,this._zoomAnimAnchor);_30=_2d.extent;_31=_2d.lod;}this._zoomEndExtent=_30;this._zoomEndLod=_31;map._zoomAnim=_9.fx.animateRange({range:{start:(_2c/this._zoomStartExtent.getWidth()),end:_32},duration:_9.config.defaults.map.zoomDuration,rate:_9.config.defaults.map.zoomRate,onAnimate:this._adjustPinch,onEnd:this._adjustPinchEnd});map._zoomAnim.play();map._fireOnScale(map.extent.getWidth()/this._zoomEndExtent.getWidth(),this._dragOrigin);}else{this._zoomEndExtent=this._zoomStartExtent;map._fireOnScale(map.extent.getWidth()/this._zoomEndExtent.getWidth(),this._dragOrigin);this._adjustPinchEnd();}}},_adjustPinch:function(_34){var _35=this.__scaleExtent(this.map.extent,_34,this._zoomAnimAnchor);this.map.__zoom(_35,_34,this._dragOrigin);},_adjustPinchEnd:function(){var map=this.map,_36=map.extent.getWidth()/this._zoomEndExtent.getWidth(),_37=this.__scaleExtent(map.extent,1/_36,this._zoomAnimAnchor),_38=this._dragOrigin,lod=this._zoomEndLod;this._zoomStartExtent=this._zoomEndExtent=this._zoomEndLod=this._dragOrigin=map._zoomAnim=this._zoomAnimAnchor=null;map.__zoomEnd(_37,_36,_38,lod,true);},__scaleExtent:function(_39,_3a,_3b){var _3c=_3b||_39.getCenter(),_3d=_39.expand(_3a),_3e=_39.xmin-((_3d.getWidth()-_39.getWidth())*(_3c.x-_39.xmin)/_39.getWidth()),_3f=_39.ymax-((_3d.getHeight()-_39.getHeight())*(_3c.y-_39.ymax)/_39.getHeight());return new _f(_3e,_3f-_3d.getHeight(),_3e+_3d.getWidth(),_3f,_39.spatialReference);},_normalizeRect:function(evt){var xy=evt.screenPoint,dx=this._dragOrigin.x,dy=this._dragOrigin.y,_40=new _10((xy.x<dx?xy.x:dx)-this.map.__visibleRect.x,(xy.y<dy?xy.y:dy)-this.map.__visibleRect.y,Math.abs(xy.x-dx),Math.abs(xy.y-dy));delete _40.spatialReference;if(_40.width===0){_40.width=1;}if(_40.height===0){_40.height=1;}return _40;},setImmediateClick:function(_41){switch(this.eventModel){case "mouse":this.mouseEvents.setImmediateClick(_41);break;case "touch":this.touchEvents.setImmediateTap(_41);break;}},enablePan:function(){this.disablePan();switch(this.eventModel){case "mouse":this._panInitHandle=_c(this.mouseEvents,"onMouseDown",this,this._panInit);break;case "touch":this._swipeInitHandle=_c(this.touchEvents,"onSwipeStart",this,this._swipeInit);break;}},disablePan:function(){_d(this._panInitHandle);this._panInitHandle=null;_d(this._swipeInitHandle);this._swipeInitHandle=null;},enableRubberBandZoom:function(){this.disableRubberBandZoom();if(this.eventModel==="mouse"){this._zoomInitHandle=_c(this.mouseEvents,"onMouseDown",this,this._zoomInit);}},disableRubberBandZoom:function(){_d(this._zoomInitHandle);this._zoomInitHandle=null;},enablePinchZoom:function(){this.disablePinchZoom();if(this.eventModel==="touch"){this._pinchInitHandle=_c(this.touchEvents,"onPinchStart",this,this._pinchInit);}},disablePinchZoom:function(){_d(this._pinchInitHandle);this._pinchInitHandle=null;},enableScrollWheelZoom:function(){this.disableScrollWheelZoom();if(this.eventModel==="mouse"){this._wheelHandle=_c(this.mouseEvents,"onMouseWheel",this,this._wheelZoom);}},disableScrollWheelZoom:function(){_d(this._wheelHandle);this._wheelHandle=null;},enableDoubleClickZoom:function(){this.disableDoubleClickZoom();switch(this.eventModel){case "mouse":this._dblClickHandle=_c(this.mouseEvents,"onDblClick",this,this._dblClickZoom);break;case "touch":this._dblClickHandle=_c(this.touchEvents,"onDoubleTap",this,this._dblClickZoom);this._zoomOutHandle=_c(this.touchEvents,"onTwoFingerTap",this,this._twoFingerTap);break;}},disableDoubleClickZoom:function(){_d(this._dblClickHandle);_d(this._zoomOutHandle);this._dblClickHandle=this._zoomOutHandle=null;},enableShiftDoubleClickZoom:function(){this.disableShiftDoubleClickZoom();if(this.eventModel==="mouse"){this._sDblClickHandle=_c(this.mouseEvents,"onDblClick",this,this._recenterZoom);}},disableShiftDoubleClickZoom:function(){_d(this._sDblClickHandle);this._sDblClickHandle=null;},enableClickRecenter:function(){this.disableClickRecenter();if(this.eventModel==="mouse"){this._recenterHandle=_c(this.mouseEvents,"onClick",this,this._recenter);}},disableClickRecenter:function(){_d(this._recenterHandle);this._recenterHandle=null;},enableKeyboardNavigation:function(){this.disableKeyboardNavigation();if(this.eventModel==="mouse"){this._keyHandle=_c(this.mouseEvents,"onKeyDown",this,this._keyDown);this._keyEndHandle=_c(this.mouseEvents,"onKeyUp",this,this._keyEnd);}},disableKeyboardNavigation:function(){_d(this._keyHandle);_d(this._keyEndHandle);this._keyHandle=this._keyEndHandle=null;},enableNavigation:function(){var map=this.map;if(map&&map.loaded){map.enableDoubleClickZoom();map.enableClickRecenter();map.enablePan();map.enableRubberBandZoom();this.enablePinchZoom();map.enableKeyboardNavigation();if(map.smartNavigation){this._setScrollWheelPan(true);}else{map.enableScrollWheelZoom();}}},disableNavigation:function(){var map=this.map;if(map&&map.loaded){map.disableDoubleClickZoom();map.disableClickRecenter();map.disablePan();map.disableRubberBandZoom();this.disablePinchZoom();map.disableKeyboardNavigation();map.disableScrollWheelZoom();if(map.smartNavigation){this._setScrollWheelPan(false);}}},destroy:function(){if(this.touchEvents){this.touchEvents.destroy();}if(this.mouseEvents){this.mouseEvents.destroy();}var i,_42=[this._panInitHandle,this._panStartHandle,this._panHandle,this._panEndHandle,this._zoomInitHandle,this._zoomHandle,this._zoomEndHandle,this._wheelHandle,this._mwMacHandle,this._dblClickHandle,this._zoomOutHandle,this._recenterHandle,this._sDblClickHandle,this._keyHandle,this._keyEndHandle,this._swipeInitHandle,this._swipeHandle,this._swipeEndHandle,this._pinchInitHandle,this._pinchHandle,this._pinchEndHandle];for(i=0;i<_42.length;i++){_d(_42[i]);}this.map=this.touchEvents=this.mouseEvents=this.eventModel=this._zoomRect=this._dragOrigin=this._panInitHandle=this._panStartHandle=this._panHandle=this._panEndHandle=this._zoomInitHandle=this._zoomHandle=this._zoomEndHandle=this._wheelHandle=this._mwMacHandle=this._dblClickHandle=this._zoomOutHandle=this._recenterHandle=this._sDblClickHandle=this._keyHandle=this._keyEndHandle=this._swipeInitHandle=this._swipeHandle=this._swipeEndHandle=this._pinchInitHandle=this._pinchHandle=this._pinchEndHandle=null;}});if(_4("extend-esri")){_9.MapNavigationManager=_16;}return _16;});