/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/layers/MapImageLayer",["dijit","dojo","dojox","dojo/require!esri/utils,esri/layers/layer,esri/geometry"],function(_1,_2,_3){_2.provide("esri.layers.MapImageLayer");_2.require("esri.utils");_2.require("esri.layers.layer");_2.require("esri.geometry");_2.declare("esri.layers.MapImageLayer",[esri.layers.Layer],{"-chains-":{constructor:"manual"},constructor:function(_4){this.inherited(arguments,[null,_4]);this._mapImages=[];var _5=_2.hitch;this._panStart=_5(this,this._panStart);this._pan=_5(this,this._pan);this._extentChange=_5(this,this._extentChange);this._zoom=_5(this,this._zoom);this._zoomStart=_5(this,this._zoomStart);this._scale=_5(this,this._scale);this._resize=_5(this,this._resize);this.loaded=true;this.onLoad(this);},opacity:1,_transform:esri._getDOMAccessor("transform"),addImage:function(_6){var _7=this._mapImages.push(_6);_7=_7-1;_6._idx=_7;_6._layer=this;if(this._div){this._createImage(_6,_7);}},removeImage:function(_8){if(_8){var _9=_8._idx,_a=this._mapImages;if(_a[_9]===_8){delete _a[_9];var _b=_8._node;if(_b){this._clearEvents(_b);_b.e_idx=_b.e_bl=_b.e_tr=_b.e_l=_b.e_t=_b.e_w=_b.e_h=null;if(_b.parentNode){_b.parentNode.removeChild(_b);_2.destroy(_b);}}_8._node=_8._idx=_8._layer=null;}}},removeAllImages:function(){var _c=this._mapImages,i,_d=_c.length;for(i=0;i<_d;i++){var _e=_c[i];if(_e){this.removeImage(_e);}}this._mapImages=[];},getImages:function(){var _f=this._mapImages,_10=[],i,len=_f.length;for(i=0;i<len;i++){if(_f[i]){_10.push(_f[i]);}}return _10;},setOpacity:function(_11){if(this.opacity!=_11){this.onOpacityChange(this.opacity=_11);}},onOpacityChange:function(_12){var div=this._div,i,len,_13;if(div){if(!_2.isIE||_2.isIE>8){_2.style(div,"opacity",_12);}else{_13=div.childNodes;len=_13.length;for(i=0;i<len;i++){_2.style(_13[i],"opacity",_12);}}}},_createImage:function(_14,idx){var _15=_2.create("img");_2.style(_15,{position:"absolute"});if(_2.isIE<=8){_2.style(_15,"opacity",this.opacity);}if(_14.rotation){var _16="rotate("+(360-_14.rotation)+"deg)";if(_2.isIE<9){}else{_2.style(_15,this._transform,_16);_2.style(_15,"transform",_16);}}_14._node=_15;_15.e_idx=idx;_15.e_layer=this;_15.e_load=_2.connect(_15,"onload",esri.layers.MapImageLayer.prototype._imageLoaded);_15.e_error=_2.connect(_15,"onerror",esri.layers.MapImageLayer.prototype._imageError);_15.e_abort=_2.connect(_15,"onabort",esri.layers.MapImageLayer.prototype._imageError);_15.src=_14.href;},_imageLoaded:function(evt,img){var _17=img||evt.target||evt.currentTarget,_18=_17.e_layer,_19=_18._mapImages[_17.e_idx];if(_18._map&&(_18._map.__zooming||_18._map.__panning)){_18._standby.push(_17);return;}_18._clearEvents(_17);if(!_19||_19._node!==_17){return;}if(_18._map){_18._attach(_19);}},_imageError:function(evt){var _1a=evt.target||evt.currentTarget,_1b=_1a.e_layer,_1c=_1b._mapImages[_1a.e_idx];_1b._clearEvents(_1a);if(_1c){_1c._node=null;}},_clearEvents:function(_1d){var _1e=_2.disconnect;_1e(_1d.e_load);_1e(_1d.e_error);_1e(_1d.e_abort);_1d.e_load=_1d.e_error=_1d.e_abort=_1d.e_layer=null;},_attach:function(_1f){var _20=_1f.extent,_21=_20.spatialReference,_22=this._sr,div=this._div,_23=_1f._node,_24=new esri.geometry.Point({x:_20.xmin,y:_20.ymin,spatialReference:_21}),_25=new esri.geometry.Point({x:_20.xmax,y:_20.ymax,spatialReference:_21});if(!_22.equals(_21)){if(_22.isWebMercator()&&_21.wkid===4326){_24=esri.geometry.geographicToWebMercator(_24);_25=esri.geometry.geographicToWebMercator(_25);}else{if(_21.isWebMercator()&&_22.wkid===4326){_24=esri.geometry.webMercatorToGeographic(_24);_25=esri.geometry.webMercatorToGeographic(_25);}}}_23.e_bl=_24;_23.e_tr=_25;if(_1f.visible){this._setPos(_23,div._left,div._top);(this._active||div).appendChild(_23);}},_setPos:function(_26,_27,_28){var _29=_26.e_bl,_2a=_26.e_tr,map=this._map;_29=map.toScreen(_29);_2a=map.toScreen(_2a);var _2b=_29.x-_27,top=_2a.y-_28,_2c=Math.abs(_2a.x-_29.x),_2d=Math.abs(_29.y-_2a.y),css={width:_2c+"px",height:_2d+"px"},_2e=this._mapImages[_26.e_idx];if(map.navigationMode==="css-transforms"){css[esri._css.names.transform]=esri._css.translate(_2b,top)+(_2e.rotation?(" "+esri._css.rotate(360-_2e.rotation)):"");}else{css.left=_2b+"px";css.top=top+"px";}_2.style(_26,css);_26.e_l=_2b;_26.e_t=top;_26.e_w=_2c;_26.e_h=_2d;},_setMap:function(map,_2f){this._map=map;this._sr=map.spatialReference;var div=this._div=_2.create("div",null,_2f),_30=esri._css.names,css={position:"absolute"},vd=map.__visibleDelta;if(!_2.isIE||_2.isIE>8){css.opacity=this.opacity;}if(map.navigationMode==="css-transforms"){css[_30.transform]=esri._css.translate(vd.x,vd.y);_2.style(div,css);div._left=vd.x;div._top=vd.y;css={position:"absolute",width:map.width+"px",height:map.height+"px",overflow:"visible"};this._active=_2.create("div",null,div);_2.style(this._active,css);this._passive=_2.create("div",null,div);_2.style(this._passive,css);}else{div._left=0;div._top=0;_2.style(div,css);}this._standby=[];var _31=this._mapImages,i,len=_31.length;for(i=0;i<len;i++){var _32=_31[i],_33=_32._node;if(!_33){this._createImage(_32,_32._idx);}}this.onVisibilityChange(this.visible);return div;},_unsetMap:function(map,_34){this._disconnect();var div=this._div;if(div){var _35=this._mapImages,i,len=_35.length;for(i=0;i<len;i++){var _36=_35[i];if(_36){var _37=_36._node;if(_37){this._clearEvents(_37);_37.e_idx=_37.e_bl=_37.e_tr=_37.e_l=_37.e_t=_37.e_w=_37.e_h=null;}_36._node=null;}}_34.removeChild(div);_2.destroy(div);}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;},onVisibilityChange:function(_38){var div=this._div;if(div){if(_38){this._redraw();this._connect(this._map);esri.show(div);}else{this._disconnect();esri.hide(div);}}},_connect:function(map){if(!this._connections){var _39=_2.connect,_3a=(map.navigationMode==="css-transforms");this._connections=[_39(map,"onPanStart",this._panStart),_39(map,"onPan",this._pan),_39(map,"onExtentChange",this._extentChange),_3a&&_39(map,"onZoomStart",this._zoomStart),_3a?_39(map,"onScale",this._scale):_39(map,"onZoom",this._zoom),_3a&&_39(map,"onResize",this._resize)];}},_disconnect:function(){if(this._connections){_2.forEach(this._connections,_2.disconnect);this._connections=null;}},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top;},_pan:function(_3b,_3c){var div=this._div;div._left=this._panL+_3c.x;div._top=this._panT+_3c.y;if(this._map.navigationMode==="css-transforms"){_2.style(div,esri._css.names.transform,esri._css.translate(div._left,div._top));}else{_2.style(div,{left:div._left+"px",top:div._top+"px"});}},_extentChange:function(_3d,_3e,_3f){if(_3f){this._redraw(this._map.navigationMode==="css-transforms");}else{if(_3e){this._pan(_3d,_3e);}}var i,_40=this._standby;if(_40&&_40.length){for(i=_40.length-1;i>=0;i--){this._imageLoaded(null,_40[i]);_40.splice(i,1);}}},_redraw:function(_41){if(_41){var _42=this._passive,_43=esri._css.names;_2.style(_42,_43.transition,"none");this._moveImages(_42,this._active);_2.style(_42,_43.transform,"none");}var div=this._active||this._div,_44=this._div._left,_45=this._div._top,i,len=div.childNodes.length,_46;for(i=0;i<len;i++){_46=div.childNodes[i];this._setPos(_46,_44,_45);}},_zoom:function(_47,_48,_49){var div=this._div,_4a=div._left,_4b=div._top,i,len=div.childNodes.length,_4c;for(i=0;i<len;i++){_4c=div.childNodes[i];var _4d=_4c.e_w*_48,_4e=_4c.e_h*_48,_4f=(_49.x-_4a-_4c.e_l)*(_4d-_4c.e_w)/_4c.e_w,_50=(_49.y-_4b-_4c.e_t)*(_4e-_4c.e_h)/_4c.e_h;_4f=isNaN(_4f)?0:_4f;_50=isNaN(_50)?0:_50;_2.style(_4c,{left:(_4c.e_l-_4f)+"px",top:(_4c.e_t-_50)+"px",width:_4d+"px",height:_4e+"px"});}},_zoomStart:function(){this._moveImages(this._active,this._passive);},_moveImages:function(_51,_52){var _53=_51.childNodes,i,len=_53.length;if(len>0){for(i=len-1;i>=0;i--){_52.appendChild(_53[i]);}}},_scale:function(mtx,_54){var css={},_55=esri._css.names,_56=this._passive;_2.style(_56,_55.transition,_54?"none":(_55.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease"));css[_55.transform]=esri._css.matrix(mtx);_2.style(_56,_55.transform,esri._css.matrix(mtx));},_resize:function(_57,_58,_59){_2.style(this._active,{width:_58+"px",height:_59+"px"});_2.style(this._passive,{width:_58+"px",height:_59+"px"});}});_2.extend(esri.layers.MapImage,{visible:true,getLayer:function(){return this._layer;},getNode:function(){return this._node;},show:function(){if(!this.visible){this.visible=true;var _5a=this._node,_5b=this._layer,div;if(_5a){div=_5b&&_5b._div;if(div){_5b._setPos(_5a,div._left,div._top);(_5b._active||div).appendChild(_5a);}esri.show(_5a);}}},hide:function(){if(this.visible){this.visible=false;var _5c=this._node;if(_5c){esri.hide(_5c);if(_5c.parentNode){_5c.parentNode.removeChild(_5c);}}}}});});