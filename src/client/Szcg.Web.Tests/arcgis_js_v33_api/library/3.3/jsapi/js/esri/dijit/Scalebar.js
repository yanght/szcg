/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/Scalebar",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/has","dojo/query","esri","esri/utils","esri/geometry","esri/WKIDUnitConversion"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c=_1("esri.dijit.Scalebar",null,{map:null,mapUnit:null,scalebarUnit:null,unitsDictionary:[],domNode:null,screenPt1:null,screenPt2:null,constructor:function(_d,_e){this.domNode=_6.create("div",{innerHTML:"<div class='esriScalebarRuler'><div class='esriScalebarRulerBlock upper_firstpiece'></div><div class='esriScalebarRulerBlock upper_secondpiece'></div><div class='esriScalebarRulerBlock lower_firstpiece'></div><div class='esriScalebarRulerBlock lower_secondpiece'></div></div><div class='scaleLabelDiv'><div class='esriScalebarLabel' style='left: -3%'>0</div><div class='esriScalebarLabel esriScalebarFirstNumber'></div><div class='esriScalebarLabel esriScalebarSecondNumber'></div></div>"});_d=_d||{};if(!_d.map){console.error("scalebar: unable to find the 'map' property in parameters");return;}if(!_d.scalebarUnit){this.scalebarUnit="mi";}else{if(_d.scalebarUnit!=="english"&&_d.scalebarUnit!=="metric"){console.error("scalebar unit only accepts english or metric");return;}else{this.scalebarUnit=(_d.scalebarUnit==="english")?"mi":"km";}}this.map=_d.map;if(_e){_e.appendChild(this.domNode);}else{this.map.container.appendChild(this.domNode);if(_d.attachTo){_5.add(this.domNode,"scalebar_"+_d.attachTo);}else{_5.add(this.domNode,"scalebar_bottom-left");}}_5.add(this.domNode,"esriScalebar");if(this.map.loaded){this._getDistance(this.map.extent);this._checkBingMaps();}else{var _f=_4.connect(this.map,"onLoad",this,function(){dojo.disconnect(_f);_f=null;this._getDistance(this.map.extent);this._checkBingMaps();});}this._mapOnPan=_4.connect(this.map,"onPan",this,this._getDistance);this._mapOnExtentChange=_4.connect(this.map,"onExtentChange",this,this._getDistance);_3.forEach(this.map.layerIds,function(_10,idx){if(this.map.getLayer(_10).declaredClass==="esri.virtualearth.VETiledLayer"){_4.connect(this.map.getLayer(_10),"onVisibilityChange",_2.hitch(this,function(_11){this._checkBingMaps();}));}},this);this._mapOnLayerAdd=_4.connect(this.map,"onLayerAdd",_2.hitch(this,function(_12){if(_12.declaredClass==="esri.virtualearth.VETiledLayer"){_4.connect(_12,"onVisibilityChange",_2.hitch(this,function(_13){this._checkBingMaps();}));}this._checkBingMaps();}));this._mapOnLayerRemove=_4.connect(this.map,"onLayerRemove",_2.hitch(this,this._checkBingMaps));},hide:function(){this._hidden=true;_b.hide(this.domNode);},show:function(){this._hidden=false;_b.show(this.domNode);},destroy:function(){_4.disconnect(this._mapOnPan);_4.disconnect(this._mapOnExtentChange);_4.disconnect(this._mapOnLayerAdd);_4.disconnect(this._mapOnLayerRemove);this.hide();this.map=null;_6.destroy(this.domNode);},_checkBingMaps:function(){if(_5.contains(this.domNode,"scalebar_bottom-left")){_8.set(this.domNode,"left","25px");_3.forEach(this.map.layerIds,function(_14,idx){if(this.map.getLayer(_14).declaredClass==="esri.virtualearth.VETiledLayer"&&this.map.getLayer(_14).visible){var _15="95px";if(this.map._mapParams.nav){_15="115px";}_8.set(this.domNode,"left",_15);}},this);}},_getDistance:function(_16){var _17=_7.position(this.domNode,true);var _18=_17.y-this.map.position.y;_18=(_18>this.map.height)?this.map.height:_18;_18=(_18<0)?0:_18;var _19=new _b.geometry.ScreenPoint(0,_18);var _1a=new _b.geometry.ScreenPoint(this.map.width,_18);var _1b,_1c;this.mapUnit="esriDecimalDegrees";var pt1=_b.geometry.toMapPoint(_16,this.map.width,this.map.height,_19);var pt2=_b.geometry.toMapPoint(_16,this.map.width,this.map.height,_1a);var _1d=new _b.geometry.Point(_16.xmin,(_16.ymin+_16.ymax)/2,this.map.spatialReference);var _1e=new _b.geometry.Point(_16.xmax,(_16.ymin+_16.ymax)/2,this.map.spatialReference);if(this.map.spatialReference.wkid===3857||this.map.spatialReference.wkid===102100||this.map.spatialReference.wkid===102113||(this.map.spatialReference.wkt&&this.map.spatialReference.wkt.indexOf("WGS_1984_Web_Mercator")!=-1)){pt1=_b.geometry.webMercatorToGeographic(pt1,true);pt2=_b.geometry.webMercatorToGeographic(pt2,true);_1d=_b.geometry.webMercatorToGeographic(_1d,true);_1e=_b.geometry.webMercatorToGeographic(_1e,true);}else{if(_b.isDefined(_b.WKIDUnitConversion[this.map.spatialReference.wkid])||(this.map.spatialReference.wkt&&this.map.spatialReference.wkt.indexOf("PROJCS")===0)){this.mapUnit="linearUnit";_1b=Math.abs(_16.xmax-_16.xmin);var _1f;if(_b.isDefined(_b.WKIDUnitConversion[this.map.spatialReference.wkid])){_1f=_b.WKIDUnitConversion.values[_b.WKIDUnitConversion[this.map.spatialReference.wkid]];}else{var wkt=this.map.spatialReference.wkt;var _20=wkt.lastIndexOf(",")+1;var end=wkt.lastIndexOf("]]");_1f=parseFloat(wkt.substring(_20,end));}_1b*=_1f;if(this.scalebarUnit==="mi"){_1b/=1609;}else{_1b/=1000;}}}if(this.mapUnit==="esriDecimalDegrees"){var _21=new _b.geometry.Polyline(new _b.SpatialReference({wkid:4326}));_21.addPath([pt1,pt2]);var _22=_b.geometry._straightLineDensify(_21,10);_1b=_b.geometry.geodesicLengths([_22],_b.Units.KILOMETERS)[0];var _23=new _b.geometry.Polyline(new _b.SpatialReference({wkid:4326}));_23.addPath([_1d,_1e]);var _24=_b.geometry._straightLineDensify(_23,10);_1c=_b.geometry.geodesicLengths([_24],_b.Units.KILOMETERS)[0];if(this.scalebarUnit==="mi"){_1b/=1.609;_1c/=1.609;}}this._getScaleBarLength(_1b);if(_1c){if(_1b/_1c>0.1){if(!this._hidden){_b.show(this.domNode);}}else{_b.hide(this.domNode);}}},_getScaleBarLength:function(_25){var _26=50;var _27=_26*_25/this.map.width;var _28=_27;var i=0;var _29=this.scalebarUnit;if(_28<0.1){if(this.scalebarUnit==="mi"){_28*=5280;_29="ft";}else{if(this.scalebarUnit==="km"){_28*=1000;_29="m";}}}while(_28>=1){_28/=10;i++;}var _2a,_2b;if(_28>0.5){_2a=1;_2b=0.5;}else{if(_28>0.3){_2a=0.5;_2b=0.3;}else{if(_28>0.2){_2a=0.3;_2b=0.2;}else{if(_28>0.15){_2a=0.2;_2b=0.15;}else{if(_28>0.1){_2a=0.15;_2b=0.1;}}}}}var _2c=((_2a/_28)>=(_28/_2b))?_2b:_2a;var _2d=_2c/_28;var _2e=_26*_2d;var _2f=Math.pow(10,i)*_2c;this._drawScaleBar(_2e,_2f,_29);},_drawScaleBar:function(_30,_31,_32){var _33=2*Math.round(_30)+"px";this.domNode.style.width=_33;_3.forEach(_a(".esriScalebarFirstNumber",this.domNode),function(_34,idx){_34.innerHTML=_31;},this);_3.forEach(_a(".esriScalebarSecondNumber",this.domNode),function(_35,idx){if(this.mapUnit!=="esriUnknown"){_35.innerHTML=2*_31+_32;}else{_35.innerHTML=2*_31+"Unknown Unit";}},this);}});if(_9("extend-esri")){_2.setObject("dijit.Scalebar",_c,_b);}return _c;});