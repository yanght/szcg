/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/PopupBase",["dijit","dojo","dojox"],function(_1,_2,_3){_2.provide("esri.PopupBase");_2.declare("esri.PopupBase",null,{onSetFeatures:function(){},onClearFeatures:function(){},onSelectionChange:function(){},onDfdComplete:function(){var _4=this._marked;if(_4){this._marked=null;this.showClosestFirst(_4);}},initialize:function(){this.count=0;this.selectedIndex=-1;},cleanup:function(){this.features=this.deferreds=null;},setFeatures:function(_5){if(!_5||!_5.length){return;}this.clearFeatures();var _6,_7;if(_5[0] instanceof _2.Deferred){_7=_5;}else{_6=_5;}if(_6){this._updateFeatures(null,_6);}else{this.deferreds=_7;_7=_7.slice(0);_2.forEach(_7,function(_8){_8.addBoth(_2.hitch(this,this._updateFeatures,_8));},this);}},clearFeatures:function(){this.features=this.deferreds=this._marked=null;this.count=0;var _9=this.selectedIndex;this.selectedIndex=-1;if(_9>-1){this.onSelectionChange();}this.onClearFeatures();},getSelectedFeature:function(){var _a=this.features;if(_a){return _a[this.selectedIndex];}},select:function(_b){if(_b<0||_b>=this.count){return;}this.selectedIndex=_b;this.onSelectionChange();},enableHighlight:function(_c){this._highlighted=_c.graphics.add(new esri.Graphic(new esri.geometry.Point(0,0,_c.spatialReference)));this._highlighted.hide();var _d=esri.symbol;if(!this.markerSymbol){var _e=(this.markerSymbol=new _d.SimpleMarkerSymbol());_e.setStyle(_d.SimpleMarkerSymbol.STYLE_TARGET);_e._setDim(16,16,7);_e.setOutline(new _d.CartographicLineSymbol(_d.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,255,255]),2,_d.CartographicLineSymbol.CAP_ROUND,_d.CartographicLineSymbol.JOIN_ROUND));_e.setColor(new _2.Color([0,0,0,0]));}if(!this.lineSymbol){this.lineSymbol=new _d.SimpleLineSymbol(_d.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,255,255]),2);}if(!this.fillSymbol){this.fillSymbol=new _d.SimpleFillSymbol(_d.SimpleFillSymbol.STYLE_NULL,new _d.SimpleLineSymbol(_d.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,255,255]),2),new _2.Color([0,0,0,0]));}},disableHighlight:function(_f){var _10=this._highlighted;if(_10){_10.hide();_f.graphics.remove(_10);delete this._highlighted;}this.markerSymbol=this.lineSymbol=this.fillSymbol=null;},showHighlight:function(){var _11=this.features&&this.features[this.selectedIndex];if(this._highlighted&&_11&&_11.geometry){this._highlighted.show();}},hideHighlight:function(){if(this._highlighted){this._highlighted.hide();}},updateHighlight:function(map,_12){var _13=_12.geometry,_14=this._highlighted;if(!_13||!_14){if(_14){_14.hide();}return;}_14.hide();if(!_14.getLayer()&&map){map.graphics.add(_14);}_14.setGeometry(esri.geometry.fromJson(_13.toJson()));var _15;switch(_13.type){case "point":case "multipoint":_15=this.markerSymbol;_15.setOffset(0,0);_15.setAngle(0);var lyr=_12.getLayer();if(lyr){var _16=lyr._getSymbol(_12),_17,_18,_19=0,_1a=0,_1b=0;if(_16){switch(_16.type){case "simplemarkersymbol":_17=_18=(_16.size||0);break;case "picturemarkersymbol":_17=(_16.width||0);_18=(_16.height||0);break;}_19=_16.xoffset||0;_1a=_16.yoffset||0;_1b=_16.angle||0;}if(_17&&_18){_15._setDim(_17+1,_18+1,7);}_15.setOffset(_19,_1a);_15.setAngle(_1b);}break;case "polyline":_15=this.lineSymbol;break;case "polygon":_15=this.fillSymbol;break;}_14.setSymbol(_15);},showClosestFirst:function(_1c){var _1d=this.features;if(_1d&&_1d.length){if(_1d.length>1){var i,_1e=Infinity,_1f=-1,_20,_21=esri.geometry.getLength,_22,_23=_1c.spatialReference,_24,_25;_1c=_1c.normalize();for(i=_1d.length-1;i>=0;i--){_20=_1d[i].geometry;if(!_20){continue;}_24=_20.spatialReference;_22=0;try{_25=(_20.type==="point")?_20:_20.getExtent().getCenter();_25=_25.normalize();if(_23&&_24&&!_23.equals(_24)&&_23._canProject(_24)){_25=_23.isWebMercator()?esri.geometry.geographicToWebMercator(_25):esri.geometry.webMercatorToGeographic(_25);}_22=_21(_1c,_25);}catch(e){}if(_22>0&&_22<_1e){_1e=_22;_1f=i;}}if(_1f>0){_1d.splice(0,0,_1d.splice(_1f,1)[0]);this.select(0);}}}else{if(this.deferreds){this._marked=_1c;}}},_unbind:function(dfd){var _26=_2.indexOf(this.deferreds,dfd);if(_26===-1){return;}this.deferreds.splice(_26,1);if(!this.deferreds.length){this.deferreds=null;return 2;}return 1;},_updateFeatures:function(dfd,_27){if(dfd){if(this.deferreds){var res=this._unbind(dfd);if(!res){return;}if(_27&&_27 instanceof Error){this.onDfdComplete(_27);if(res===2){this.onSetFeatures();}return;}if(_27&&_27.length){if(!this.features){this.features=_27;this.count=_27.length;this.selectedIndex=0;this.onDfdComplete();if(res===2){this.onSetFeatures();}this.select(0);}else{var _28=_2.filter(_27,function(_29){return _2.indexOf(this.features,_29)===-1;},this);this.features=this.features.concat(_28);this.count=this.features.length;this.onDfdComplete();if(res===2){this.onSetFeatures();}}}else{this.onDfdComplete();if(res===2){this.onSetFeatures();}}}}else{this.features=_27;this.count=_27.length;this.selectedIndex=0;this.onSetFeatures();this.select(0);}}});_2.declare("esri.PopupInfoTemplate",[esri.InfoTemplate],{"-chains-":{constructor:"manual"},initialize:function(_2a){if(!_2a){return;}this.info=_2a;this.title=this.getTitle;this.content=this.getContent;var _2b=(this._fieldLabels={}),_2c=(this._fieldsMap={});if(_2a.fieldInfos){_2.forEach(_2a.fieldInfos,function(_2d){_2b[_2d.fieldName]=_2d.label;_2c[_2d.fieldName]=_2d;});}},toJson:function(){return _2.fromJson(_2.toJson(this.info));},getTitle:function(){},getContent:function(){},getComponents:function(_2e){var _2f=this.info,_30=_2e.getLayer(),_31=_2.clone(_2e.attributes)||{},_32=_2.clone(_31),_33=_2f.fieldInfos,_34="",_35="",_36,_37,_38,_39=_30&&_30._getDateOpts&&_30._getDateOpts().properties,_3a={dateFormat:{properties:_39,formatter:"DateFormat"+this._dateFormats["shortDateShortTime"]}};if(_33){_2.forEach(_33,function(_3b){var _3c=_3b.fieldName,val=_32[_3c];_32[_3c]=this._formatValue(val,_3c,_3a);if(_39&&_3b.format&&_3b.format.dateFormat){var pos=_2.indexOf(_39,_3c);if(pos>-1){_39.splice(pos,1);}}},this);}if(_30){var _3d=_30.types,_3e=_30.typeIdField,_3f=_3e&&_31[_3e];for(_37 in _31){_38=_31[_37];if(esri._isDefined(_38)){var _40=this._getDomainName(_30,_3d,_3f,_37,_38);if(esri._isDefined(_40)){_32[_37]=_40;}else{if(_37===_3e){var _41=this._getTypeName(_30,_38);if(esri._isDefined(_41)){_32[_37]=_41;}}}}}}if(_2f.title){_34=_2.trim(esri.substitute(_32,this._fixTokens(_2f.title),_3a)||"");}if(_2f.description){_35=_2.trim(esri.substitute(_32,this._fixTokens(_2f.description),_3a)||"");}if(_33){_36=[];_2.forEach(_33,function(_42){_37=_42.fieldName;if(_37&&_42.visible){_36.push([_42.label||_37,esri.substitute(_32,"${"+_37+"}",_3a)||""]);}});}var _43,_44;if(_2f.mediaInfos){_43=[];_2.forEach(_2f.mediaInfos,function(_45){_44=0;_38=_45.value;switch(_45.type){case "image":var url=_38.sourceURL;url=url&&_2.trim(esri.substitute(_31,this._fixTokens(url)));_44=!!url;break;case "piechart":case "linechart":case "columnchart":case "barchart":_44=_2.some(_38.fields,function(_46){return esri._isDefined(_31[_46]);});break;default:return;}if(_44){_45=_2.clone(_45);_38=_45.value;_45.title=_45.title?_2.trim(esri.substitute(_32,this._fixTokens(_45.title),_3a)||""):"";_45.caption=_45.caption?_2.trim(esri.substitute(_32,this._fixTokens(_45.caption),_3a)||""):"";if(_45.type==="image"){_38.sourceURL=esri.substitute(_31,this._fixTokens(_38.sourceURL));if(_38.linkURL){_38.linkURL=_2.trim(esri.substitute(_31,this._fixTokens(_38.linkURL))||"");}}else{var _47=_31[_38.normalizeField]||0;_38.fields=_2.map(_38.fields,function(_48){var _49=_31[_48];_49=(_49===undefined)?null:_49;if(_49&&_47){_49=_49/_47;}return {y:_49,tooltip:(this._fieldLabels[_48]||_48)+":<br/>"+this._formatValue(_49,_48,_3a,!!_47)};},this);}_43.push(_45);}},this);}return {title:_34,description:_35,fields:(_36&&_36.length)?_36:null,mediaInfos:(_43&&_43.length)?_43:null,formatted:_32,editSummary:(_30&&_30.getEditSummary)?_30.getEditSummary(_2e):""};},getAttachments:function(_4a){var _4b=_4a.getLayer(),_4c=_4a.attributes;if(this.info.showAttachments&&_4b&&_4b.hasAttachments&&_4b.objectIdField){var oid=_4c&&_4c[_4b.objectIdField];if(oid){return _4b.queryAttachmentInfos(oid);}}},_dateFormats:{"shortDate":"(datePattern: 'M/d/y', selector: 'date')","longMonthDayYear":"(datePattern: 'MMMM d, y', selector: 'date')","dayShortMonthYear":"(datePattern: 'd MMM y', selector: 'date')","longDate":"(datePattern: 'EEEE, MMMM d, y', selector: 'date')","shortDateShortTime":"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')","shortDateShortTime24":"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')","shortDateLongTime":"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')","shortDateLongTime24":"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')","longMonthYear":"(datePattern: 'MMMM y', selector: 'date')","shortMonthYear":"(datePattern: 'MMM y', selector: 'date')","year":"(datePattern: 'y', selector: 'date')"},_fixTokens:function(_4d){return _4d.replace(/(\{[^\{\r\n]+\})/g,"$$$1");},_formatValue:function(val,_4e,_4f,_50){var _51=this._fieldsMap[_4e],fmt=_51&&_51.format;if(!esri._isDefined(val)||!_51||!esri._isDefined(fmt)){return val;}var _52="",_53=[],_54=fmt.hasOwnProperty("places")||fmt.hasOwnProperty("digitSeparator"),_55=fmt.hasOwnProperty("digitSeparator")?fmt.digitSeparator:true;if(_54){_52="NumberFormat";_53.push("places: "+((esri._isDefined(fmt.places)&&(!_50||fmt.places>0))?Number(fmt.places):"Infinity"));if(_53.length){_52+=("("+_53.join(",")+")");}}else{if(fmt.dateFormat){_52="DateFormat"+(this._dateFormats[fmt.dateFormat]||this._dateFormats["shortDateShortTime"]);}else{return val;}}var _56=esri.substitute({"myKey":val},"${myKey:"+_52+"}",_4f)||"";if(_54&&!_55){var _57=_2.i18n.getLocalization("dojo.cldr","number");if(_57.group){_56=_56.replace(new RegExp("\\"+_57.group,"g"),"");}}return _56;},_getDomainName:function(_58,_59,_5a,_5b,_5c){var _5d,_5e;if(_59&&esri._isDefined(_5a)){_2.some(_59,function(_5f){if(_5f.id==_5a){_5d=_5f.domains&&_5f.domains[_5b];if(_5d&&_5d.type==="inherited"){_5d=this._getLayerDomain(_58,_5b);_5e=true;}return true;}return false;},this);}if(!_5e&&!_5d){_5d=this._getLayerDomain(_58,_5b);}if(_5d&&_5d.codedValues){var _60;_2.some(_5d.codedValues,function(_61){if(_61.code==_5c){_60=_61.name;return true;}return false;});return _60;}},_getLayerDomain:function(_62,_63){var _64=_62.fields;if(_64){var _65;_2.some(_64,function(_66){if(_66.name===_63){_65=_66.domain;return true;}return false;});return _65;}},_getTypeName:function(_67,id){var _68=_67.types;if(_68){var _69;_2.some(_68,function(_6a){if(_6a.id==id){_69=_6a.name;return true;}return false;});return _69;}}});});