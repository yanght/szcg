/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/layers/FeatureLayer",["dijit","dojo","dojox","dojo/require!esri/layers/graphics,esri/tasks/query,dojo/io/iframe,esri/layers/agscommon,dojo/date/locale"],function(_1,_2,_3){_2.provide("esri.layers.FeatureLayer");_2.require("esri.layers.graphics");_2.require("esri.tasks.query");_2.require("dojo.io.iframe");_2.require("esri.layers.agscommon");_2.require("dojo.date.locale");_2.declare("esri.layers.FeatureLayer",esri.layers.GraphicsLayer,{constructor:function(_4,_5){this._outFields=_5&&_5.outFields;this._loadCallback=_5&&_5.loadCallback;var _6=_5&&_5._usePatch;this._usePatch=(_6===null||_6===undefined)?true:_6;this._trackIdField=_5&&_5.trackIdField;this.objectIdField=_5&&_5.objectIdField;this._maxOffset=_5&&_5.maxAllowableOffset;this._optEditable=_5&&_5.editable;this._optAutoGen=_5&&_5.autoGeneralize;this.editSummaryCallback=_5&&_5.editSummaryCallback;this.userId=_5&&_5.userId;this.userIsAdmin=_5&&_5.userIsAdmin;this.useMapTime=(_5&&_5.hasOwnProperty("useMapTime"))?(!!_5.useMapTime):true;this.source=_5&&_5.source;this.gdbVersion=_5&&_5.gdbVersion;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var _7=this.constructor,_8=this.mode=(esri._isDefined(_5&&_5.mode)?_5.mode:_7.MODE_ONDEMAND);switch(_8){case _7.MODE_SNAPSHOT:this._mode=new esri.layers._SnapshotMode(this);this._isSnapshot=true;break;case _7.MODE_ONDEMAND:this._tileWidth=(_5&&_5.tileWidth)||512;this._tileHeight=(_5&&_5.tileHeight)||512;this._mode=new esri.layers._OnDemandMode(this);var _9=_5&&_5.latticeTiling;this.latticeTiling=_9;break;case _7.MODE_SELECTION:this._mode=new esri.layers._SelectionMode(this);this._isSelOnly=true;break;}this._initLayer=_2.hitch(this,this._initLayer);this._selectHandler=_2.hitch(this,this._selectHandler);this._editable=false;if(_2.isObject(_4)&&_4.layerDefinition){var _a=_4;this._collection=true;this.mode=_7.MODE_SNAPSHOT;this._initLayer(_a);return this;}this._task=new esri.tasks.QueryTask(this.url,{source:this.source,gdbVersion:this.gdbVersion});var _b=this._url.path;this._fserver=false;if(_b.search(/\/FeatureServer\//i)!==-1){this._fserver=true;}var _c=_5&&_5.resourceInfo;if(_c){this._initLayer(_c);}else{if(this.source){var _d={source:this.source.toJson()};this._url.query=_2.mixin(this._url.query,{layer:_2.toJson(_d)});}if(this.gdbVersion){this._url.query=_2.mixin(this._url.query,{gdbVersion:this.gdbVersion});}esri.request({url:_b,content:_2.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});}},_initLayer:function(_e,io){if(_e||io){this._json=_e;this._findCredential();var _f=(this.credential&&this.credential.ssl)||(_e&&_e._ssl);if(_f){this._useSSL();this._task._useSSL();}if(this._collection){this._mode=new esri.layers._SnapshotMode(this);this._isSnapshot=true;this._featureSet=_e.featureSet;this._nextId=_e.nextObjectId;_e=_e.layerDefinition;}if(_e.hasOwnProperty("capabilities")){var _10=(this.capabilities=_e.capabilities);if(_10&&_10.toLowerCase().indexOf("editing")!==-1){this._editable=true;}else{this._editable=false;}}else{if(!this._collection){this._editable=this._fserver;}}if(esri._isDefined(this._optEditable)){this._editable=this._optEditable;delete this._optEditable;}this._json=_2.toJson(this._json);if(this.isEditable()){delete this._maxOffset;}else{if(this.mode!==this.constructor.MODE_SNAPSHOT&&((_e.geometryType==="esriGeometryPolyline")||(_e.geometryType==="esriGeometryPolygon"))){this._autoGeneralize=esri._isDefined(this._optAutoGen)?this._optAutoGen:(this.mode===this.constructor.MODE_ONDEMAND);delete this._optAutoGen;}}var _11=_e.effectiveMinScale||_e.minScale,_12=_e.effectiveMaxScale||_e.maxScale;if(!this._hasMin&&_11){this.setMinScale(_11);}if(!this._hasMax&&_12){this.setMaxScale(_12);}this.layerId=_e.id;this.name=_e.name;this.description=_e.description;this.copyright=_e.copyrightText;this.type=_e.type;this.geometryType=_e.geometryType;this.displayField=_e.displayField;this.defaultDefinitionExpression=_e.definitionExpression;this.fullExtent=new esri.geometry.Extent(_e.extent);this.initialExtent=new esri.geometry.Extent(this.fullExtent.toJson());if(this.fullExtent.spatialReference){this.spatialReference=new esri.SpatialReference(this.fullExtent.spatialReference.toJson());}this.defaultVisibility=_e.defaultVisibility;if((this.geometryType==="esriGeometryPoint")||(this.geometryType==="esriGeometryMultipoint")){this.latticeTiling=false;}this.indexedFields=_e.indexedFields;this.maxRecordCount=_e.maxRecordCount;this.canModifyLayer=_e.canModifyLayer;this.supportsStatistics=_e.supportsStatistics;this.supportsAdvancedQueries=_e.supportsAdvancedQueries;this.hasLabels=_e.hasLabels;this.canScaleSymbols=_e.canScaleSymbols;this.supportsRollbackOnFailure=_e.supportsRollbackOnFailure;this.syncCanReturnChanges=_e.syncCanReturnChanges;this.isDataVersioned=_e.isDataVersioned;this.editFieldsInfo=_e.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=_e.ownershipBasedAccessControlForFeatures;if(this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures){this.creatorField=this.editFieldsInfo.creatorField;}this.relationships=_e.relationships;this.allowGeometryUpdates=esri._isDefined(_e.allowGeometryUpdates)?_e.allowGeometryUpdates:true;this._isTable=(this.type==="Table");var _13=(this.fields=[]),_14=_e.fields,i;for(i=0;i<_14.length;i++){_13.push(new esri.layers.Field(_14[i]));}if(!this.objectIdField){this.objectIdField=_e.objectIdField;if(!this.objectIdField){_14=_e.fields;for(i=0;i<_14.length;i++){var _15=_14[i];if(_15.type==="esriFieldTypeOID"){this.objectIdField=_15.name;break;}}}if(!this.objectIdField){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url},esri.bundle.layers.FeatureLayer.noOIDField));}}if(!esri._isDefined(this._nextId)){var _16=this.objectIdField,_17=-1;if(this._collection&&_16){var _18=this._featureSet,_19=_18&&_18.features,il=_19?_19.length:0,oid,_1a;for(i=0;i<il;i++){_1a=_19[i].attributes;oid=_1a&&_1a[_16];if(oid>_17){_17=oid;}}}this._nextId=(_17+1);}this.globalIdField=_e.globalIdField;var _1b=(this.typeIdField=_e.typeIdField),_1c;if(_1b){_1c=!this._getField(_1b)&&this._getField(_1b,true);if(_1c){this.typeIdField=_1c.name;}}this.visibilityField=_e.visibilityField;var _1d=_e.defaultSymbol;if(_1d){this.defaultSymbol=esri.symbol.fromJson(_1d);}var _1e=this.types=[],_1f=_e.types,_20,_21,_22,_23=this.editFieldsInfo,_24=_23&&_23.creatorField,_25=_23&&_23.editorField,fix=(_24||_25),_26=[];if(_1f){for(i=0;i<_1f.length;i++){_20=new esri.layers.FeatureType(_1f[i]);_21=_20.templates;if(fix&&_21&&_21.length){_26=_26.concat(_21);}_1e.push(_20);}}var _27=_e.templates,_28,_29=this.templates=[];if(_27){for(i=0;i<_27.length;i++){_28=new esri.layers.FeatureTemplate(_27[i]);if(fix){_26.push(_28);}_29.push(_28);}}for(i=0;i<_26.length;i++){_22=_2.getObject("prototype.attributes",false,_26[i]);if(_22){if(_24){delete _22[_24];}if(_25){delete _22[_25];}}}var _2a=_e.timeInfo;if(_2a){this.timeInfo=new esri.layers.TimeInfo(_2a);this._startTimeField=_2a.startTimeField;this._endTimeField=_2a.endTimeField;if(this._startTimeField&&this._endTimeField){this._twoTimeFields=true;}if(this._trackIdField){_2a.trackIdField=this._trackIdField;}else{this._trackIdField=_2a.trackIdField;}}this.hasAttachments=(!this._collection&&_e.hasAttachments)?true:false;this.htmlPopupType=_e.htmlPopupType;var _2b=_e.drawingInfo,_2c;if(!this.renderer){if(_2b&&_2b.renderer){_2c=_2b.renderer;this.setRenderer(esri.renderer.fromJson(_2c));if(_2c.type==="classBreaks"){this.renderer.setMaxInclusive(true);}if(!this._collection){var _2d=_2c.type,_2e=[];_2c=this.renderer;switch(_2d){case "simple":_2e.push(_2c.symbol);break;case "uniqueValue":case "classBreaks":_2e.push(_2c.defaultSymbol);_2e=_2e.concat(_2.map(_2c.infos,function(_2f){return _2f.symbol;}));break;}_2e=_2.filter(_2e,esri._isDefined);var _30=this._url.path+"/images/",_31=this._getToken();_2.forEach(_2e,function(sym){var url=sym.url;if(url){if((url.search(/https?\:/)===-1)&&(url.indexOf("data:")===-1)){sym.url=_30+url;}if(_31&&sym.url.search(/https?\:/)!==-1){sym.url+=("?token="+_31);}}});}}else{if(_1d){_1f=this.types;if(_1f.length>0){_2c=new esri.renderer.UniqueValueRenderer(this.defaultSymbol,this.typeIdField);_2.forEach(_1f,function(_32){_2c.addValue(_32.id,_32.symbol);});}else{_2c=new esri.renderer.SimpleRenderer(this.defaultSymbol);}this.setRenderer(_2c);}else{if(!this._isTable){var _33;switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":_33=new esri.symbol.SimpleMarkerSymbol();break;case "esriGeometryPolyline":_33=new esri.symbol.SimpleLineSymbol();break;case "esriGeometryPolygon":_33=new esri.symbol.SimpleFillSymbol();break;}this.setRenderer(_33?new esri.renderer.SimpleRenderer(_33):null);}}}}var _34=(_2b&&_2b.transparency)||0;if(!esri._isDefined(this.opacity)&&_34>0){this.opacity=1-(_34/100);}this.version=_e.currentVersion;if(!this.version){var ver;if("capabilities" in _e||"drawingInfo" in _e||"hasAttachments" in _e||"htmlPopupType" in _e||"relationships" in _e||"timeInfo" in _e||"typeIdField" in _e||"types" in _e){ver=10;}else{ver=9.3;}this.version=ver;}if((_2.isIE||_2.isSafari)&&this.isEditable()&&this.version<10.02){this._ts=true;}this.loaded=true;this._fixRendererFields();this._checkFields();this._updateCaps();var _35=function(){this.onLoad(this);var _36=this._loadCallback;if(_36){delete this._loadCallback;_36(this);}};if(this._collection){this._fireUpdateStart();var _37=this._featureSet;delete this._featureSet;this._mode._drawFeatures(new esri.tasks.FeatureSet(_37));this._fcAdded=true;_35.call(this);}else{this._forceIdentity(_35);}}},setRenderer:function(ren){this.inherited("setRenderer",arguments);var _38=this.renderer;if(_38){this._ager=(_38.declaredClass.indexOf("TemporalRenderer")!==-1&&_38.observationAger&&_38.observationRenderer);var _39=_2.filter([_38,_38.observationRenderer,_38.latestObservationRenderer,_38.trackRenderer],esri._isDefined);var _3a=[];_2.forEach(_39,function(rnd){if(!_2.isFunction(rnd.attributeField)){_3a.push(rnd.attributeField);}_3a.push(rnd.attributeField2);_3a.push(rnd.attributeField3);},this);this._rendererFields=_2.filter(_3a,esri._isDefined);}else{this._ager=false;this._rendererFields=[];}if(this.loaded&&this._rendererFields.length>0){this._fixRendererFields();this._checkFields(this._rendererFields);}if(this.loaded&&this._collection){this._typesDirty=true;}},_unsetMap:function(map,_3b){var _3c=this._mode;if(_3c){_3c.suspend();}if(this._trackManager){this._trackManager.destroy();this._trackManager=null;}_2.disconnect(this._zoomConnect);this._zoomConnect=null;this._toggleTime(false);this.inherited("_unsetMap",arguments);},refresh:function(){var _3d=this._mode;if(_3d){_3d.refresh();}},setEditable:function(_3e){if(!this._collection){console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service");return this;}if(!this.loaded){this._optEditable=_3e;return this;}var _3f=this._editable;this._editable=_3e;this._updateCaps();if(_3f!==_3e){this.onCapabilitiesChange();}return this;},getEditCapabilities:function(_40){var _41={"canCreate":false,"canUpdate":false,"canDelete":false};if(!this.loaded||!this.isEditable()){return _41;}var _42=_40&&_40.feature,_43=_40&&_40.userId,_44=_2.map((this.capabilities?this.capabilities.toLowerCase().split(","):[]),_2.trim),_45=_2.indexOf(_44,"editing")>-1,_46=_45&&(_2.indexOf(_44,"create")>-1),_47=_45&&(_2.indexOf(_44,"update")>-1),_48=_45&&(_2.indexOf(_44,"delete")>-1),_49=this.ownershipBasedAccessControlForFeatures,_4a=this.editFieldsInfo,_4b=_4a&&_4a.creatorField,_4c=_4a&&_4a.realm,_4d=_42&&_42.attributes,_4e=(_4d&&_4b)?_4d[_4b]:undefined,_4f,_50=!!this.userIsAdmin,_51=!_49||_50||!!(_49.allowOthersToUpdate||_49.allowUpdateToOthers),_52=!_49||_50||!!(_49.allowOthersToDelete||_49.allowDeleteToOthers);if(_50||(_45&&!(_46||_47||_48))){_46=_47=_48=true;}_4f={"canCreate":_46,"canUpdate":_47,"canDelete":_48};if(_4e===null){_4f.canUpdate=_47&&_51;_4f.canDelete=_48&&_52;}else{if(_4e===""){return _4f;}else{if(_4e){_43=_43||this.getUserId();if(_43&&_4c){_43=_43+"@"+_4c;}if(_43.toLowerCase()===_4e.toLowerCase()){return _4f;}else{_4f.canUpdate=_47&&_51;_4f.canDelete=_48&&_52;}}}}return _4f;},getUserId:function(){var _53;if(this.loaded){_53=(this.credential&&this.credential.userId)||this.userId||"";}return _53;},setUserIsAdmin:function(_54){this.userIsAdmin=_54;},setEditSummaryCallback:function(_55){this.editSummaryCallback=_55;},getEditSummary:function(_56,_57,_58){_58=esri._isDefined(_58)?_58:(new Date()).getTime();var _59="",_5a=this.getEditInfo(_56,_57,_58),_5b=(_57&&_57.callback)||this.editSummaryCallback;if(_5b){_5a=_5b(_56,_5a)||"";}if(_2.isString(_5a)){_59=_5a;}else{if(_5a){var _5c=_5a.action,_5d=_5a.userId,_5e=_5a.timeValue,_5f=0;if(_5c){_5f++;}if(_5d){_5f++;}if(esri._isDefined(_5e)){_5f++;}if(_5f>1){_59=(_5c==="edit"?"edit":"create")+(_5d?"User":"")+(esri._isDefined(_5e)?_5a.displayPattern:"");}}_59=_59&&esri.substitute(_5a,esri.bundle.layers.FeatureLayer[_59]);}return _59;},getEditInfo:function(_60,_61,_62){if(!this.loaded){return;}_62=esri._isDefined(_62)?_62:(new Date()).getTime();var _63=(_61&&_61.action)||"last",_64=this.editFieldsInfo,_65=_64&&_64.creatorField,_66=_64&&_64.creationDateField,_67=_64&&_64.editorField,_68=_64&&_64.editDateField,_69=_64&&_64.realm,_6a=_60&&_60.attributes,_6b=(_6a&&_65)?_6a[_65]:undefined,_6c=(_6a&&_66)?_6a[_66]:null,_6d=(_6a&&_67)?_6a[_67]:undefined,_6e=(_6a&&_68)?_6a[_68]:null,_6f=this._getEditData(_6b,_6c,_62),_70=this._getEditData(_6d,_6e,_62),_71;switch(_63){case "creation":_71=_6f;break;case "edit":_71=_70;break;case "last":_71=_70||_6f;break;}if(_71){_71.action=(_71===_70)?"edit":"creation";}return _71;},_getEditData:function(_72,_73,_74){var _75,_76,_77,_78=60000,_79=3600000,_7a=2*_79,_7b=24*_79,_7c=7*_7b;if(esri._isDefined(_73)){_76=_74-_73;if(_76<0){_77="Full";}else{if(_76<_78){_77="Seconds";}else{if(_76<(2*_78)){_77="Minute";}else{if(_76<_79){_77="Minutes";}else{if(_76<_7a){_77="Hour";}else{if(_76<_7b){_77="Hours";}else{if(_76<_7c){_77="WeekDay";}else{_77="Full";}}}}}}}}if((_72!==undefined)||_77){_75=_75||{};_75.userId=_72;if(_77){var _7d=_2.date.locale.format,_7e=new Date(_73);_75.minutes=Math.floor(_76/_78);_75.hours=Math.floor(_76/_79);_75.weekDay=_7d(_7e,{datePattern:"EEEE",selector:"date"});_75.formattedDate=_7d(_7e,{selector:"date"});_75.formattedTime=_7d(_7e,{selector:"time"});_75.displayPattern=_77;_75.timeValue=_73;}}return _75;},isEditable:function(){return !!(this._editable||this.userIsAdmin);},setMaxAllowableOffset:function(_7f){if(!this.isEditable()){this._maxOffset=_7f;}return this;},getMaxAllowableOffset:function(){return this._maxOffset;},setAutoGeneralize:function(_80){if(!this.loaded){this._optAutoGen=_80;}else{if(!this.isEditable()&&(this.mode!==this.constructor.MODE_SNAPSHOT)&&((this.geometryType==="esriGeometryPolyline")||(this.geometryType==="esriGeometryPolygon"))){this._autoGeneralize=_80;if(_80){var map=this._map;if(map&&map.loaded){this._maxOffset=Math.floor(map.extent.getWidth()/map.width);}}else{delete this._maxOffset;}}}return this;},setGDBVersion:function(_81){if(!this._collection&&(_81!==this.gdbVersion)&&(_81||this.gdbVersion)){this.gdbVersion=_81;this._task.gdbVersion=_81;this._url.query=_2.mixin(this._url.query,{gdbVersion:_81});if(this.loaded){this.clearSelection();if(this._map){this.refresh();}}this.onGDBVersionChange();}return this;},setDefinitionExpression:function(_82){this._defnExpr=_82;var _83=this._mode;if(_83){_83.propertyChangeHandler(1);}return this;},getDefinitionExpression:function(){return this._defnExpr;},setTimeDefinition:function(_84){if(this._isSnapshot){this._timeDefn=_84;var _85=this._mode;if(_85){_85.propertyChangeHandler(2);}}else{console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id = "+this.id+", Layer URL = "+this.url);}return this;},getTimeDefinition:function(){return this._timeDefn;},setTimeOffset:function(_86,_87){this._timeOffset=_86;this._timeOffsetUnits=_87;var _88=this._mode;if(_88){_88.propertyChangeHandler(0);}return this;},setUseMapTime:function(use){this.useMapTime=use;this._toggleTime(!this.suspended);var _89=this._mode;if(_89){_89.propertyChangeHandler(0);}},selectFeatures:function(_8a,_8b,_8c,_8d){_8b=_8b||this.constructor.SELECTION_NEW;var _8e=this._getShallowClone(_8a),map=this._map,_8f,dfd=esri._fixDfd(new _2.Deferred(esri._dfdCanceller));_8e.outFields=this._getOutFields();_8e.returnGeometry=true;if(map){_8e.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());}if(!this._applyQueryFilters(_8e)){_8f={features:[]};this._selectHandler(_8f,_8b,_8c,_8d,dfd);return dfd;}var _90=this._canDoClientSideQuery(_8e);if(_90){_8f={features:this._doQuery(_8e,_90)};this._selectHandler(_8f,_8b,_8c,_8d,dfd);return dfd;}else{if(this._collection){var err=new Error("FeatureLayer::selectFeatures - "+esri.bundle.layers.FeatureLayer.invalidParams);this._resolve([err],null,_8d,dfd,true);return dfd;}var _91=this;if(this._ts){_8e._ts=(new Date()).getTime();}var _92=dfd._pendingDfd=this._task.execute(_8e);_92.addCallbacks(function(_93){_91._selectHandler(_93,_8b,_8c,_8d,dfd);},function(err){_91._resolve([err],null,_8d,dfd,true);});return dfd;}},getSelectedFeatures:function(){var _94=this._selectedFeatures,_95=[],_96;for(_96 in _94){if(_94.hasOwnProperty(_96)){_95.push(_94[_96]);}}return _95;},clearSelection:function(_97){var _98=this._selectedFeatures,_99=this._mode,_9a;for(_9a in _98){if(_98.hasOwnProperty(_9a)){this._unSelectFeatureIIf(_9a,_99);_99._removeFeatureIIf(_9a);}}this._selectedFeatures={};if(this._isSelOnly){_99._applyTimeFilter(true);}if(!_97){this.onSelectionClear();}return this;},setSelectionSymbol:function(_9b){this._selectionSymbol=_9b;if(_9b){var _9c=this._selectedFeatures,_9d;for(_9d in _9c){if(_9c.hasOwnProperty(_9d)){_9c[_9d].setSymbol(_9b);}}}return this;},getSelectionSymbol:function(){return this._selectionSymbol;},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(_9e,_9f,_a0,_a1,_a2,_a3){var _a4=_a3.assembly,dfd=_a3.dfd;this._applyNormalized(_9e,_a4&&_a4[0]);this._applyNormalized(_9f,_a4&&_a4[1]);this.onBeforeApplyEdits(_9e,_9f,_a0);var i,_a5={},_a6=this.objectIdField,_a7={f:"json"},_a8=false;if(this._collection){var _a9={};_a9.addResults=_9e?_2.map(_9e,function(){_a8=true;return {objectId:this._nextId++,success:true};},this):null;_a9.updateResults=_9f?_2.map(_9f,function(_aa){_a8=true;var oid=_aa.attributes[_a6];_a5[oid]=_aa;return {objectId:oid,success:true};},this):null;_a9.deleteResults=_a0?_2.map(_a0,function(_ab){_a8=true;return {objectId:_ab.attributes[_a6],success:true};},this):null;if(_a8){this._editHandler(_a9,_9e,_a5,_a1,_a2,dfd);}return;}if(_9e&&_9e.length>0){_a7.adds=this._convertFeaturesToJson(_9e,0,1);_a8=true;}if(_9f&&_9f.length>0){for(i=0;i<_9f.length;i++){var _ac=_9f[i];_a5[_ac.attributes[_a6]]=_ac;}_a7.updates=this._convertFeaturesToJson(_9f,0,0,1);_a8=true;}if(_a0&&_a0.length>0){var ids=[];for(i=0;i<_a0.length;i++){ids.push(_a0[i].attributes[_a6]);}_a7.deletes=ids.join(",");_a8=true;}if(_a8){var _ad=this;return esri.request({url:this._url.path+"/applyEdits",content:_2.mixin(_a7,this._url.query),callbackParamName:"callback",load:function(_ae){_ad._editHandler(_ae,_9e,_a5,_a1,_a2,dfd);},error:function(err){_ad._resolve([err],null,_a2,dfd,true);}},{usePost:true});}},queryFeatures:function(_af,_b0,_b1){return this._query("execute","onQueryFeaturesComplete",_af,_b0,_b1);},queryRelatedFeatures:function(_b2,_b3,_b4){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",_b2,_b3,_b4);},queryIds:function(_b5,_b6,_b7){return this._query("executeForIds","onQueryIdsComplete",_b5,_b6,_b7);},queryCount:function(_b8,_b9,_ba){return this._query("executeForCount","onQueryCountComplete",_b8,_b9,_ba);},queryAttachmentInfos:function(_bb,_bc,_bd){var url=this._url.path+"/"+_bb+"/attachments",dfd=new _2.Deferred(esri._dfdCanceller),_be=this;dfd._pendingDfd=esri.request({url:url,content:_2.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(_bf){var _c0=_bf.attachmentInfos,_c1;_2.forEach(_c0,function(_c2){_c1=_2.objectToQuery({gdbVersion:_be._url.query&&_be._url.query.gdbVersion,layer:_be._url.query&&_be._url.query.layer,token:_be._getToken()});_c2.url=url+"/"+_c2.id+(_c1?("?"+_c1):"");_c2.objectId=_bb;});_be._resolve([_c0],"onQueryAttachmentInfosComplete",_bc,dfd);},error:function(err){_be._resolve([err],null,_bd,dfd,true);}});return dfd;},addAttachment:function(_c3,_c4,_c5,_c6){return this._sendAttachment("add",_c3,_c4,_c5,_c6);},updateAttachment:function(_c7,_c8,_c9,_ca,_cb){_c9.appendChild(_2.create("input",{type:"hidden",name:"attachmentId",value:_c8}));return this._sendAttachment("update",_c7,_c9,_ca,_cb);},deleteAttachments:function(_cc,_cd,_ce,_cf){var url=this._url.path+"/"+_cc+"/deleteAttachments",dfd=new _2.Deferred(esri._dfdCanceller),_d0=this,_d1={f:"json",attachmentIds:_cd.join(",")};dfd._pendingDfd=esri.request({url:url,content:_2.mixin(_d1,this._url.query),callbackParamName:"callback",load:_2.hitch(this,function(_d2){var _d3=_d2.deleteAttachmentResults;_d3=_2.map(_d3,function(_d4){var res=new esri.layers.FeatureEditResult(_d4);res.attachmentId=res.objectId;res.objectId=_cc;return res;});_d0._resolve([_d3],"onDeleteAttachmentsComplete",_ce,dfd);}),error:function(err){_d0._resolve([err],null,_cf,dfd,true);}},{usePost:true});return dfd;},addType:function(_d5){var _d6=this.types;if(_d6){var _d7=_2.some(_d6,function(_d8){if(_d8.id==_d5.id){return true;}return false;});if(_d7){return false;}else{_d6.push(_d5);}}else{this.types=[_d5];}this._typesDirty=true;return true;},deleteType:function(_d9){if(!this._collection){return;}var _da=this.types;if(_da){var _db=-1;_2.some(_da,function(_dc,_dd){if(_dc.id==_d9){_db=_dd;return true;}return false;});if(_db>-1){this._typesDirty=true;return _da.splice(_db,1)[0];}}},toJson:function(){var _de=this._json,_df=_2.isString(_de)?_2.fromJson(_de):_2.clone(_de);if(!_df){return;}_df=_df.layerDefinition?_df:{layerDefinition:_df};var _e0=_df.layerDefinition,_e1=this._collection;if(_e1&&this._typesDirty){_e0.types=_2.map(this.types||[],function(_e2){return _e2.toJson();});var _e3=this.renderer,_e4=_e0.drawingInfo;if(_e4&&_e3&&_e3.declaredClass.indexOf("TemporalRenderer")===-1){_e4.renderer=_e3.toJson();}}var _e5=null;if(!(_e1&&!this._fcAdded)){_e5={geometryType:_e0.geometryType,features:this._convertFeaturesToJson(this.graphics,true)};}_df.featureSet=_2.mixin({},_df.featureSet||{},_e5);if(_e1){_df.nextObjectId=this._nextId;_e0.capabilities=this.capabilities;}return _df;},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},_forceIdentity:function(_e6){var _e7=this,_e8=this._url&&this._url.path;if((this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&_e8&&esri.id&&esri.id._hasPortalSession()&&esri.id._doPortalSignIn(_e8)){esri.id.getCredential(_e8).then(function(){_e7._findCredential();_e6.call(_e7);},function(){_e6.call(_e7);});}else{_e6.call(this);}},_updateCaps:function(){var _e9=this._editable,_ea=_2.trim(this.capabilities||""),_eb=_2.map((_ea?_ea.split(","):[]),_2.trim),_ec=_2.map((_ea?_ea.toLowerCase().split(","):[]),_2.trim),_ed=_2.indexOf(_ec,"editing"),cap,i,_ee,_ef={"Create":_2.indexOf(_ec,"create"),"Update":_2.indexOf(_ec,"update"),"Delete":_2.indexOf(_ec,"delete")};if(_e9&&_ed===-1){_eb.push("Editing");}else{if(!_e9&&_ed>-1){_ee=[_ed];for(cap in _ef){if(_ef[cap]>-1){_ee.push(_ef[cap]);}}_ee.sort();for(i=_ee.length-1;i>=0;i--){_eb.splice(_ee[i],1);}}}this.capabilities=_eb.join(",");},_counter:{value:0},_getUniqueId:function(){return this._counter.value++;},onSuspend:function(){this.inherited(arguments);this._toggleTime(false);var _f0=this._mode;if(_f0){_f0.suspend();}},onResume:function(evt){this.inherited(arguments);this._toggleTime(true);this._updateMaxOffset();var _f1=this._mode,map=this._map,_f2=this.renderer;if(evt.firstOccurrence){this.clearSelection();if(this.timeInfo){if(this._trackIdField||(_f2&&(_f2.latestObservationRenderer||_f2.trackRenderer))){this._trackManager=new esri.layers._TrackManager(this);this._trackManager.initialize(map);}}this._zoomConnect=_2.connect(map,"onZoomEnd",this,this._updateMaxOffset);}if(_f1){evt.firstOccurrence?_f1.initialize(map):_f1.resume();}},_updateMaxOffset:function(){var map=this._map;if(map&&map.loaded){if(this._autoGeneralize){this._maxOffset=Math.floor(map.extent.getWidth()/map.width);}}},_toggleTime:function(_f3){var map=this._map;if(_f3&&this.timeInfo&&this.useMapTime&&map){this._mapTimeExtent=map.timeExtent;if(!this._timeConnect){this._timeConnect=_2.connect(map,"onTimeExtentChange",this,this._timeChangeHandler);}}else{this._mapTimeExtent=null;_2.disconnect(this._timeConnect);this._timeConnect=null;}},_timeChangeHandler:function(_f4){this._mapTimeExtent=_f4;var _f5=this._mode;if(_f5){_f5.propertyChangeHandler(0);}},_getOffsettedTE:function(_f6){var _f7=this._timeOffset,_f8=this._timeOffsetUnits;return (_f6&&_f7&&_f8)?_f6.offset(-1*_f7,_f8):_f6;},_getTimeOverlap:function(_f9,_fa){if(_f9&&_fa){return _f9.intersection(_fa);}else{return _f9||_fa;}},_getTimeFilter:function(_fb){var _fc=this.getTimeDefinition(),_fd=null,_fe;if(_fc||_fd){_fe=this._getTimeOverlap(_fc,_fd);if(!_fe){return [false];}}if(_fb){_fb=_fe?this._getTimeOverlap(_fb,_fe):_fb;if(!_fb){return [false];}}else{_fb=_fe;}return [true,_fb];},_getAttributeFilter:function(_ff){var _100=this.getDefinitionExpression();if(_ff){_ff=_100?"("+_100+") AND ("+_ff+")":_ff;}else{_ff=_100;}return _ff;},_applyQueryFilters:function(_101){_101.where=this._getAttributeFilter(_101.where);_101.maxAllowableOffset=this._maxOffset;if(this.timeInfo){var _102=this._getTimeFilter(_101.timeExtent);if(!_102[0]){return false;}else{_101.timeExtent=_102[1];}}return true;},_add:function(_103){var _104=this._selectionSymbol,attr=_103.attributes,_105=this.visibilityField;if(_104&&this._isSelOnly){_103.setSymbol(_104);}if(_105&&attr&&attr.hasOwnProperty(_105)){_103[attr[_105]?"show":"hide"]();}return this.add.apply(this,arguments);},_remove:function(){return this.remove.apply(this,arguments);},_canDoClientSideQuery:function(_106){var _107=[],map=this._map;if(this._isTable||!map){return;}if(_106.text||(_106.where&&_106.where!==this.getDefinitionExpression())){return;}var _108=this._isSnapshot,_109=this._isSelOnly;var _10a=_106.geometry;if(_10a){if(!_109&&_106.spatialRelationship===esri.tasks.Query.SPATIAL_REL_INTERSECTS&&(_10a.type==="extent"&&(_108||map.extent.contains(_10a)))){_107.push(1);}else{return;}}var ids=_106.objectIds;if(ids){if(_108){_107.push(2);}else{var len=ids.length,mode=this._mode,_10b=0,i;for(i=0;i<len;i++){if(mode._getFeature(ids[i])){_10b++;}}if(_10b===len){_107.push(2);}else{return;}}}if(this.timeInfo){var _10c=_106.timeExtent,_10d=this._mapTimeExtent;if(_108){if(_10c){_107.push(3);}}else{if(_109){if(_10c){return;}}else{if(_10d){if(_2.indexOf(_107,2)!==-1){if(_10c){_107.push(3);}}else{return;}}else{if(_107.length>0){if(_10c){_107.push(3);}}else{if(_10c){return;}}}}}}return _107.length>0?_107:null;},_doQuery:function(_10e,_10f,_110){var _111=[],mode=this._mode,_112=this.objectIdField,i,len,_113;if(_2.indexOf(_10f,2)!==-1){_111=[];var ids=_10e.objectIds;len=ids.length;for(i=0;i<len;i++){var obj=mode._getFeature(ids[i]);if(obj){_111.push(obj);}}if(_111.length===0){return [];}}if(_2.indexOf(_10f,1)!==-1){_113=_111.length>0?_111:this.graphics;len=_113.length;var _114=_10e.geometry._normalize(null,true);_111=[];for(i=0;i<len;i++){var _115=_113[i],_116=_115.geometry;if(_116){if(this.normalization&&_114.length){if(_114[0].intersects(_116)||_114[1].intersects(_116)){_111.push(_115);}}else{if(_114.intersects(_116)){_111.push(_115);}}}}if(_111.length===0){return [];}}if(_2.indexOf(_10f,3)!==-1){if(this.timeInfo){_113=_111.length>0?_111:this.graphics;var time=_10e.timeExtent,_117=this._filterByTime(_113,time.startTime,time.endTime);_111=_117.match;}}if(_110){return _2.map(_111,function(obj){return obj.attributes[_112];},this);}else{return _111;}},_filterByTime:function(_118,_119,_11a){var _11b=this._startTimeField,_11c=this._endTimeField,_11d;if(!this._twoTimeFields){_11d=_11b||_11c;}var _11e=esri._isDefined,yea=[],nay=[],i,len=_118.length,_11f,_120;_119=_119?_119.getTime():-Infinity;_11a=_11a?_11a.getTime():Infinity;if(_11d){for(i=0;i<len;i++){_11f=_118[i];_120=_11f.attributes;var time=_120[_11d];if(time>=_119&&time<=_11a){yea.push(_11f);}else{nay.push(_11f);}}}else{for(i=0;i<len;i++){_11f=_118[i];_120=_11f.attributes;var _121=_120[_11b],end=_120[_11c];_121=_11e(_121)?_121:-Infinity;end=_11e(end)?end:Infinity;if((_121>=_119&&_121<=_11a)||(end>=_119&&end<=_11a)||(_119>=_121&&_11a<=end)){yea.push(_11f);}else{nay.push(_11f);}}}return {match:yea,noMatch:nay};},_resolve:function(args,_122,_123,dfd,_124){if(_122){this[_122].apply(this,args);}if(_123){_123.apply(null,args);}if(dfd){esri._resDfd(dfd,args,_124);}},_getShallowClone:function(_125){var _126=new esri.tasks.Query(),prop;for(prop in _125){if(_125.hasOwnProperty(prop)){_126[prop]=_125[prop];}}return _126;},_query:function(type,_127,_128,_129,_12a){var that=this,map=this._map,dfd=new _2.Deferred(esri._dfdCanceller),_12b=_128;var _12c=function(_12d,_12e){if(!_12e&&type==="execute"&&!that._isTable){var _12f=_12d.features,mode=that._mode,_130=that.objectIdField,il=_12f.length,i;for(i=il-1;i>=0;i--){var oid=_12f[i].attributes[_130];var _131=mode._getFeature(oid);if(_131){_12f.splice(i,1,_131);}}}that._resolve([_12d],_127,_129,dfd);};if(type!=="executeRelationshipQuery"){_12b=this._getShallowClone(_128);_12b.outFields=this._getOutFields();_12b.returnGeometry=(!map&&_128.hasOwnProperty("returnGeometry"))?_128.returnGeometry:true;var _132;if(map){_12b.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());}if(!this._applyQueryFilters(_12b)){switch(type){case "execute":_132=new esri.tasks.FeatureSet({features:[]});break;case "executeForIds":_132=[];break;case "executeForCount":_132=0;break;}_12c(_132,true);return dfd;}var _133=this._canDoClientSideQuery(_12b);if(_133){var _134=this._doQuery(_12b,_133,(type==="executeForIds"||type==="executeForCount"));switch(type){case "execute":_132=new esri.tasks.FeatureSet();_132.features=_134;break;case "executeForIds":_132=_134;break;case "executeForCount":_132=_134.length;break;}_12c(_132,true);return dfd;}}if(this._collection){var err=new Error("FeatureLayer::_query - "+esri.bundle.layers.FeatureLayer.invalidParams);this._resolve([err],null,_12a,dfd,true);return dfd;}if(this._ts){_12b._ts=(new Date()).getTime();}var temp=dfd._pendingDfd=this._task[type](_12b);temp.addCallbacks(_12c,function(err){that._resolve([err],null,_12a,dfd,true);});return dfd;},_convertFeaturesToJson:function(_135,_136,_137,_138){var json=[],_139=this._selectionSymbol,_13a=this.visibilityField,i,_13b,_13c=this.objectIdField;if(this.loaded&&(_137||_138)){_13b=_2.filter(this.fields,function(_13d){return (_13d.editable===false)&&(!_138||(_13d.name!==_13c));});}for(i=0;i<_135.length;i++){var _13e=_135[i],_13f={},_140=_13e.geometry,attr=_13e.attributes,_141=_13e.symbol;if(_140&&(!_138||!this.loaded||this.allowGeometryUpdates)){_13f.geometry=_140.toJson();}if(_13a){_13f.attributes=attr=_2.mixin({},attr);attr[_13a]=_13e.visible?1:0;}else{if(attr){_13f.attributes=_2.mixin({},attr);}}if(_13f.attributes&&_13b&&_13b.length){_2.forEach(_13b,function(_142){delete _13f.attributes[_142.name];});}if(_141&&(_141!==_139)){_13f.symbol=_141.toJson();}json.push(_13f);}return _136?json:_2.toJson(json);},_selectHandler:function(_143,_144,_145,_146,dfd){var _147,ctor=this.constructor;switch(_144){case ctor.SELECTION_NEW:this.clearSelection(true);_147=true;break;case ctor.SELECTION_ADD:_147=true;break;case ctor.SELECTION_SUBTRACT:_147=false;break;}var i,_148=_143.features,mode=this._mode,_149=[],_14a=this.objectIdField,_14b,oid;if(_147){for(i=0;i<_148.length;i++){_14b=_148[i];oid=_14b.attributes[_14a];var _14c=mode._addFeatureIIf(oid,_14b);_149.push(_14c);this._selectFeatureIIf(oid,_14c,mode);}}else{for(i=0;i<_148.length;i++){_14b=_148[i];oid=_14b.attributes[_14a];this._unSelectFeatureIIf(oid,mode);var _14d=mode._removeFeatureIIf(oid);_149.push(_14d||_14b);}}if(this._isSelOnly){mode._applyTimeFilter(true);}this._resolve([_149,_144,_143.exceededTransferLimit?{queryLimitExceeded:true}:null],"onSelectionComplete",_145,dfd);if(_143.exceededTransferLimit){this.onQueryLimitExceeded();}},_selectFeatureIIf:function(oid,_14e,mode){var _14f=this._selectedFeatures,_150=_14f[oid];if(!_150){mode._incRefCount(oid);_14f[oid]=_14e;if(!this._isTable){this._setSelectSymbol(_14e);}}return _150||_14e;},_unSelectFeatureIIf:function(oid,mode){var _151=this._selectedFeatures[oid];if(_151){mode._decRefCount(oid);delete this._selectedFeatures[oid];if(!this._isTable){this._setUnSelectSymbol(_151);}}return _151;},_isSelected:function(_152){},_setSelectSymbol:function(_153){var _154=this._selectionSymbol;if(_154&&!this._isSelOnly){_153.setSymbol(_154);}},_setUnSelectSymbol:function(_155){var _156=this._selectionSymbol;if(_156&&!this._isSelOnly){if(_156===_155.symbol){_155.setSymbol(null,true);}}},_getOutFields:function(){var _157=_2.filter([this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields),function(_158,_159,arr){return !!_158&&(_2.indexOf(arr,_158)===_159);});var _15a=_2.clone(this._outFields);if(_15a){if(_2.indexOf(_15a,"*")!==-1){return _15a;}_2.forEach(_157,function(_15b){if(_2.indexOf(_15a,_15b)===-1){_15a.push(_15b);}});return _15a;}else{return _157;}},_checkFields:function(_15c){var _15d=_15c||this._getOutFields();_2.forEach(_15d,function(_15e){if(_15e==="*"){return;}if(!this._getField(_15e)){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url,field:_15e},esri.bundle.layers.FeatureLayer.fieldNotFound));}},this);if(!_15c&&!this._isTable&&!this._fserver&&!this._collection){var _15f=_2.some(this.fields,function(_160){return (_160&&_160.type==="esriFieldTypeGeometry")?true:false;});if(!_15f){console.debug("esri.layers.FeatureLayer: "+esri.substitute({url:this.url},esri.bundle.layers.FeatureLayer.noGeometryField));}}},_fixRendererFields:function(){var _161=this.renderer;if(_161&&this.fields.length>0){var _162=_2.filter([_161,_161.observationRenderer,_161.latestObservationRenderer,_161.trackRenderer],esri._isDefined);var _163=[];_2.forEach(_162,function(rnd){var _164,_165;_165=rnd.attributeField;if(_165&&!_2.isFunction(_165)){_164=!this._getField(_165)&&this._getField(_165,true);if(_164){rnd.attributeField=_164.name;}}_165=rnd.attributeField2;if(_165){_164=!this._getField(_165)&&this._getField(_165,true);if(_164){rnd.attributeField2=_164.name;}}_165=rnd.attributeField3;if(_165){_164=!this._getField(_165)&&this._getField(_165,true);if(_164){rnd.attributeField3=_164.name;}}if(!_2.isFunction(rnd.attributeField)){_163.push(rnd.attributeField);}_163.push(rnd.attributeField2);_163.push(rnd.attributeField3);},this);this._rendererFields=_2.filter(_163,esri._isDefined);}},_getField:function(_166,_167){var _168=this.fields;if(_168.length===0){return null;}var _169;if(_167){_166=_166.toLowerCase();}_2.some(_168,function(_16a){var _16b=false;if(_167){_16b=(_16a&&_16a.name.toLowerCase()===_166)?true:false;}else{_16b=(_16a&&_16a.name===_166)?true:false;}if(_16b){_169=_16a;}return _16b;});return _169;},_getDateOpts:function(){if(!this._dtOpts){var _16c=_2.map(_2.filter(this.fields,function(_16d){return !!(_16d&&_16d.type==="esriFieldTypeDate");}),function(_16e){return _16e.name;});this._dtOpts={properties:_16c};}return this._dtOpts;},_applyNormalized:function(_16f,_170){if(_16f&&_170){_2.forEach(_16f,function(_171,_172){if(_171&&_170[_172]){_171.setGeometry(_170[_172]);}});}},_editHandler:function(_173,adds,_174,_175,_176,dfd){var _177=_173.addResults,_178=_173.updateResults,_179=_173.deleteResults,i,_17a,oid,_17b,attr,_17c=this.objectIdField,mode=this._mode,_17d=this._isTable;var _17e=this.editFieldsInfo,_17f=this._getOutFields()||[],_180=_17e&&_17e.creatorField,_181=_17e&&_17e.creationDateField,_182=_17e&&_17e.editorField,_183=_17e&&_17e.editDateField,_184=_17e&&_17e.realm;if(_2.indexOf(_17f,"*")===-1){if(_180&&_2.indexOf(_17f,_180)===-1){_180=null;}if(_181&&_2.indexOf(_17f,_181)===-1){_181=null;}if(_182&&_2.indexOf(_17f,_182)===-1){_182=null;}if(_183&&_2.indexOf(_17f,_183)===-1){_183=null;}}var _185=(_181||_183)?(new Date()).getTime():null,_186=(_180||_182)?this.getUserId():undefined;if(_186&&_184){_186=_186+"@"+_184;}if(_177){for(i=0;i<_177.length;i++){_177[i]=new esri.layers.FeatureEditResult(_177[i]);if(_17d){continue;}_17a=_177[i];if(_17a.success){oid=_17a.objectId;_17b=adds[i];var gl=_17b._graphicsLayer;if(gl&&gl!==this){gl.remove(_17b);}attr=_17b.attributes||{};attr[_17c]=oid;if(_180){attr[_180]=_186;}if(_182){attr[_182]=_186;}if(_181){attr[_181]=_185;}if(_183){attr[_183]=_185;}_17b.setAttributes(attr);if(mode._init){mode.drawFeature(_17b);}}}}if(_178){for(i=0;i<_178.length;i++){_178[i]=new esri.layers.FeatureEditResult(_178[i]);if(_17d){continue;}_17a=_178[i];if(_17a.success){oid=_17a.objectId;_17b=_174[oid];var _187=mode._getFeature(oid);if(_187){if(_187.geometry!==_17b.geometry){_187.setGeometry(esri.geometry.fromJson(_17b.geometry.toJson()));}this._repaint(_187,oid);}_17b=_187||_17b;attr=_17b.attributes||{};if(_182){attr[_182]=_186;}if(_183){attr[_183]=_185;}_17b.setAttributes(attr);}}}if(_179){var _188=[];for(i=0;i<_179.length;i++){_179[i]=new esri.layers.FeatureEditResult(_179[i]);if(_17d){continue;}_17a=_179[i];if(_17a.success){oid=_17a.objectId;_17b=mode._getFeature(oid);if(_17b){if(this._unSelectFeatureIIf(oid,mode)){_188.push(_17b);}_17b._count=0;mode._removeFeatureIIf(oid);}}}if(_188.length>0){this.onSelectionComplete(_188,this.constructor.SELECTION_SUBTRACT);}}this._resolve([_177,_178,_179],"onEditsComplete",_175,dfd);},_sendAttachment:function(type,_189,_18a,_18b,_18c){var _18d=(type==="add")?"addAttachment":"updateAttachment",url=this._url.path+"/"+_189+"/"+_18d,self=this;var dfd=esri.request({url:url,form:_18a,content:_2.mixin(this._url.query,{f:"json",token:this._getToken()||undefined}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(_18e){var _18f=(type==="add")?"addAttachmentResult":"updateAttachmentResult",_190=(type==="add")?"onAddAttachmentComplete":"onUpdateAttachmentComplete",_191=new esri.layers.FeatureEditResult(_18e[_18f]);_191.attachmentId=_191.objectId;_191.objectId=_189;self._resolve([_191],_190,_18b);return _191;}).addErrback(function(_192){self._resolve([_192],null,_18c,null,true);});return dfd;},_repaint:function(_193,oid,_194){oid=esri._isDefined(oid)?oid:_193.attributes[this.objectIdField];if(!(oid in this._selectedFeatures)||!this._selectionSymbol){_193.setSymbol(_193.symbol,_194);}},_getKind:function(_195){var _196=this._trackManager;if(_196){return _196.isLatestObservation(_195)?1:0;}return 0;}});_2.mixin(esri.layers.FeatureLayer,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});esri._createWrappers("esri.layers.FeatureLayer");_2.declare("esri.layers.FeatureType",null,{constructor:function(json){if(json&&_2.isObject(json)){this.id=json.id;this.name=json.name;var _197=json.symbol;if(_197){this.symbol=esri.symbol.fromJson(_197);}var _198=json.domains,_199,i;var _19a=this.domains={};for(_199 in _198){if(_198.hasOwnProperty(_199)){var _19b=_198[_199];switch(_19b.type){case "range":_19a[_199]=new esri.layers.RangeDomain(_19b);break;case "codedValue":_19a[_199]=new esri.layers.CodedValueDomain(_19b);break;case "inherited":_19a[_199]=new esri.layers.InheritedDomain(_19b);break;}}}var _19c=json.templates;if(_19c){var _19d=this.templates=[];for(i=0;i<_19c.length;i++){_19d.push(new esri.layers.FeatureTemplate(_19c[i]));}}}},toJson:function(){var json={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()};var _19e,_19f=this.domains,_1a0=this.templates,_1a1=esri._sanitize;if(_19f){var _1a2=json.domains={};for(_19e in _19f){if(_19f.hasOwnProperty(_19e)){_1a2[_19e]=_19f[_19e]&&_19f[_19e].toJson();}}_1a1(_1a2);}if(_1a0){json.templates=_2.map(_1a0,function(_1a3){return _1a3.toJson();});}return _1a1(json);}});_2.declare("esri.layers.FeatureTemplate",null,{constructor:function(json){if(json&&_2.isObject(json)){this.name=json.name;this.description=json.description;this.drawingTool=json.drawingTool;var _1a4=json.prototype;this.prototype=new esri.Graphic(_1a4.geometry,null,_1a4.attributes);}},toJson:function(){return esri._sanitize({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()});}});_2.mixin(esri.layers.FeatureTemplate,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});_2.declare("esri.layers.FeatureEditResult",null,{constructor:function(json){if(json&&_2.isObject(json)){this.objectId=json.objectId;this.success=json.success;if(!json.success){var err=json.error;this.error=new Error();this.error.code=err.code;this.error.message=err.description;}}}});_2.declare("esri.layers._RenderMode",null,{constructor:function(){this._prefix="jsonp_"+(_2._scopeName||"dojo")+"IoScript";},initialize:function(map){},propertyChangeHandler:function(type){},destroy:function(){},drawFeature:function(_1a5){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(oid){var _1a6=this._featureMap[oid];if(_1a6){_1a6._count++;}},_decRefCount:function(oid){var _1a7=this._featureMap[oid];if(_1a7){_1a7._count--;}},_getFeature:function(oid){return this._featureMap[oid];},_addFeatureIIf:function(oid,_1a8){var fmap=this._featureMap,_1a9=fmap[oid],_1aa=this.featureLayer;if(!_1a9){fmap[oid]=_1a8;_1aa._add(_1a8);_1a8._count=0;}return _1a9||_1a8;},_removeFeatureIIf:function(oid){var _1ab=this._featureMap[oid],_1ac=this.featureLayer;if(_1ab){if(_1ab._count){return;}delete this._featureMap[oid];_1ac._remove(_1ab);}return _1ab;},_clearIIf:function(){var i,_1ad=this.featureLayer,_1ae=_1ad.graphics,_1af=_1ad._selectedFeatures,_1b0=_1ad.objectIdField;for(i=_1ae.length-1;i>=0;i--){var _1b1=_1ae[i];var oid=_1b1.attributes[_1b0];if(oid in _1af){_1b1._count=1;continue;}_1b1._count=0;this._removeFeatureIIf(oid);}},_isPending:function(id){var dfd=_2.io.script[this._prefix+id];return dfd?true:false;},_cancelPendingRequest:function(dfd,id){dfd=dfd||_2.io.script[this._prefix+id];if(dfd){try{dfd.cancel();_2.io.script._validCheck(dfd);}catch(e){}}},_purgeRequests:function(){_2.io.script._validCheck(null);},_toggleVisibility:function(show){var _1b2=this.featureLayer,_1b3=_1b2.graphics,_1b4=show?"show":"hide",i,len=_1b3.length;show=show&&_1b2._ager;for(i=0;i<len;i++){var _1b5=_1b3[i];_1b5[_1b4]();if(show){_1b2._repaint(_1b5);}}},_applyTimeFilter:function(_1b6){var _1b7=this.featureLayer;if(!_1b7.timeInfo||_1b7.suspended){return;}if(!_1b6){_1b7._fireUpdateStart();}var _1b8=_1b7._trackManager;if(_1b8){_1b8.clearTracks();}var defn=_1b7.getTimeDefinition(),_1b9=_1b7._getOffsettedTE(_1b7._mapTimeExtent);if(_1b9){_1b9=_1b7._getTimeOverlap(defn,_1b9);if(_1b9){var _1ba=_1b7._filterByTime(_1b7.graphics,_1b9.startTime,_1b9.endTime);if(_1b8){_1b8.addFeatures(_1ba.match);}_2.forEach(_1ba.match,function(_1bb){var _1bc=_1bb._shape;if(!_1bb.visible){_1bb.show();_1bc=_1bb._shape;_1bc&&_1bc._moveToFront();}if(_1b7._ager&&_1bc){_1b7._repaint(_1bb);}});_2.forEach(_1ba.noMatch,function(_1bd){if(_1bd.visible){_1bd.hide();}});}else{this._toggleVisibility(false);}}else{if(_1b8){_1b8.addFeatures(_1b7.graphics);}this._toggleVisibility(true);}if(_1b8){_1b8.moveLatestToFront();_1b8.drawTracks();}if(!_1b6){_1b7._fireUpdateEnd();}}});_2.declare("esri.layers._SelectionMode",[esri.layers._RenderMode],{constructor:function(_1be){this.featureLayer=_1be;this._featureMap={};},initialize:function(map){this.map=map;this._init=true;},propertyChangeHandler:function(type){if(this._init&&type===0){this._applyTimeFilter();}},destroy:function(){this._init=false;},resume:function(){this.propertyChangeHandler(0);}});_2.declare("esri.layers._SnapshotMode",[esri.layers._RenderMode],{constructor:function(_1bf){this.featureLayer=_1bf;this._featureMap={};this._drawFeatures=_2.hitch(this,this._drawFeatures);this._queryErrorHandler=_2.hitch(this,this._queryErrorHandler);},initialize:function(map){this.map=map;var _1c0=this.featureLayer;if(_1c0._collection){this._applyTimeFilter();}else{this._fetchAll();}this._init=true;},propertyChangeHandler:function(type){if(this._init){if(type){if(this.featureLayer._collection){console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id = "+this.featureLayer.id);}else{this._fetchAll();}}else{this._applyTimeFilter();}}},destroy:function(){this._init=false;},drawFeature:function(_1c1){var _1c2=this.featureLayer,_1c3=_1c2.objectIdField,oid=_1c1.attributes[_1c3];this._addFeatureIIf(oid,_1c1);this._incRefCount(oid);},resume:function(){this.propertyChangeHandler(0);},refresh:function(){var _1c4=this.featureLayer;if(_1c4._collection){_1c4._fireUpdateStart();_1c4._refresh(true);_1c4._fireUpdateEnd();}else{this._fetchAll();}},_getRequestId:function(_1c5){var id="_"+_1c5.name+_1c5.layerId+_1c5._ulid;return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_fetchAll:function(){var _1c6=this.featureLayer;if(_1c6._collection){return;}_1c6._fireUpdateStart();this._clearIIf();this._sendRequest();},_sendRequest:function(){var map=this.map,_1c7=this.featureLayer,_1c8=_1c7.getDefinitionExpression();var _1c9=new esri.tasks.Query();_1c9.outFields=_1c7._getOutFields();_1c9.where=_1c8||"1=1";_1c9.returnGeometry=true;_1c9.outSpatialReference=new esri.SpatialReference(map.spatialReference.toJson());_1c9.timeExtent=_1c7.getTimeDefinition();_1c9.maxAllowableOffset=_1c7._maxOffset;if(_1c7._ts){_1c9._ts=(new Date()).getTime();}var _1ca;if(_1c7._usePatch){_1ca=this._getRequestId(_1c7);this._cancelPendingRequest(null,_1ca);}_1c7._task.execute(_1c9,this._drawFeatures,this._queryErrorHandler,_1ca);},_drawFeatures:function(_1cb){this._purgeRequests();var _1cc=_1cb.features,_1cd=this.featureLayer,_1ce=_1cd.objectIdField,i,len=_1cc.length,_1cf,oid;for(i=0;i<len;i++){_1cf=_1cc[i];oid=_1cf.attributes[_1ce];this._addFeatureIIf(oid,_1cf);this._incRefCount(oid);}this._applyTimeFilter(true);_1cd._fireUpdateEnd(null,_1cb.exceededTransferLimit?{queryLimitExceeded:true}:null);if(_1cb.exceededTransferLimit){_1cd.onQueryLimitExceeded();}},_queryErrorHandler:function(err){this._purgeRequests();var _1d0=this.featureLayer;_1d0._errorHandler(err);_1d0._fireUpdateEnd(err);}});_2.declare("esri.layers._OnDemandMode",[esri.layers._RenderMode],{constructor:function(_1d1){this.featureLayer=_1d1;this._featureMap={};this._queryErrorHandler=_2.hitch(this,this._queryErrorHandler);},initialize:function(map){this.map=map;this._initialize();this._init=true;},propertyChangeHandler:function(type){if(this._init){if(type<2){this._zoomHandler();}else{console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id = "+this.featureLayer.id+", Layer URL = "+this.featureLayer.url);}}},destroy:function(){this._disableConnectors();this._init=false;},drawFeature:function(_1d2){var _1d3=this._gridLayer,geom=_1d2.geometry,_1d4=[];if(!geom){return;}_1d4=_1d3.getCellsInExtent((geom.type==="point")?{xmin:geom.x,ymin:geom.y,xmax:geom.x,ymax:geom.y}:geom.getExtent(),false).cells;var _1d5=this._cellMap,i,cell,oid=_1d2.attributes[this.featureLayer.objectIdField],_1d6,row,col;for(i=0;i<_1d4.length;i++){cell=_1d4[i];_1d6=cell.latticeID;row=cell.row;col=cell.col;if(_1d6){cell=(_1d5[_1d6]=(_1d5[_1d6]||cell));}else{_1d5[row]=_1d5[row]||{};cell=(_1d5[row][col]=(_1d5[row][col]||cell));}cell.features=cell.features||[];cell.features.push(_1d2);this._addFeatureIIf(oid,_1d2);this._incRefCount(oid);}},suspend:function(){if(!this._init){return;}this._disableConnectors();},resume:function(){if(!this._init){return;}this._enableConnectors();this._zoomHandler();},refresh:function(){this._zoomHandler();},_initialize:function(){var map=this.map,_1d7=this.featureLayer;var _1d8=_1d7._srInfo;this._gridLayer=new esri.layers._GridLayout(new esri.geometry.Point(_1d8?_1d8.valid[0]:map.extent.xmin,map.extent.ymax,map.spatialReference),{width:_1d7._tileWidth,height:_1d7._tileHeight},{width:map.width,height:map.height},_1d8);this._ioQueue=[];if(!_1d7.suspended){this._zoomHandler();this._enableConnectors();}},_enableConnectors:function(){var map=this.map;this._zoomConnect=_2.connect(map,"onZoomEnd",this,this._zoomHandler);this._panConnect=_2.connect(map,"onPanEnd",this,this._panHandler);this._resizeConnect=_2.connect(map,"onResize",this,this._panHandler);},_disableConnectors:function(){_2.disconnect(this._zoomConnect);_2.disconnect(this._panConnect);_2.disconnect(this._resizeConnect);},_zoomHandler:function(){this._processIOQueue(true);var _1d9=this.featureLayer,map=this.map;if(_1d9.suspended){return;}_1d9._fireUpdateStart();this._clearIIf();var _1da=_1d9._trackManager;if(_1da){_1da.clearTracks();}this._cellMap={};this._gridLayer.setResolution(map.extent);this._sendRequest();},_panHandler:function(){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&arguments[0]);},_getRequestId:function(_1db,cell){var id="_"+_1db.name+_1db.layerId+_1db._ulid+"_"+cell.resolution+"_"+(cell.latticeID||(cell.row+"_"+cell.col));return id.replace(/[^a-zA-Z0-9\_]+/g,"_");},_sendRequest:function(_1dc){this._exceeds=false;var _1dd=this.featureLayer,map=this.map,_1de=_1dc||map.extent,_1df=this._gridLayer.getCellsInExtent(_1de,_1dd.latticeTiling),_1e0=_1df.cells;if(!_1dd.isEditable()){var _1e1=this._cellMap;_1e0=_2.filter(_1e0,function(cell){if(cell.lattice){if(_1e1[cell.latticeID]){return false;}}else{if(_1e1[cell.row]&&_1e1[cell.row][cell.col]){return false;}}return true;});}var _1e2=_1dd._getOutFields(),_1e3=_1dd.getDefinitionExpression(),time=_1dd._getOffsettedTE(_1dd._mapTimeExtent),_1e4=_1dd._usePatch,_1e5=this._ioQueue,i,self=this,func=this._drawFeatures,cell,_1e6,_1e7;this._pending=this._pending||0;for(i=0;i<_1e0.length;i++){cell=_1e0[i];_1e6=new esri.tasks.Query();_1e6.geometry=cell.extent||cell.lattice;_1e6.outFields=_1e2;_1e6.where=_1e3;if(_1dd.latticeTiling&&cell.extent){_1e6.spatialRelationship=esri.tasks.Query.SPATIAL_REL_CONTAINS;}_1e6.returnGeometry=true;_1e6.timeExtent=time;_1e6.maxAllowableOffset=_1dd._maxOffset;if(_1dd._ts){_1e6._ts=(new Date()).getTime();}_1e7=null;if(_1e4){_1e7=this._getRequestId(_1dd,cell);if(this._isPending(_1e7)){continue;}}this._pending++;_1e5.push(_1dd._task.execute(_1e6,function(){var _1e8=cell;return function(_1e9){func.apply(self,[_1e9,_1e8]);};}.call(this),this._queryErrorHandler,_1e7));}this._removeOldCells(_1de);this._endCheck();},_drawFeatures:function(_1ea,cell){this._exceeds=this._exceeds||_1ea.exceededTransferLimit;this._finalizeIO();var _1eb=this.featureLayer,map=this.map,_1ec=map.extent,_1ed=cell.extent,row=cell.row,col=cell.col,_1ee=_1eb.objectIdField,_1ef=_1ea.features,_1f0=this._gridLayer,_1f1=this._cellMap,i,len,_1f2=cell.latticeID,_1f3=_1f2?_1f1[_1f2]:(_1f1[row]&&_1f1[row][col]);if((cell.resolution!=_1f0._resolution)||(_1f2?(_1f2!==_1f0.getLatticeID(_1ec)):(!_1f0.intersects(_1ed,_1ec)))){if(_1f3){this._removeCell(row,col,_1f2);}}else{if(_1f3){this._updateCell(_1f3,_1ef);}else{cell.features=_1ef;if(_1f2){_1f1[_1f2]=cell;}else{_1f1[row]=_1f1[row]||{};_1f1[row][col]=cell;}len=_1ef.length;for(i=0;i<len;i++){var _1f4=_1ef[i];var oid=_1f4.attributes[_1ee];this._addFeatureIIf(oid,_1f4);this._incRefCount(oid);}}}this._endCheck();},_queryErrorHandler:function(err){this._finalizeIO();this.featureLayer._errorHandler(err);this._endCheck(true);},_finalizeIO:function(){this._purgeRequests();this._pending--;},_endCheck:function(_1f5){if(this._pending===0){this._processIOQueue();var _1f6=this.featureLayer,_1f7=_1f6._trackManager;if(_1f7){_1f7.clearTracks();_1f7.addFeatures(_1f6.graphics);if(_1f6._ager){_2.forEach(_1f6.graphics,function(_1f8){if(_1f8._shape){_1f6._repaint(_1f8);}});}_1f7.moveLatestToFront();_1f7.drawTracks();}this.featureLayer._fireUpdateEnd(_1f5&&new Error("FeatureLayer: "+esri.bundle.layers.FeatureLayer.updateError),this._exceeds?{queryLimitExceeded:true}:null);if(this._exceeds){_1f6.onQueryLimitExceeded();}}},_processIOQueue:function(_1f9){this._ioQueue=_2.filter(this._ioQueue,function(dfd){var keep=dfd.fired>-1?false:true;return keep;});if(_1f9){_2.forEach(this._ioQueue,this._cancelPendingRequest);}},_removeOldCells:function(_1fa){var _1fb=this._cellMap,_1fc=this._gridLayer,_1fd,_1fe;for(_1fd in _1fb){if(_1fb[_1fd]){var row=_1fb[_1fd],_1ff=row.latticeID,_200=0,_201=0;if(_1ff){_200++;if(_1ff!==_1fc.getLatticeID(_1fa)){this._removeCell(null,null,_1ff);_201++;}}else{for(_1fe in row){if(row[_1fe]){_200++;var _202=row[_1fe].extent;if(!_1fc.intersects(_202,_1fa)){this._removeCell(_1fd,_1fe);_201++;}}}}if(_201===_200){delete _1fb[_1fd];}}}},_updateCell:function(cell,_203){var _204=this.featureLayer,_205=_204.objectIdField,_206=_204._selectedFeatures,i,len=_203.length;cell.features=cell.features||[];for(i=0;i<len;i++){var _207=_203[i];var oid=_207.attributes[_205];var _208=this._addFeatureIIf(oid,_207);if(_208===_207){this._incRefCount(oid);cell.features.push(_208);}else{if(!(oid in _206)){_208.setGeometry(_207.geometry);_208.setAttributes(_207.attributes);}}}},_removeCell:function(row,col,_209){var _20a=this._cellMap,_20b=this.featureLayer,_20c=_20b.objectIdField;var cell=_209?_20a[_209]:(_20a[row]&&_20a[row][col]);if(cell){if(_209){delete _20a[_209];}else{delete _20a[row][col];}var _20d=cell.features,i;for(i=0;i<_20d.length;i++){var _20e=_20d[i];var oid=_20e.attributes[_20c];this._decRefCount(oid);if(oid in _20b._selectedFeatures){continue;}this._removeFeatureIIf(oid);}}}});_2.declare("esri.layers._GridLayout",null,{constructor:function(_20f,_210,_211,_212){this.origin=_20f;this.cellWidth=_210.width;this.cellHeight=_210.height;this.mapWidth=_211.width;this.mapHeight=_211.height;this.srInfo=_212;},setResolution:function(_213){this._resolution=(_213.xmax-_213.xmin)/this.mapWidth;if(this.srInfo){var _214=Math.round((2*this.srInfo.valid[1])/this._resolution),_215=Math.round(_214/this.cellWidth);this._frameStats=[_215,0,_215-1];}},getCellCoordinates:function(_216){var res=this._resolution,_217=this.origin;return {row:Math.floor((_217.y-_216.y)/(this.cellHeight*res)),col:Math.floor((_216.x-_217.x)/(this.cellWidth*res))};},normalize:function(col){var _218=this._frameStats;if(_218){var _219=_218[0],m180=_218[1],p180=_218[2];if(col<m180){col=col%_219;col=col<m180?col+_219:col;}else{if(col>p180){col=col%_219;}}}return col;},intersects:function(_21a,_21b){var _21c=this.srInfo;if(_21c){return _2.some(_21b._getParts(_21c),function(_21d){return _21a.intersects(_21d.extent);});}else{return _21a.intersects(_21b);}},getCellExtent:function(row,col){var res=this._resolution,_21e=this.origin,_21f=this.cellWidth,_220=this.cellHeight;return new esri.geometry.Extent((col*_21f*res)+_21e.x,_21e.y-((row+1)*_220*res),((col+1)*_21f*res)+_21e.x,_21e.y-(row*_220*res),new esri.SpatialReference(_21e.spatialReference.toJson()));},getLatticeID:function(_221){var _222=this.getCellCoordinates({x:_221.xmin,y:_221.ymax}),_223=this.getCellCoordinates({x:_221.xmax,y:_221.ymin}),_224=_222.row,_225=_223.row,_226=this.normalize(_222.col),_227=this.normalize(_223.col);return _224+"_"+_225+"_"+_226+"_"+_227;},sorter:function(a,b){return (a<b)?-1:1;},getCellsInExtent:function(_228,_229){var _22a=this.getCellCoordinates({x:_228.xmin,y:_228.ymax}),_22b=this.getCellCoordinates({x:_228.xmax,y:_228.ymin}),_22c=_22a.row,_22d=_22b.row,_22e=_22a.col,_22f=_22b.col,_230=[],i,j,nj,_231=[],_232=[],len,xmin,xmax,ymin,ymax,_233=[],_234,_235;for(i=_22c;i<=_22d;i++){for(j=_22e;j<=_22f;j++){nj=this.normalize(j);_228=this.getCellExtent(i,nj);_230.push({row:i,col:nj,extent:_228,resolution:this._resolution});if(_229){_231.push(_228.xmin,_228.xmax);_232.push(_228.ymin,_228.ymax);}}}_22e=this.normalize(_22e);_22f=this.normalize(_22f);_231.sort(this.sorter);_232.sort(this.sorter);len=_231.length;for(i=len-1;i>=0;i--){if(i<(len-1)){if(_231[i]===_231[i+1]){_231.splice(i,1);}}}len=_232.length;for(i=len-1;i>=0;i--){if(i<(len-1)){if(_232[i]===_232[i+1]){_232.splice(i,1);}}}if(_231.length&&_232.length){xmin=_231[0];xmax=_231[_231.length-1];ymin=_232[0];ymax=_232[_232.length-1];len=_231.length;for(i=0;i<len;i++){_233.push([[_231[i],ymax],[_231[i],ymin]]);}len=_232.length;for(i=0;i<len;i++){_233.push([[xmin,_232[i]],[xmax,_232[i]]]);}_234=new esri.geometry.Polyline({paths:_233,spatialReference:this.origin.spatialReference.toJson()});_235=_22c+"_"+_22d+"_"+_22e+"_"+_22f;_230.push({latticeID:_235,lattice:_234,resolution:this._resolution});}return {minRow:_22c,maxRow:_22d,minCol:_22e,maxCol:_22f,cells:_230};}});_2.declare("esri.layers._TrackManager",null,{constructor:function(_236){this.layer=_236;this.trackMap={};},initialize:function(map){this.map=map;var _237=this.layer,_238=_237.renderer.trackRenderer;if(_238&&(_237.geometryType==="esriGeometryPoint")){var _239=(this.container=new esri.layers._GraphicsLayer({id:_237.id+"_tracks",_child:true}));_239.loaded=true;_239.onLoad(_239);_239._setMap(map,_237._div);_239.setRenderer(_238);}},addFeatures:function(_23a){var tkid,_23b=this.trackMap,_23c=this.layer,_23d=_23c._trackIdField;_2.forEach(_23a,function(_23e){var _23f=_23e.attributes;tkid=_23f[_23d];var ary=(_23b[tkid]=(_23b[tkid]||[]));ary.push(_23e);});var _240=_23c._startTimeField,_241=_23c.objectIdField;var _242=function(a,b){var _243=a.attributes[_240],_244=b.attributes[_240];if(_243===_244){return (a.attributes[_241]<b.attributes[_241])?-1:1;}else{return (_243<_244)?-1:1;}};for(tkid in _23b){_23b[tkid].sort(_242);}},drawTracks:function(){var _245=this.container;if(!_245){return;}var _246=this.trackMap,sr=this.map.spatialReference,tkid,ary,path,i,_247,_248=this.layer._trackIdField,_249;for(tkid in _246){ary=_246[tkid];path=[];for(i=ary.length-1;i>=0;i--){_247=ary[i].geometry;if(_247){path.push([_247.x,_247.y]);}}_249={};_249[_248]=tkid;if(path.length>0){_245.add(new esri.Graphic(new esri.geometry.Polyline({paths:[path],spatialReference:sr}),null,_249));}}},moveLatestToFront:function(){_2.forEach(this.getLatestObservations(),function(_24a){var _24b=_24a._shape;_24b&&_24b._moveToFront();this._repaint(_24a,null,true);},this.layer);},getLatestObservations:function(){var _24c=[];if(!this.layer.renderer.latestObservationRenderer){return _24c;}var _24d=this.trackMap,tkid;for(tkid in _24d){var ary=_24d[tkid];_24c.push(ary[ary.length-1]);}return _24c;},clearTracks:function(){var _24e=this.getLatestObservations();this.trackMap={};var _24f=this.container;if(_24f){_24f.clear();}_2.forEach(_24e,function(_250){this._repaint(_250,null,true);},this.layer);},isLatestObservation:function(_251){var _252=this.layer._trackIdField;var _253=this.trackMap[_251.attributes[_252]];if(_253){return (_253[_253.length-1]===_251);}return false;},destroy:function(){var _254=this.container;if(_254){_254.clear();_254._unsetMap(this.map,this.layer._div);this.container=null;}this.map=null;this.layer=null;this.trackMap=null;}});});