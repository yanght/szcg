/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/layers/graphics",["dijit","dojo","dojox","dojo/require!esri/layers/layer,dojox/gfx,esri/graphic,esri/renderer"],function(_1,_2,_3){_2.provide("esri.layers.graphics");_2.require("esri.layers.layer");_2.require("dojox.gfx");_2.require("esri.graphic");_2.require("esri.renderer");_2.declare("esri.layers._GraphicsContainer",null,{_setMap:function(_4,_5){var es,_6=(this._connects=[]);this._map=_4;if(_3.gfx.renderer.toLowerCase().indexOf("canvas")!==-1){es=_2.create("div",{style:"overflow: visible; position: absolute;"},_5);this._surface={getEventSource:function(){return es;}};_6.push(_2.connect(es,"onmousedown",this,this._canvasDownHandler));_6.push(_2.connect(es,"onmouseup",this,this._canvasUpHandler));_6.push(_2.connect(es,"onclick",this,this._canvasClickHandler));esri.layers._GraphicsLayer.prototype._canvas=true;}else{var _7=(this._surface=_3.gfx.createSurface(_5,_4.width,_4.height));es=_7.getEventSource();_2.style((es=(_2.isIE<9)?es.parentNode:es),{overflow:"visible",position:"absolute"});}_6.push(_2.connect(_4,"onResize",this,"_onResizeHandler"));return es;},_onResizeHandler:function(_8,_9,_a){var es=this._surface.getEventSource(),_b=this._map,_c;if(_2.isIE<9){_2.style((es=es.parentNode),{width:_9+"px",height:_a+"px",clip:"rect(0px "+_9+"px "+_a+"px 0px)"});}_2.attr(es,"width",_9);_2.attr(es,"height",_a);if(!this._surface.declaredClass){_2.forEach(es.childNodes,function(_d){_2.attr(_d,"width",_9);_2.attr(_d,"height",_a);});}if(_b.loaded){if(!_b.graphics.suspended){_b.graphics._resized=true;}_2.forEach(_b.graphicsLayerIds,function(_e){_c=_b.getLayer(_e);if(!_c.suspended){_c._resized=true;}});}},_cleanUp:function(){_2.forEach(this._connects,_2.disconnect,_2);this._map=this._surface=null;},_processEvent:function(_f){var map=this._map;_f.screenPoint=new esri.geometry.ScreenPoint(_f.pageX-map.position.x,_f.pageY-map.position.y);_f.mapPoint=map.toMap(_f.screenPoint);},_canvasDownHandler:function(evt){this._processEvent(evt);this._downPt=evt.screenPoint.x+","+evt.screenPoint.y;},_canvasUpHandler:function(evt){this._processEvent(evt);this._upPt=evt.screenPoint.x+","+evt.screenPoint.y;},_tolerance:15,_canvasClickHandler:function(evt){if(!this._downPt||!this._upPt||this._downPt!==this._upPt){return;}this._processEvent(evt);var map=this._map,_10=_2.map(map.graphicsLayerIds,function(id){return map.getLayer(id);});_10.push(map.graphics);_10.reverse();_10=_2.filter(_10,function(_11){return _11.loaded&&_11._mouseEvents&&!_11.suspended&&(!esri._isDefined(_11.opacity)||_11.opacity>0);});var _12=evt.screenPoint,geo=esri.geometry,_13=this._tolerance,_14=_12.x-_13,_15=_12.y+_13,_16=_12.x+_13,_17=_12.y-_13,_18=new geo.Extent(_14,_17,_16,_15),_19=map.toMap(new geo.ScreenPoint(_14,_15)),_1a=map.toMap(new geo.ScreenPoint(_16,_17)),_1b=new geo.Extent(_19.x,_19.y,_1a.x,_1a.y,_19.spatialReference),_1c,_1d=esri.isTouchEnabled;delete _18.spatialReference;_2.some(_10,function(_1e){var _1f=_2.filter(_1e.graphics,function(_20){var _21=_20.getDojoShape();if(!_20.visible||!_21){return false;}var _22=_21.getTransformedBoundingBox();if(_22){var _23=new geo.Extent(_22[0].x,_22[0].y,_22[2].x,_22[2].y);delete _23.spatialReference;return _1d?_23.intersects(_18):_23.contains(_12);}else{return _2.some(_21.children||[],function(_24){_22=_24.getTransformedBoundingBox();var _25=new geo.Extent(_22[0].x,_22[0].y,_22[2].x,_22[2].y);delete _25.spatialReference;return _1d?_25.intersects(_18):_25.contains(_12);});}});_1f.reverse();if(_1f.length>0){var _26;_2.some(_1f,function(_27){if(_27.geometry&&_1b.intersects(_27.geometry)){_26=_27;return true;}return false;});if(_26){_1c=_26;return true;}}return false;});if(_1c){var _28=_1c.getLayer();if(_28){evt.graphic=_1c;_28.onClick(evt);}}}});_2.declare("esri.layers._GraphicsLayer",esri.layers.Layer,{constructor:function(_29){if(_29&&(_2.isString(_29)||(_2.isObject(_29)&&_29.layerDefinition))){_29=arguments[1];}this._params=_2.mixin({displayOnPan:true,drawMode:true},_29||{});this.infoTemplate=_29&&_29.infoTemplate;this.graphics=[];this._draw=_2.hitch(this,this._draw);this._refresh=_2.hitch(this,this._refresh);},setDrawMode:function(_2a){this._params.drawMode=_2a;},renderer:null,_setMap:function(map,_2b){this.inherited(arguments);this._map=map;if(!this._canvas){this._div=_2b.createGroup();}else{_2b=_3.gfx.createSurface(_2b.getEventSource(),map.width,map.height);_2.style(_2b.rawNode,"position","absolute");this._div=_2b.createGroup();this._renderProto=this._div.constructor.prototype._render;this._div._render=_2.hitch(this,this._canvasRender);}this._div.getEventSource().id=this.id+"_layer";this.evaluateSuspension();if(this.suspended&&!map.loaded){var _2c=_2.connect(map,"onLoad",this,function(){_2.disconnect(_2c);_2c=null;this.evaluateSuspension();});}var op=this.opacity;if(esri._isDefined(op)&&op<1){this.setOpacity(op,true);}return this._div;},_unsetMap:function(map,_2d){_2.forEach(this.graphics,function(g){g._shape=null;});if(!this._canvas){this._div.clear();_2d.remove(this._div);_2.destroy(this._div.getEventSource());}else{_2d=this._div.getParent();_2d._parent={};_2.destroy(_2d.rawNode);_2d.destroy();}this._map=this._div=null;clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors();this.inherited(arguments);},_onZoomStartHandler:function(){esri.hide(this._div.getEventSource());},_onExtentChangeHandler:function(_2e,_2f,_30,lod){clearTimeout(this._wakeTimer);this._wakeTimer=null;if(_30){var _31=this._map.__visibleRect,_32=this._div;this._refresh(true);_32.setTransform(_3.gfx.matrix.translate({x:_31.x,y:_31.y}));if(this._renderProto&&_32.surface.pendingRender){this._dirty=true;}else{if(!this.suspended){esri.show(_32.getEventSource());}}}else{if(this._resized){this._refresh(false);this._resized=false;}}if(this.graphics.length>0){this.onUpdate();}},_canvasRender:function(){var _33=this._div;if(this._dirty){delete this._dirty;if(!this.suspended){esri.show(_33.getEventSource());}}return this._renderProto.apply(_33,arguments);},_refresh:function(_34){var gs=this.graphics,il=gs.length,i,_35=this._draw;for(i=0;i<il;i++){_35(gs[i],_34);}},refresh:function(){this._refresh(true);},redraw:function(){this._refresh(true);},_onPanHandler:function(_36,_37){this._panDx=_37.x;this._panDy=_37.y;var _38=this._map.__visibleRect;this._div.setTransform(_3.gfx.matrix.translate({x:_38.x+_37.x,y:_38.y+_37.y}));},_onPanEndUpdateHandler:function(_39,_3a){if(!this._params._child&&(_3a.x!==this._panDx||_3a.y!==this._panDy)){var _3b=this._map.__visibleRect;this._div.setTransform(_3.gfx.matrix.translate({x:_3b.x,y:_3b.y}));}this._refresh(false);if(this.graphics.length){this.onUpdate();}},_onPanStartHandler:function(){esri.hide(this._div.getEventSource());},_onPanEndHandler:function(){var _3c=this._map.__visibleRect,_3d=this._div;_3d.setTransform(_3.gfx.matrix.translate({x:_3c.x,y:_3c.y}));this._refresh(false);if(this._renderProto&&_3d.surface.pendingRender){this._dirty=true;}else{esri.show(_3d.getEventSource());}if(this.graphics.length){this.onUpdate();}},onSuspend:function(){this.inherited(arguments);esri.hide(this._div.getEventSource());clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors();},onResume:function(evt){this.inherited(arguments);if(evt.firstOccurrence){this._wrap=this._map.wrapAround180;this._srInfo=this._map.spatialReference._getInfo();}this._enableDrawConnectors();this._wakeTimer=this._wakeTimer||setTimeout(_2.hitch(this,function(){if(!this.suspended){this._onExtentChangeHandler(null,null,true);}}),0);},_enableDrawConnectors:function(){var map=this._map,dc=_2.connect;this._disableDrawConnectors();if(this._params.displayOnPan){if(!this._params._child){this._onPanHandler_connect=dc(map,"onPan",this,"_onPanHandler");}this._onPanEndHandler_connect=dc(map,"onPanEnd",this,"_onPanEndUpdateHandler");}else{this._onPanStartHandler_connect=dc(map,"onPanStart",this,"_onPanStartHandler");this._onPanEndHandler_connect=dc(map,"onPanEnd",this,"_onPanEndHandler");}this._onZoomStartHandler_connect=dc(map,"onZoomStart",this,"_onZoomStartHandler");this._onExtentChangeHandler_connect=dc(map,"onExtentChange",this,"_onExtentChangeHandler");},_disableDrawConnectors:function(){var dd=_2.disconnect;dd(this._onExtentChangeHandler_connect);dd(this._onZoomStartHandler_connect);dd(this._onPanHandler_connect);dd(this._onPanStartHandler_connect);dd(this._onPanEndHandler_connect);this._onExtentChangeHandler_connect=this._onZoomStartHandler_connect=this._onPanHandler_connect=this._onPanStartHandler_connect=this._onPanEndHandler_connect=null;},_updateExtent:function(_3e){var _3f=_3e.geometry,_40=esri.geometry;if(!_3f){_3e._extent=null;return;}var _41=(_3e._extent=_3f.getExtent());if(!_41){var x,y;if(_3f instanceof _40.Point){x=_3f.x;y=_3f.y;}else{if(_3f instanceof _40.Multipoint){x=_3f.points[0][0];y=_3f.points[0][1];}else{_3e._extent=null;return;}}_3e._extent=new _40.Extent(x,y,x,y,_3f.spatialReference);}},_intersects:function(map,_42,_43){var _44=map.spatialReference,_45=_42.spatialReference,_46=(_44&&_45&&!_44.equals(_45)&&_44._canProject(_45)&&_45.wkid===4326);if(this._wrap&&!_43){var _47=[],_48=map._getFrameWidth(),_49=this._srInfo,_4a,_4b=map._clip?map._getAvailExtent():map.extent,_4c,g,m,f,gl,ml,fl,_4d,_4e,_4f=[],_50=_42._partwise;if(_46){_4b=map.geographicExtent;_49=_45._getInfo();}_4c=_4b._getParts(_49);if(_50&&_50.length){_4a=[];for(g=0,gl=_50.length;g<gl;g++){_4a=_4a.concat(_50[g]._getParts(_49));}}else{_4a=_42._getParts(_49);}for(g=0,gl=_4a.length;g<gl;g++){_4d=_4a[g];for(m=0,ml=_4c.length;m<ml;m++){_4e=_4c[m];if(_4e.extent.intersects(_4d.extent)){for(f=0,fl=_4d.frameIds.length;f<fl;f++){_47.push((_4e.frameIds[0]-_4d.frameIds[f])*_48);}}}}for(g=0,gl=_47.length;g<gl;g++){f=_47[g];if(_2.indexOf(_47,f)===g){_4f.push(f);}}return (_4f.length)?_4f:null;}else{return (_46?map.geographicExtent:map.extent).intersects(_42)?[0]:null;}},_draw:function(_51,_52){if(!this._params.drawMode||!this._map||this.suspended){return;}try{var _53=_51._extent,_54,_55;if(_51.visible&&_53&&(_54=this._intersects(this._map,_53,_51.geometry._originOnly))&&(_55=this._getSymbol(_51))){if(!_51.getDojoShape()||_52||_54){var _56=_51.geometry.type;if(_56==="point"){this._drawMarker(_51,_55,_54);this._symbolizeMarker(_51,_55);}else{if(_56==="multipoint"){this._drawMarkers(_51,_55,_54);this._symbolizeMarkers(_51,_55);}else{this._drawShape(_51,_54);this._symbolizeShape(_51,_55);}}}}else{if(_51.getDojoShape()){this._removeShape(_51);}}}catch(err){this._errorHandler(err,_51);}},_removeShape:function(_57){var _58=_57.getDojoShape();_58.removeShape();_57._shape=null;},_drawShape:function(_59,_5a){var _5b=_59.geometry,_5c=_5b.type,map=this._map,me=map.extent,mw=map.width,mh=map.height,_5d=esri.geometry,_5e=map.__visibleRect,_5f=[],i,il,_60,pt,xy,wh,_61=(_5c==="extent");if(_5c==="rect"||_61){pt={x:0,y:0,spatialReference:_5b.spatialReference};pt.x=_61?_5b.xmin:_5b.x;pt.y=_61?_5b.ymax:_5b.y;xy=_5d.toScreenPoint(me,mw,mh,pt);pt.x=_61?_5b.xmax:(_5b.x+_5b.width);pt.y=_61?_5b.ymin:(_5b.y+_5b.height);wh=_5d.toScreenPoint(me,mw,mh,pt);_60={x:xy.x-_5e.x+_5a[0],y:xy.y-_5e.y,width:Math.abs(wh.x-xy.x),height:Math.abs(wh.y-xy.y)};if(_60.width===0){_60.width=1;}if(_60.height===0){_60.height=1;}_59._shape=this._drawRect(this._div,_59.getDojoShape(),_60);}else{if(_5c==="polyline"||_5c==="polygon"){for(i=0,il=_5a.length;i<il;i++){_5f=_5f.concat(_5d._toScreenPath(me,mw,mh,_5b,-_5e.x+_5a[i],-_5e.y));}_59._shape=this._drawPath(this._div,_59.getDojoShape(),_5f);if(this._rendererLimits){if(_5c==="polyline"){this._clipPolyline(_59._shape,_5b);}else{this._clipPolygon(_59._shape,_5b);}}}}},_drawRect:function(_62,_63,_64){return _63?_63.setShape(_64):_62.createRect(_64);},_drawImage:function(_65,_66,_67){return _66?_66.setShape(_67):_65.createImage(_67);},_drawCircle:function(_68,_69,_6a){return _69?_69.setShape(_6a):_68.createCircle(_6a);},_drawPath:(function(){if(_2.isIE<9){return function(_6b,_6c,_6d){if(_6c){return _6c.setShape(_6d.join(" "));}else{var p=_6b.createObject(_3.gfx.EsriPath,_6d.join(" "));_6b._overrideSize(p.getEventSource());return p;}};}else{return function(_6e,_6f,_70){return _6f?_6f.setShape(_70.join(" ")):_6e.createPath(_70.join(" "));};}}()),_drawText:function(_71,_72,_73){return _72?_72.setShape(_73):_71.createText(_73);},_getSymbol:function(_74){return _74.symbol||(this.renderer?this.renderer.getSymbol(_74):null)||null;},_symbolizeShape:function(_75,_76){var _77=_76._stroke,_78=_76._fill;if(_77===null||_78===null){_77=_76.getStroke();_78=_76.getFill();}_75.getDojoShape().setStroke(_77).setFill(_78);_76._stroke=_77;_76._fill=_78;},_smsToPath:(function(){if(_2.isIE<9){return function(SMS,_79,x,y,xMh,xPh,yMh,yPh,_7a){switch(_79){case SMS.STYLE_SQUARE:return ["M",xMh+","+yMh,"L",xPh+","+yMh,xPh+","+yPh,xMh+","+yPh,"X","E"];case SMS.STYLE_CROSS:return ["M",x+","+yMh,"L",x+","+yPh,"M",xMh+","+y,"L",xPh+","+y,"E"];case SMS.STYLE_X:return ["M",xMh+","+yMh,"L",xPh+","+yPh,"M",xMh+","+yPh,"L",xPh+","+yMh,"E"];case SMS.STYLE_DIAMOND:return ["M",x+","+yMh,"L",xPh+","+y,x+","+yPh,xMh+","+y,"X","E"];case SMS.STYLE_TARGET:return ["M",xMh+","+yMh,"L",xPh+","+yMh,xPh+","+yPh,xMh+","+yPh,xMh+","+yMh,"M",(xMh-_7a)+","+y,"L",xMh+","+y,"M",x+","+(yMh-_7a),"L",x+","+yMh,"M",(xPh+_7a)+","+y,"L",xPh+","+y,"M",x+","+(yPh+_7a),"L",x+","+yPh,"E"];}};}else{return function(SMS,_7b,x,y,xMh,xPh,yMh,yPh,_7c){switch(_7b){case SMS.STYLE_SQUARE:return ["M",xMh+","+yMh,xPh+","+yMh,xPh+","+yPh,xMh+","+yPh,"Z"];case SMS.STYLE_CROSS:return ["M",x+","+yMh,x+","+yPh,"M",xMh+","+y,xPh+","+y];case SMS.STYLE_X:return ["M",xMh+","+yMh,xPh+","+yPh,"M",xMh+","+yPh,xPh+","+yMh];case SMS.STYLE_DIAMOND:return ["M",x+","+yMh,xPh+","+y,x+","+yPh,xMh+","+y,"Z"];case SMS.STYLE_TARGET:return ["M",xMh+","+yMh,xPh+","+yMh,xPh+","+yPh,xMh+","+yPh,xMh+","+yMh,"M",(xMh-_7c)+","+y,xMh+","+y,"M",x+","+(yMh-_7c),x+","+yMh,"M",(xPh+_7c)+","+y,xPh+","+y,"M",x+","+(yPh+_7c),x+","+yPh];}};}}()),_pathStyles:{"square":1,"cross":1,"x":1,"diamond":1,"target":1},_typeMaps:{"picturemarkersymbol":"image","textsymbol":"text"},_isInvalidShape:function(_7d,_7e){var _7f=_7e&&_7e.shape&&_7e.shape.type,_80=_7d&&_7d.type,_81=_7d&&_7d.style;if(!_81){if(_80){_81=this._typeMaps[_80];}}else{if(this._pathStyles[_81]){_81="path";}}if(_7f&&_81&&(_7f!==_81)){return true;}},_drawPoint:function(_82,_83,_84,_85,_86){var _87=_84.type,map=this._map,_88=map.__visibleRect,_89=esri.geometry.toScreenPoint(map.extent,map.width,map.height,_83).offset(-_88.x+_86[0],-_88.y),px=_89.x,py=_89.y,_8a;if(this._isInvalidShape(_84,_85)){_85.removeShape();_85=null;}if(_87==="simplemarkersymbol"){var _8b=_84.style,_8c=_84.size/2,_8d=Math.round,SMS=esri.symbol.SimpleMarkerSymbol;switch(_8b){case SMS.STYLE_SQUARE:case SMS.STYLE_CROSS:case SMS.STYLE_X:case SMS.STYLE_DIAMOND:_8a=this._drawPath(_82,_85,this._smsToPath(SMS,_8b,px,py,_8d(px-_8c),_8d(px+_8c),_8d(py-_8c),_8d(py+_8c)));break;case SMS.STYLE_TARGET:var _8e=_84._targetWidth/2,_8f=_84._targetHeight/2;_8a=this._drawPath(_82,_85,this._smsToPath(SMS,_8b,px,py,_8d(px-_8e),_8d(px+_8e),_8d(py-_8f),_8d(py+_8f),_84._spikeSize));break;default:_8a=this._drawCircle(_82,_85,{cx:px,cy:py,r:_8c});}}else{if(_87==="picturemarkersymbol"){var w=_84.width,h=_84.height;_8a=this._drawImage(_82,_85,{x:px-(w/2),y:py-(h/2),width:w,height:h,src:_84.url});}else{if(_87==="textsymbol"){_8a=this._drawText(_82,_85,{type:"text",text:_84.text,x:px,y:py,align:_84.align,decoration:_84.decoration,rotated:_84.rotated,kerning:_84.kerning});}}}_8a.setTransform(_3.gfx.matrix.multiply(_3.gfx.matrix.translate(_84.xoffset,-_84.yoffset),_3.gfx.matrix.rotategAt(_84.angle,_89)));_8a._wrapOffsets=_86;return _8a;},_symbolizePoint:function(_90,_91){var _92=_91.type;if(_92==="picturemarkersymbol"){return;}var _93=_91._stroke,_94=_91._fill;if(_92==="textsymbol"){_90.setFont(_91.font).setFill(_91.getFill());}else{if(_93===null||_94===null){_93=_91.getStroke();_94=_91.getFill();}if(_92==="simplemarkersymbol"){_90.setFill(_94).setStroke(_93);}_91._stroke=_93;_91._fill=_94;}},_drawMarker:function(_95,_96,_97){_95._shape=this._drawPoint(this._div,_95.geometry,_96,_95.getDojoShape(),_97);},_symbolizeMarker:function(_98,_99){this._symbolizePoint(_98.getDojoShape(),_99);},_drawMarkers:function(_9a,_9b,_9c){var _9d=_9a.geometry,_9e=_9d.points,_9f=_9a.getDojoShape()||this._div.createGroup(),_a0,i,il=_9e.length,_a1=[],idx=0,j,jl=_9c?_9c.length:0;if(_9f.children[0]&&this._isInvalidShape(_9b,_9f.children[0])){_9f.clear();}for(i=0;i<il;i++){_a0=_9e[i];for(j=0;j<jl;j++){_a1[0]=_9c[j];this._drawPoint(_9f,{x:_a0[0],y:_a0[1],spatialReference:_9d.spatialReference},_9b,_9f.children[idx++],_a1);}}var _a2=_9f.children.length;if(il*_9c.length<_a2){for(i=_a2-1;i>=il*_9c.length;i--){_9f.children[i].removeShape();}}_9a._shape=_9f;},_symbolizeMarkers:function(_a3,_a4){var _a5=_a3.getDojoShape(),_a6=_a5.children,i,il=_a6.length;for(i=0;i<il;i++){this._symbolizePoint(_a6[i],_a4);}},_errorHandler:function(err,_a7){var msg=esri.bundle.layers.graphics.drawingError;if(_a7){err.message=msg+"(geometry:"+(_a7.geometry?_a7.geometry.declaredClass:null)+", symbol:"+(_a7.symbol?_a7.symbol.declaredClass:null)+"): "+err.message;}else{err.message=msg+"(null): "+err.message;}this.inherited(arguments);},_rendererLimits:(function(){var _a8,_a9,_aa;if(_2.isFF){_a8=16125;_a9=-32250;_aa=32250;}else{if(_2.isIE<9){_a8=100000;_a9=-100000;_aa=100000;}else{if(_2.isChrome&&_2.isChrome<6){_a8=8150;_a9=-10000;_aa=10000;}}}if(_a8){var _ab,_ac;_ab=[-_a8,-_a8,_a8,_a8];_ac=[[[-_a8,-_a8],[_a8,-_a8]],[[_a8,-_a8],[_a8,_a8]],[[_a8,_a8],[-_a8,_a8]],[[-_a8,_a8],[-_a8,-_a8]]];return {clipLimit:_a8,rangeMin:_a9,rangeMax:_aa,clipBBox:_ab,clipSegments:_ac};}}()),_clipPolyline:function(_ad,_ae){var _af=this._getCorners(_ad,_ae);var _b0=_af.tl,_b1=_af.br;var _b2=this._rendererLimits;var _b3=_b2.rangeMin,_b4=_b2.rangeMax,_b5=_b2.clipBBox,_b6=_b2.clipSegments;var _b7=this._isPointWithinRange,_b8=this._isPointWithinBBox,_b9=this._getClipperIntersection,_ba=this._getPlaneIndex;if(!_b7(_b0,_b3,_b4)||!_b7(_b1,_b3,_b4)){if(_2.isIE<9){this._createSegments(_ad);}var _bb=[];_2.forEach(_ad.segments,function(_bc){var _bd=_bc.args,len=_bd.length,_be=[],i;for(i=0;i<len;i+=2){var pt1=[_bd[i],_bd[i+1]];var pt2=[_bd[i+2],_bd[i+3]];var _bf=_b8(pt1,_b5);var _c0=_b8(pt2,_b5);if(_bf^_c0){var _c1=_b9([pt1,pt2],_b6);if(_c1){if(!_bf){_be.push(_c1[1],pt2);}else{if(i){_be.push(_c1[1]);}else{_be.push(pt1,_c1[1]);}_bb.push(_be);_be=[];}}}else{if(_bf){if(i){_be.push(pt2);}else{_be.push(pt1,pt2);}}else{var _c2=_ba(pt1,_b5);var _c3=_ba(pt2,_b5);if(_c2===-1||_c3===-1||_c2===_c3){continue;}var _c4=_b9([pt1,pt2],_b6,true);if(_c4.length>0){if(!_c4[_c2]){_c2=_c4[_c2[0]]?_c2[0]:_c2[1];}if(!_c4[_c3]){_c3=_c4[_c3[0]]?_c3[0]:_c3[1];}var _c5=_c4[_c2],_c6=_c4[_c3];if(_c5){_be.push(_c5);}if(_c6){_be.push(_c6);_bb.push(_be);_be=[];}}}}}_bb.push(_be);});_ad.setShape(this._getPathStringFromPaths(_bb));}},_clipPolygon:function(_c7,_c8){var _c9=this._getCorners(_c7,_c8);var _ca=_c9.tl,_cb=_c9.br;var _cc=this._rendererLimits;var _cd=_cc.clipLimit,_ce=_cc.rangeMin,_cf=_cc.rangeMax,_d0=_cc.clipBBox,_d1=_cc.clipSegments;var _d2=this._isPointWithinRange,_d3=this._isPointWithinBBox,_d4=this._getClipperIntersection,_d5=this._getPlaneIndex,_d6=esri.geometry._pointLineDistance;if(!_d2(_ca,_ce,_cf)||!_d2(_cb,_ce,_cf)){if(_2.isIE<9){this._createSegments(_c7);}var _d7=_2.map(_c7.segments,function(_d8){var _d9=_d8.args,len=_d9.length,_da=[],_db=[],i;for(i=0;i<len;i+=2){var pt1=[_d9[i],_d9[i+1]];var pt2=[_d9[i+2],_d9[i+3]];if(i===(len-2)){_da.push(pt1);break;}var _dc=_d3(pt1,_d0);var _dd=_d3(pt2,_d0);_da.push(pt1);if(_dc^_dd){var _de=_d4([pt1,pt2],_d1);if(_de){var _df=_de[1];_df[_dc?"inOut":"outIn"]=true;_da.push(_df);_db.push([_dc?"INOUT":"OUTIN",_da.length-1,_de[0]]);}}else{if(!_dc){var _e0=_d5(pt1,_d0);var _e1=_d5(pt2,_d0);if(_e0===-1||_e1===-1||_e0===_e1){continue;}var _de=_d4([pt1,pt2],_d1,true);if(_de.length>0){if(!_de[_e0]){_e0=_de[_e0[0]]?_e0[0]:_e0[1];}if(!_de[_e1]){_e1=_de[_e1[0]]?_e1[0]:_e1[1];}var _e2=_de[_e0],_e3=_de[_e1];if(_e2){_e2.outIn=true;_da.push(_e2);_db.push(["OUTIN",_da.length-1,_e0]);}if(_e3){_e3.inOut=true;_da.push(_e3);_db.push(["INOUT",_da.length-1,_e1]);}}else{if(_2.isArray(_e0)&&_2.isArray(_e1)){var _e4=_e0.concat(_e1);_e4.sort();if(_e4.join("")==="0123"){var _e5=[];if((_e0[0]+_e0[1])===3){_e5.push([_cd,-_cd],[-_cd,_cd]);}else{_e5.push([-_cd,-_cd],[_cd,_cd]);}var d1=_d6(_e5[0],[pt1,pt2]);var d2=_d6(_e5[1],[pt1,pt2]);_da.push((d1<d2)?_e5[0]:_e5[1]);}}}}}}var _e6=_d0[0],_e7=_d0[1],_e8=_d0[2],_e9=_d0[3];_2.forEach(_da,function(_ea){if(_ea[0]<_e6){if(_ea[1]>=_e7&&_ea[1]<=_e9){_ea[0]=_e6;}else{_ea[0]=_e6;_ea[1]=_ea[1]<_e7?_e7:_e9;}}});_2.forEach(_da,function(_eb){if(_eb[1]<_e7){if(_eb[0]>=_e6&&_eb[0]<=_e8){_eb[1]=_e7;}else{_eb[1]=_e7;_eb[0]=_eb[0]<_e6?_e6:_e8;}}});_2.forEach(_da,function(_ec){if(_ec[0]>_e8){if(_ec[1]>=_e7&&_ec[1]<=_e9){_ec[0]=_e8;}else{_ec[0]=_e8;_ec[1]=_ec[1]<_e7?_e7:_e9;}}});_2.forEach(_da,function(_ed){if(_ed[1]>_e9){if(_ed[0]>=_e6&&_ed[0]<=_e8){_ed[1]=_e9;}else{_ed[1]=_e9;_ed[0]=_ed[0]<_e6?_e6:_e8;}}});var k=0,len=_db.length;if(len>0){do{var _ee=_db[k];var _ef=_db[(k+1)%len];if(_ee[2]===_ef[2]&&_ee[0]==="INOUT"&&_ef[0]==="OUTIN"){var _f0=_ee[1],end=_ef[1],u;if(_f0<end){for(u=_f0+1;u<end;u++){_da[u][2]=true;}}else{if(_f0>end){for(u=_f0+1;u<_da.length;u++){_da[u][2]=true;}for(u=0;u<end;u++){_da[u][2]=true;}}}}k=(k+1)%len;}while(k!==0);}var _f1=_da[0],_f2=_da[_da.length-1];if(_f1[2]){_f2[2]=true;_2.some(_db,function(_f3){if(_f3[1]===1){_da.splice(_da.length-1,0,_2.clone(_da[1]));return true;}return false;});}_da=_2.filter(_da,function(_f4){return _f4[2]?false:true;});for(k=0;k<_da.length-1;k++){var now=_da[k];var _ef=_da[k+1];if(!_ef||(now[0]!==_ef[0])||(now[1]!==_ef[1])){continue;}if(_ef.outIn){now.outIn=true;}else{if(_ef.inOut){now.inOut=true;}}_da.splice(k+1,1);}var abs=Math.abs,_f5=[];for(k=0;k<_da.length-1;k++){var _ee=_da[k],cx=_ee[0],cy=_ee[1];var x1=(abs(cx)===_cd);var y1=(abs(cy)===_cd);var _ef=_da[k+1],nx=_ef[0],ny=_ef[1];var x2=(abs(nx)===_cd);var y2=(abs(ny)===_cd);if(x1&&y2){_f5.push([k+1,[cx,ny]]);}else{if(y1&&x2){_f5.push([k+1,[nx,cy]]);}}}for(k=_f5.length-1;k>=0;k--){var _f6=_f5[k];var _f7=_da[_f6[0]-1];var now=_da[_f6[0]];if(_f7.outIn||_f7.inOut||now.outIn||now.inOut){continue;}_da.splice(_f6[0],0,_f6[1]);}var _f1=_da[0],_f2=_da[_da.length-1];if(_f1[0]!==_f2[0]||_f1[1]!==_f2[1]){_da.push(_f1);}return _da;});_c7.setShape(this._getPathStringFromPaths(_d7));}},_getCorners:function(_f8,_f9){if(_2.isIE<9){var map=this._map,_fa=_f9.getExtent(),_fb=_fa.spatialReference,_fc=map.toScreen(new esri.geometry.Point(_fa.xmin,_fa.ymax,_fb)),_fd=map.toScreen(new esri.geometry.Point(_fa.xmax,_fa.ymin,_fb));return {tl:_fc,br:_fd};}else{var _fe=_f8.getTransformedBoundingBox();return {tl:_fe[0],br:_fe[2]};}},_createSegments:function(_ff){_ff.shape.path=_ff.vmlPath;_ff.segmented=false;_ff._confirmSegmented();var _100=_ff.segments;if(_100.length>1){_ff.segments=_2.filter(_100,function(_101,idx,arr){var next=arr[idx+1];if(_101.action==="M"&&next&&next.action==="L"){_101.args=_101.args.concat(next.args);return true;}return false;});}},_getPathStringFromPaths:function(_102){if(_2.isIE<9){_102=_2.map(_102,function(path){var _103=_2.map(path,function(_104,idx){return (idx===1?"l ":"")+_104.join(",");});return "m "+_103.join(" ");});_102.push("e");}else{_102=_2.map(_102,function(path){var _105=_2.map(path,function(_106){return _106.join(",");});return "M "+_105.join(" ");});}return _102.join(" ");},_isPointWithinBBox:function(_107,bbox){var left=bbox[0],top=bbox[1];var _108=bbox[2],_109=bbox[3];var x=_107[0],y=_107[1];if(x>left&&x<_108&&y>top&&y<_109){return true;}else{return false;}},_isPointWithinRange:function(_10a,_10b,_10c){var x=_10a.x,y=_10a.y;if(x<_10b||y<_10b||x>_10c||y>_10c){return false;}else{return true;}},_getClipperIntersection:function(line,_10d,_10e){var i,_10f=esri.geometry._getLineIntersection2,_110=Math.round,data={length:0};for(i=0;i<4;i++){var _111=_10f(line,_10d[i]);if(_111){_111[0]=_110(_111[0]);_111[1]=_110(_111[1]);if(!_10e){return [i,_111];}else{data[i]=_111;data.length++;}}}return _10e?data:null;},_getPlaneIndex:function(_112,_113){var px=_112[0],py=_112[1],xmin=_113[0],ymin=_113[1],xmax=_113[2],ymax=_113[3];if(px<=xmin){if((py>=ymin)&&(py<=ymax)){return 3;}else{return (py<ymin)?[0,3]:[2,3];}}if(py<=ymin){if((px>=xmin)&&(px<=xmax)){return 0;}else{return (px<xmin)?[3,0]:[1,0];}}if(px>=xmax){if((py>=ymin)&&(py<=ymax)){return 1;}else{return (py<ymin)?[0,1]:[2,1];}}if(py>=ymax){if((px>=xmin)&&(px<=xmax)){return 2;}else{return (px<xmin)?[3,2]:[1,2];}}return -1;},onGraphicAdd:function(){},onGraphicRemove:function(){},onGraphicsClear:function(){},onOpacityChange:function(){},setInfoTemplate:function(_114){this.infoTemplate=_114;},add:function(_115){var _116=arguments[1];if(_115._graphicsLayer===this){return _115;}if(!_116){this.graphics.push(_115);}_115._graphicsLayer=this;this._updateExtent(_115);this._draw(_115);if(!_116){this.onGraphicAdd(_115);}return _115;},remove:function(_117){if(!arguments[1]){var _118=this.graphics,i;if((i=_2.indexOf(_118,_117))===-1){return null;}_117=this.graphics.splice(i,1)[0];}if(_117.getDojoShape()){this._removeShape(_117);}_117._shape=_117._graphicsLayer=null;this.onGraphicRemove(_117);return _117;},clear:function(){var _119=arguments[1],g=this.graphics;while(g.length>0){this.remove(g[0]);}if(!_119){this.onGraphicsClear();}},setOpacity:function(op,_11a){if(_11a||this.opacity!=op){var div=this._div;if(div){if(_2.isIE<9){_2.forEach(this.graphics,function(_11b){var _11c=_11b._shape;var node=_11c&&_11c.getNode();if(node){var _11d=_11c.strokeStyle,_11e=node.stroke;if(_11d&&_11e){_11e.opacity=_11d.color.a*op;}var _11f=_11c.fillStyle,fill=node.fill;if(_11f&&fill){if(fill.type==="tile"){_2.style(node,"opacity",op);}else{fill.opacity=_11f.a*op;}}}});div._esriIeOpacity=op;}else{if(this._canvas){_2.style(div.getEventSource(),"opacity",op);}else{div.getEventSource().setAttribute("opacity",op);}}}this.opacity=op;if(!_11a){this.onOpacityChange(op);}}},setRenderer:function(ren){this.renderer=ren;}});_2.declare("esri.layers.GraphicsLayer",esri.layers._GraphicsLayer,{constructor:function(){this.enableMouseEvents=_2.hitch(this,this.enableMouseEvents);this.disableMouseEvents=_2.hitch(this,this.disableMouseEvents);this._processEvent=_2.hitch(this,this._processEvent);this._initLayer();},_initLayer:function(){this.loaded=true;this.onLoad(this);},_setMap:function(){var d=this.inherited("_setMap",arguments);this.enableMouseEvents();return d;},_unsetMap:function(){this.disableMouseEvents();this.inherited("_unsetMap",arguments);},_processEvent:function(evt){var _120=this._map,g=this.graphics,gl=g.length;evt.screenPoint=new esri.geometry.ScreenPoint(evt.pageX-_120.position.x,evt.pageY-_120.position.y);evt.mapPoint=_120.toMap(evt.screenPoint);var i,es,gr,ds,_121=evt.target,_122=_121.parentNode;for(i=0;i<gl;i++){gr=g[i];ds=gr.getDojoShape();if(ds){es=ds.getEventSource();if(es===_121||es===_122){evt.graphic=gr;return evt;}}}},_onMouseOverHandler:function(evt){if(this._processEvent(evt)){this.onMouseOver(evt);}},_onMouseMoveHandler:function(evt){if(this._processEvent(evt)){this.onMouseMove(evt);}},_onMouseDragHandler:function(evt){if(this._processEvent(evt)){this.onMouseDrag(evt);}},_onMouseOutHandler:function(evt){if(this._processEvent(evt)){this.onMouseOut(evt);}},_onMouseDownHandler:function(evt){this._downGr=this._downPt=null;if(this._processEvent(evt)){_2.disconnect(this._onmousemove_connect);_2.disconnect(this._onmousedrag_connect);this._onmousedrag_connect=_2.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseDragHandler");this._downGr=evt.graphic;this._downPt=evt.screenPoint.x+","+evt.screenPoint.y;this.onMouseDown(evt);}},_onMouseUpHandler:function(evt){this._upGr=this._upPt=null;if(this._processEvent(evt)){_2.disconnect(this._onmousedrag_connect);_2.disconnect(this._onmousemove_connect);this._onmousemove_connect=_2.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseMoveHandler");this._upGr=evt.graphic;this._upPt=evt.screenPoint.x+","+evt.screenPoint.y;this.onMouseUp(evt);}},_onClickHandler:function(evt){if(this._processEvent(evt)){var _123=this._downGr,upGr=this._upGr;if(_123&&upGr&&_123===upGr&&this._downPt===this._upPt){if(_2.isIE<9){esri.layers.GraphicsLayer._clicked=evt.graphic;}this.onClick(evt);}}},_onDblClickHandler:function(evt){if(this._processEvent(evt)){this.onDblClick(evt);}},onMouseOver:function(){},onMouseMove:function(){},onMouseDrag:function(){},onMouseOut:function(){},onMouseDown:function(){},onMouseUp:function(){},onClick:function(){},onDblClick:function(){},enableMouseEvents:function(){if(this._mouseEvents){return;}var dc=_2.connect,gc=this._div.getEventSource();if(_3.gfx.renderer.toLowerCase().indexOf("canvas")===-1){this._onmouseover_connect=dc(gc,"onmouseover",this,"_onMouseOverHandler");this._onmousemove_connect=dc(gc,"onmousemove",this,"_onMouseMoveHandler");this._onmouseout_connect=dc(gc,"onmouseout",this,"_onMouseOutHandler");this._onmousedown_connect=dc(gc,"onmousedown",this,"_onMouseDownHandler");this._onmouseup_connect=dc(gc,"onmouseup",this,"_onMouseUpHandler");this._onclick_connect=dc(gc,"onclick",this,"_onClickHandler");this._ondblclick_connect=dc(gc,"ondblclick",this,"_onDblClickHandler");}this._mouseEvents=true;},disableMouseEvents:function(){if(!this._mouseEvents){return;}var ddc=_2.disconnect;ddc(this._onmouseover_connect);ddc(this._onmousemove_connect);ddc(this._onmousedrag_connect);ddc(this._onmouseout_connect);ddc(this._onmousedown_connect);ddc(this._onmouseup_connect);ddc(this._onclick_connect);ddc(this._ondblclick_connect);this._mouseEvents=false;}});});