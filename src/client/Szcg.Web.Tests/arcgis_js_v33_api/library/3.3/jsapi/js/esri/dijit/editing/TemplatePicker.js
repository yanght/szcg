/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/editing/TemplatePicker",["dijit","dojo","dojox","dojo/require!dojo/data/ItemFileReadStore,dojox/grid/DataGrid,dijit/_Widget,dijit/_Templated,dojox/gfx,esri/utils,esri/symbol"],function(_1,_2,_3){_2.provide("esri.dijit.editing.TemplatePicker");_2.require("dojo.data.ItemFileReadStore");_2.require("dojox.grid.DataGrid");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dojox.gfx");_2.require("esri.utils");_2.require("esri.symbol");_2.declare("esri.dijit.editing.TemplatePicker",[_1._Widget,_1._Templated],{widgetsInTemplate:true,templateString:"<div class=\"templatePicker\">\r\n\r\n  <table dojoType=\"dojox.grid.DataGrid\" noDataMessage=\"${emptyMessage}\" selectionMode=\"none\" autoHeight=\"${_rows}\" autoWidth=\"${_autoWidth}\"\r\n         query=\"{ query: '*' }\" dojoAttachPoint=\"grid\" class=\"grid\">\r\n  </table>\r\n  \r\n</div>",basePath:_2.moduleUrl("esri.dijit.editing"),featureLayers:null,items:null,grouping:true,showTooltip:false,maxLabelLength:0,rows:4,columns:3,surfaceWidth:30,surfaceHeight:30,emptyMessage:"",useLegend:true,legendCache:{},_uniqueId:{id:0},_assumedCellWidth:90,_initialAutoWidth:300,_initialAutoHeight:200,_ieTimer:150,constructor:function(_4,_5){_4=_4||{};if(!_4.items&&!_4.featureLayers){console.error("TemplatePicker: please provide 'featureLayers' or 'items' parameter in the constructor");}this._dojo14x=(_2.version.minor>=4);this._itemWidgets={};if(_4.featureLayers&&_4.featureLayers.length){this._flChanged=1;}this._nls=_2.getObject("bundle.widgets.templatePicker",false,esri);this.emptyMessage=_4.emptyMessage||(this._nls&&this._nls.creationDisabled)||"";},postMixInProperties:function(){this.inherited(arguments);this._preprocess();},startup:function(){this.inherited(arguments);if(this.rows==="auto"&&this.columns==="auto"){var _6=_2.contentBox(this.domNode);if(!_6.w){this.domNode.style.width=this._initialAutoWidth+"px";}if(!_6.h){this.domNode.style.height=this._initialAutoHeight+"px";}_6=_2.contentBox(this.domNode);this._columns=Math.floor(_6.w/this._assumedCellWidth)||1;}this._applyGridPatches();this._setGridLayout();_2.connect(this.grid,"onRowClick",this,this._rowClicked);this._setGridData();this._toggleTooltip();if(_2.isIE<9){this._repaintItems=_2.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this.showTooltip=false;this._toggleTooltip();this._clearLegendInfo();this.featureLayers=this.items=this.grid=this._flItems=this._itItems=this._groupRowIndices=this._selectedCell=this._selectedInfo=this._selectedItem=null;this.inherited(arguments);},getSelected:function(){return this._selectedCell?this._selectedItem:null;},clearSelection:function(){var _7=this._selectedCell,_8=this._selectedInfo;if(_7){this._rowClicked({cellNode:_7,rowIndex:_8.selRow,cellIndex:_8.selCol});}},update:function(_9){var _a=(this.rows==="auto"&&this.columns==="auto"&&_9)?true:false,_b=this.grid,_c;if(_a){var _d=this.domNode,id=_d.id,_e,_f=_2.query("#"+id+".templatePicker div.item")[0];_c=_2.contentBox(_d);_f=_f&&_f.parentNode;if(_f){_e=_2.coords(_f).w;}else{_e=this._assumedCellWidth;}this._columns=Math.floor((_c.w-_b.views.views[0].getScrollbarWidth())/_e);this._columns=this._columns||1;}var _10=this._rows;this._preprocess();var _11=this._rows;this._setGridLayout();this._setGridData();if(_11!==_10){_b.set("autoHeight",this._rows,false);}if(_a){_b._resize({w:_c.w,h:_c.h});_b.viewsHeaderNode.style.display="none";}else{_b.update();}this._toggleTooltip();var _12=this,_13=this.getSelected();if(_13){_b.store.fetch({onComplete:function(its){var _14=_12._locate(_13,_12._selectedInfo,its);var _15=_14&&_b.views.views[0].getCellNode(_14[0],_14[1]);if(_15){_12._rowClicked({cellNode:_15,rowIndex:_14[0],cellIndex:_14[1]},true);}}});}if(_2.isIE<9){setTimeout(this._repaintItems,this._ieTimer);}var _16=this.featureLayers,_17=this.items;if((!_16||!_16.length)&&(!_17||!_17.length)&&_b&&this.emptyMessage){_b.showMessage(this.emptyMessage);}},onSelectionChange:function(){},_setUseLegendAttr:function(use){var _18=this.useLegend;if(!this._started||_18!==use){if(use){this._flChanged=1;}else{this._clearLegendInfo();}}this.useLegend=use;},_setFeatureLayersAttr:function(_19){var _1a=this.featureLayers;if(!this._started||_1a!==_19){this._flChanged=1;}this.featureLayers=_19;},_preprocess:function(){if(this.items){this.grouping=false;}this._autoWidth=false;if(this.rows==="auto"||this.columns==="auto"){this._autoWidth=true;}var _1b;if(this.featureLayers){if(this.useLegend&&this._flChanged){this._legendIndices=[];this._loadingIndices=[];this._legendSymbols={};this._ignoreLegends();this._loadingLegends=[];clearTimeout(this._legendTimer);this._legendTimer=null;this._processSelectionLayers();this._flChanged=0;}_1b=this._flItems=this._getItemsFromLayers(this.featureLayers);}else{_1b=this._itItems=this._getItemsFromItems(this.items);}if(this.rows==="auto"&&this.columns==="auto"){if(!this._started){this._rows=false;this._columns=null;this._autoWidth=false;}return;}var len=0;this._rows=this.rows;this._columns=this.columns;if(this.rows==="auto"){if(this.featureLayers){if(this.grouping){len=_1b.length;_2.forEach(_1b,function(_1c){len+=Math.ceil(_1c.length/this.columns);},this);}else{_2.forEach(_1b,function(_1d){len+=_1d.length;},this);len=Math.ceil(len/this.columns);}}else{len=Math.ceil(_1b.length/this.columns);}this._rows=len;}else{if(this.columns==="auto"){if(this.featureLayers){if(this.grouping){len=3;}else{_2.forEach(_1b,function(_1e){len+=_1e.length;},this);len=Math.ceil(len/this.rows);}}else{len=Math.ceil(_1b.length/this.rows);}this._columns=len;}}},_processSelectionLayers:function(){var map,_1f,_20,_21,key,_22,_23,_24={};_2.forEach(this.featureLayers,function(_25,idx){if(_25.mode===esri.layers.FeatureLayer.MODE_SELECTION&&_25._map&&_25.url&&_25._params.drawMode&&!_25.source){_1f=_2.trim(_25._url.path).replace(/\/(MapServer|FeatureServer).*/ig,"/MapServer").replace(/^https?:\/\//ig,"").toLowerCase();_20=(_24[_1f]=_24[_1f]||{});_21=(_20.featureLayers=_20.featureLayers||{});_22=(_20.indices=_20.indices||[]);_21[idx]=_25;_22.push(idx);map=_25._map;}});if(map){_2.forEach(map.layerIds,function(_26){_26=map.getLayer(_26);if(_26&&_26.url&&(_26.getImageUrl||_26.getTileUrl)&&_26.loaded&&_26.version>=10.1){_1f=_2.trim(_26._url.path).replace(/(\/MapServer).*/ig,"$1");key=_1f.replace(/^https?:\/\//ig,"").toLowerCase();if(_24[key]&&(!_24[key].mapServiceUrl)){_20=_24[key];_20.mapServiceUrl=_1f;_20.mapServiceLayer=_26;this._legendIndices=this._legendIndices.concat(_20.indices);_23=this._fetchLegend({pickerInstance:this,info:_20},key);if(_23.then){this._loadingIndices=this._loadingIndices.concat(_20.indices);this._loadingLegends.push(_23);}else{this._processLegendResponse(_23,_20);}}}},this);}},_fetchLegend:function(_27,key){var _28=esri.dijit.editing.TemplatePicker.prototype,_29=_28.legendCache[key];if(!_29){_29=(_28.legendCache[key]=esri.request({url:_27.info.mapServiceUrl+"/legend",content:{f:"json"},callbackParamName:"callback"}));_29._contexts=[_27];_29.addBoth(function(_2a){if(_29.canceled){return;}_28.legendCache[key]=_2a;var _2b=_29._contexts;_29._contexts=null;_2.forEach(_2b,function(_2c){var _2d=_2c.pickerInstance,_2e=_2c.info,_2f;if(_2d._destroyed){return;}_2.forEach(_2e.indices,function(idx){_2f=_2.indexOf(_2d._loadingIndices,idx);if(_2f>-1){_2d._loadingIndices.splice(_2f,1);}});_2f=_2.indexOf(_2d._loadingLegends,_29);if(_2f>-1){_2d._loadingLegends.splice(_2f,1);}_2d._processLegendResponse(_2a,_2e);});});}else{if(_29.then){_29._contexts.push(_27);}}return _29;},_clearLegendInfo:function(){clearTimeout(this._legendTimer);this._ignoreLegends();this._legendIndices=this._loadingIndices=this._legendSymbols=this._loadingLegends=this._legendTimer=null;},_ignoreLegends:function(){if(this._loadingLegends){_2.forEach(this._loadingLegends,function(_30){var _31=-1;_2.some(_30._contexts,function(_32,idx){if(_32.pickerInstance===this){_31=idx;}return (_31>-1);},this);if(_31>-1){_30._contexts.splice(_31,1);}},this);}},_processLegendResponse:function(_33,_34){if(_33&&!(_33 instanceof Error)){_2.forEach(_34.indices,function(idx){var _35=_34.featureLayers[idx].layerId,i,_36=_34.mapServiceUrl+"/"+_35+"/images/",_37=_34.mapServiceLayer._getToken(),_38,obj,_39,url;if(this._legendSymbols[idx]){return;}_38=null;_2.some(_33.layers,function(_3a){if(_3a.layerId==_35){_38=_3a;}return !!_38;});if(_38){obj=(this._legendSymbols[idx]={});_2.forEach(_38.legend,function(_3b){_39=_3b.values;if(_39&&_39.length){for(i=0;i<_39.length;i++){obj[_39[i]]=_3b;}}else{obj.defaultSymbol=_3b;}url=_3b.url;if(url&&!_3b._fixed){_3b._fixed=1;if((url.search(/https?\:/)===-1)){_3b.url=_36+url;}if(_37&&_3b.url.search(/https?\:/)!==-1){_3b.url+=(((_3b.url.indexOf("?")>-1)?"&":"?")+"token="+_37);}}});}},this);}else{var _3c;_2.forEach(_34.indices,function(idx){_3c=_2.indexOf(this._legendIndices,idx);if(_3c>-1){this._legendIndices.splice(_3c,1);}},this);}var _3d=this;if(_3d._started&&!_3d._legendTimer){_3d._legendTimer=setTimeout(function(){clearTimeout(_3d._legendTimer);_3d._legendTimer=null;if(!_3d._destroyed){_3d.update();}},0);}},_applyGridPatches:function(){var _3e=this.grid;var _3f=_3e.adaptWidth,_40,i,_41;_3e.adaptWidth=function(){_40=this.views.views;for(i=0;_41=_40[i];i++){_2.style(_41.headerNode,"display","block");}_3f.apply(this,arguments);for(i=0;_41=_40[i];i++){_2.style(_41.headerNode,"display","none");}};if(this._dojo14x){if(this.rows!=="auto"&&this.columns!=="auto"){var _42=_2.connect(_3e,"_onFetchComplete",this,function(){_2.disconnect(_42);this.grid.set("autoHeight",this._rows);});}_2.connect(_3e,"_onDelete",this,this._destroyItems);_2.connect(_3e,"_clearData",this,this._destroyItems);_2.connect(_3e,"destroy",this,this._destroyItems);var _43=_3e.focus;if(_43&&_43.findAndFocusGridCell){_43.findAndFocusGridCell=function(){return false;};}}},_setGridLayout:function(){var _44=function(_45){return function(_46,_47){return this._cellGet(_45,_46,_47);};};var _48=_2.hitch(this,this._cellFormatter),_49=[],_4a=this._columns,i;for(i=0;i<_4a;i++){_49.push({field:"cell"+i,get:_2.hitch(this,_44(i)),formatter:_48});}var _4b={cells:[_49]};if(this.grouping){var _4c={field:"groupName",colSpan:_4a,get:_2.hitch(this,this._cellGetGroup),formatter:_2.hitch(this,this._cellGroupFormatter)};_4b.cells.push([_4c]);}var _4d=this.grid,_4e=_3.grid.DataGrid.prototype.rowsPerPage;_4d.set("rowsPerPage",(this._rows>_4e)?this._rows:_4e);_4d.set("structure",_4b);},_setGridData:function(){var _4f=[];if(this.grouping){this._groupRowIndices=[];var _50,_51,_52=this._columns;_2.forEach(this._flItems,function(_53,idx){_4f.push({});var _54=(idx===0)?0:(_50+_51+1);this._groupRowIndices.push(_54);_50=_54;_51=Math.ceil(_53.length/_52);_4f=_4f.concat(this._getStoreItems(_53));},this);}else{if(this.featureLayers){_2.forEach(this._flItems,function(_55){_4f=_4f.concat(_55);});_4f=this._getStoreItems(_4f);}else{_4f=this._getStoreItems(this._itItems);}}var _56=new _2.data.ItemFileReadStore({data:{items:_4f}});this.grid.setStore(_56);},_toggleTooltip:function(){if(this.showTooltip){if(this.tooltip){return;}this.tooltip=_2.create("div",{"class":"tooltip"},this.domNode);this.tooltip.style.display="none";this.tooltip.style.position="fixed";var _57=this.grid;this._mouseOverConnect=_2.connect(_57,"onCellMouseOver",this,this._cellMouseOver);this._mouseOutConnect=_2.connect(_57,"onCellMouseOut",this,this._cellMouseOut);}else{if(this.tooltip){_2.disconnect(this._mouseOverConnect);_2.disconnect(this._mouseOutConnect);_2.destroy(this.tooltip);this.tooltip=null;}}},_rowClicked:function(evt,_58){var _59=evt.cellNode,row=evt.rowIndex,col=evt.cellIndex;var _5a=this._getCellInfo(_59,row,col);if(!_5a){return;}var _5b=this.grid.store;if(_5b.getValue(_5a,"loadingCell")){return;}if(this._selectedCell){_2.removeClass(this._selectedCell,"selectedItem");}if(_59!==this._selectedCell){_2.addClass(_59,"selectedItem");this._selectedCell=_59;this._selectedItem={featureLayer:_5b.getValue(_5a,"layer"),type:_5b.getValue(_5a,"type"),template:_5b.getValue(_5a,"template"),symbolInfo:_5b.getValue(_5a,"symbolInfo"),item:this._getItem(_5a)};this._selectedInfo={selRow:row,selCol:col,index1:_5b.getValue(_5a,"index1"),index2:_5b.getValue(_5a,"index2"),index:_5b.getValue(_5a,"index")};}else{this._selectedCell=this._selectedInfo=this._selectedItem=null;}if(!_58){this.onSelectionChange();}},_locate:function(_5c,_5d,_5e){var _5f=this.grid.store,_60=new Array(this._columns);var _61,_62=_5d.index1,_63=_5d.index2,_64=_5d.index,_65=_5c.item;_2.some(_5e,function(_66,_67){return _2.some(_60,function(_68,_69){var _6a=_5f.getValue(_66,"cell"+_69);if(_6a&&(_65?(_64===_5f.getValue(_6a,"index")):(_62===_5f.getValue(_6a,"index1")&&_63===_5f.getValue(_6a,"index2")))){_61=[_67,_69];return true;}else{return false;}});});return _61;},_getCellInfo:function(_6b,row,col){if(!_6b){return;}var _6c=this.grid;var _6d=_6c.getItem(row);var _6e=_6c.store.getValue(_6d,"cell"+col);return _6e;},_getItem:function(_6f){var _70=this.items;if(_70){return _70[this.grid.store.getValue(_6f,"index")];}},_cellMouseOver:function(evt){var _71=this.tooltip;var _72=evt.cellNode,row=evt.rowIndex,col=evt.cellIndex;var _73=this._getCellInfo(_72,row,col);if(_71&&_73){var _74=this.grid.store;var _75=_74.getValue(_73,"template");var _76=_74.getValue(_73,"type");var _77=_74.getValue(_73,"symbolInfo");var _78=_74.getValue(_73,"layer");var _79=this._getItem(_73);var _7a=(_79&&(_79.label+(_79.description?(": "+_79.description):"")))||(_75&&(_75.name+(_75.description?(": "+_75.description):"")))||(_76&&_76.name)||(_77&&(_77.label+(_77.description?(": "+_77.description):"")))||((_78&&_78.name+": ")+"Default");_71.style.display="none";_71.innerHTML=_7a;var _7b=_2.coords(_72.firstChild);_2.style(_71,{left:(_7b.x)+"px",top:(_7b.y+_7b.h+5)+"px"});_71.style.display="";}},_cellMouseOut:function(){var _7c=this.tooltip;if(_7c){_7c.style.display="none";}},_destroyItems:function(){var _7d=this._itemWidgets,w;for(w in _7d){if(!_7d[w]){continue;}_7d[w].destroy();delete _7d[w];}},_repaintItems:function(){var _7e=this._itemWidgets,w;for(w in _7e){var _7f=_7e[w];if(_7f){_7f._repaint(_7f._surface);}}},_getStoreItems:function(_80){var uid=this._uniqueId;_80=_2.map(_80,function(_81){return _2.mixin({"surfaceId":"tpick-surface-"+(uid.id++)},_81);});var len=_80.length,_82=0,obj={},k=0,_83,_84=[],_85=true,_86=this._columns;while(_82<len){_85=true;_83="cell"+k;obj[_83]=_80[_82];_82++;k++;if(k%_86===0){_85=false;_84.push(obj);obj={};k=0;}}if(_85&&len){_84.push(obj);}return _84;},_getItemsFromLayers:function(_87){var _88=[];_2.forEach(_87,function(_89,_8a){_88.push(this._getItemsFromLayer(_89,_8a));},this);return _88;},_getItemsFromLayer:function(_8b,_8c){var _8d=[];if(this.useLegend&&_2.indexOf(this._loadingIndices,_8c)>-1){return [{label:(this._nls&&this._nls.loading)||"",symbol:null,layer:_8b,type:null,template:null,index1:_8c,index2:0,loadingCell:1}];}var _8e=[];_8e=_8e.concat(_8b.templates);_2.forEach(_8b.types,function(_8f){var _90=_8f.templates;_2.forEach(_90,function(_91){_91._type_=_8f;});_8e=_8e.concat(_90);});_8e=_2.filter(_8e,esri._isDefined);var _92=_8b.renderer;if(_92){var _93=_92.declaredClass.replace("esri.renderer.","");if(_8e.length>0){_2.forEach(_8e,function(_94){var _95=_94.prototype;if(_95){var _96=_92.getSymbol(_95);if(_96){var _97=null,pms,_98;if(this.useLegend&&_2.indexOf(this._legendIndices,_8c)>-1){_98=this._legendSymbols&&this._legendSymbols[_8c];if(_98){switch(_93){case "SimpleRenderer":_97=_98.defaultSymbol;break;case "UniqueValueRenderer":_2.some(_92.infos,function(_99){if(_99.symbol===_96){_97=_98[_99.value];}return !!_97;});break;case "ClassBreaksRenderer":_2.some(_92.infos,function(_9a){if(_9a.symbol===_96){_97=_98[_9a.maxValue];}return !!_97;});break;}}if(_97){pms=_2.fromJson(_2.toJson(esri.symbol.defaultPictureMarkerSymbol));pms.url=_97.url;pms.imageData=_97.imageData;pms.contentType=_97.contentType;pms.width=_97.width;pms.height=_97.height;if(!esri._isDefined(pms.width)||!esri._isDefined(pms.height)){pms.width=15;pms.height=15;}_97=new esri.symbol.PictureMarkerSymbol(pms);}}_8d.push({label:this._trimLabel(_94.name),symbol:_97||_96,legendOverride:!!_97,layer:_8b,type:_94._type_,template:_94,index1:_8c,index2:_8d.length});}}delete _94._type_;},this);}else{var _9b=[];if(_93==="TemporalRenderer"){_92=_92.observationRenderer;if(_92){_93=_92.declaredClass.replace("esri.renderer.","");}}switch(_93){case "SimpleRenderer":_9b=[{symbol:_92.symbol,label:_92.label,description:_92.description}];break;case "UniqueValueRenderer":case "ClassBreaksRenderer":_9b=_92.infos;break;}_8d=_2.map(_9b,function(_9c,idx){return {label:this._trimLabel(_9c.label),description:_9c.description,symbolInfo:_2.mixin({constructor:function(){}},_9c),symbol:_9c.symbol,layer:_8b,index1:_8c,index2:idx};},this);}}return _8d;},_getItemsFromItems:function(_9d){return _2.map(_9d,function(_9e,idx){_9e=_2.mixin({index:idx},_9e);_9e.label=this._trimLabel(_9e.label);return _9e;},this);},_trimLabel:function(_9f){var max=this.maxLabelLength;if(max&&_9f){if(_9f.length>max){_9f=_9f.substr(0,max)+"...";}}return _9f||"";},_cellGet:function(_a0,_a1,_a2){if(!_a2){return "";}return this.grid.store.getValue(_a2,"cell"+_a0);},_cellFormatter:function(_a3){if(_a3){var _a4=this._itemWidgets,_a5=this.grid.store;var sid=_a5.getValue(_a3,"surfaceId");var w=_a4[sid];if(!w){w=(_a4[sid]=new esri.dijit.editing.TemplatePickerItem({id:sid,label:_a5.getValue(_a3,"label"),symbol:_a5.getValue(_a3,"symbol"),legendOverride:_a5.getValue(_a3,"legendOverride"),surfaceWidth:this.surfaceWidth,surfaceHeight:this.surfaceHeight,template:_a5.getValue(_a3,"template")}));}return w||"";}else{return "";}},_cellGetGroup:function(_a6,_a7){if(!this._groupRowIndices){return "";}var _a8=_2.indexOf(this._groupRowIndices,_a6);if(!_a7||_a8===-1){return "";}return (this.featureLayers[_a8]&&this.featureLayers[_a8].name)||"";},_cellGroupFormatter:function(_a9){if(_a9){return "<div class='groupLabel'>"+_a9+"</div>";}else{return "";}}});_2.declare("esri.dijit.editing.TemplatePickerItem",[_1._Widget,_1._Templated],{templateString:"<div class='item' style='text-align: center;'>"+"<div class='itemSymbol' dojoAttachPoint='_surfaceNode'></div>"+"<div class='itemLabel'>${label}</div>"+"</div>",startup:function(){if(this._started){return;}this.inherited(arguments);this._surface=this._draw(this._surfaceNode,this.symbol,this.surfaceWidth,this.surfaceHeight,this.template);},_draw:function(_aa,_ab,_ac,_ad,_ae){if(!_ab){return;}var _af=_3.gfx.createSurface(_aa,_ac,_ad);if(_2.isIE<9){var _b0=_af.getEventSource();_2.style(_b0,"position","relative");_2.style(_b0.parentNode,"position","relative");}var _b1=(!this.legendOverride&&this._getDrawingToolShape(_ab,_ae))||esri.symbol.getShapeDescriptors(_ab);var _b2;try{_b2=_af.createShape(_b1.defaultShape).setFill(_b1.fill).setStroke(_b1.stroke);}catch(e){_af.clear();_af.destroy();return;}var dim=_af.getDimensions();var _b3={dx:dim.width/2,dy:dim.height/2};var _b4=_b2.getBoundingBox(),_b5=_b4.width,_b6=_b4.height;if(_b5>_ac||_b6>_ad){var _b7=_b5>_b6?_b5:_b6;var _b8=_ac<_ad?_ac:_ad;var _b9=(_b8-5)/_b7;_2.mixin(_b3,{xx:_b9,yy:_b9});}_b2.applyTransform(_b3);return _af;},_getDrawingToolShape:function(_ba,_bb){var _bc,_bd=_bb?_bb.drawingTool||null:null;switch(_bd){case "esriFeatureEditToolArrow":_bc={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolLeftArrow":_bc={type:"path",path:"M -15,1 L -8,8 L -8,5 L 10,5 L 10,-2 L -8,-2 L -8,-5 L -15,1 E"};break;case "esriFeatureEditToolRightArrow":_bc={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolUpArrow":_bc={type:"path",path:"M 1,-10 L 8,-3 L 5,-3 L 5,15 L -2,15 L -2,-3 L -5,-3 L 1,-10 E"};break;case "esriFeatureEditToolDownArrow":_bc={type:"path",path:"M 1,15 L 8,8 L 5,8 L 5,-10 L -2,-10 L -2,8 L -5,8 L 1,15 E"};break;case "esriFeatureEditToolTriangle":_bc={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":_bc={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":_bc={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":_bc={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;case "esriFeatureEditToolFreehand":if(_ba.type==="simplelinesymbol"||_ba.type==="cartographiclinesymbol"){_bc={type:"path",path:"m -11, -7c-1.5,-3.75 7.25,-9.25 12.5,-7c5.25,2.25 6.75,9.75 3.75,12.75c-3,3 -3.25,2.5 -9.75,5.25c-6.5,2.75 -7.25,14.25 2,15.25c9.25,1 11.75,-4 13.25,-6.75c1.5,-2.75 3.5,-11.75 12,-6.5"};}else{_bc={type:"path",path:"M 10,-13 c3.1,0.16667 4.42564,2.09743 2.76923,3.69231c-2.61025,2.87179 -5.61025,5.6718 -6.14358,6.20513c-0.66667,0.93333 -0.46667,1.2 -0.53333,1.93333c-0.00001,0.86666 0.6,1.66667 1.13334,2c1.03077,0.38462 2.8,0.93333 3.38974,1.70769c0.47693,0.42564 0.87693,0.75897 1.41026,1.75897c0.13333,1.06667 -0.46667,2.86667 -1.8,3.8c-0.73333,0.73333 -3.86667,2.66666 -4.86667,3.13333c-0.93333,0.8 -7.4,3.2 -7.6,3.06667c-1.06667,0.46667 -4.73333,1.13334 -5.2,1.26667c-1.6,0.33334 -4.6,0.4 -6.25128,0.05128c-1.41539,-0.18462 -2.34872,-2.31796 -1.41539,-4.45129c0.93333,-1.73333 1.86667,-3.13333 2.64615,-3.85641c1.28718,-1.47692 2.57437,-2.68204 3.88718,-3.54359c0.88718,-1.13845 1.8,-1.33333 2.26666,-2.45641c0.33334,-0.74359 0.37949,-1.7641 0.06667,-2.87692c-0.66666,-1.46666 -1.66666,-1.86666 -2.98975,-2.2c-1.27692,-0.26666 -2.12307,-0.64102 -3.27692,-1.46666c-0.66667,-1.00001 -1.01538,-3.01539 0.73333,-4.06667c1.73333,-1.2 3.6,-1.93333 4.93333,-2.2c1.33333,-0.46667 4.84104,-1.09743 5.84103,-1.23076c1.60001,-0.46667 6.02564,-0.50257 7.29231,-0.56924z"};}break;default:return null;}return {defaultShape:_bc,fill:_ba.getFill(),stroke:_ba.getStroke()};},_repaint:function(_be){if(!_be){this._surface=this._draw(this._surfaceNode,this.symbol,this.surfaceWidth,this.surfaceHeight,this.template);return;}if(_be.getStroke&&_be.setStroke){_be.setStroke(_be.getStroke());}if(_be.getFill&&_be.setFill){_be.setFill(_be.getFill());}if(_be.children&&_2.isArray(_be.children)){_2.forEach(_be.children,this._repaint,this);}},destroy:function(){if(this._surface){this._surface.destroy();delete this._surface;}this.inherited(arguments);}});});