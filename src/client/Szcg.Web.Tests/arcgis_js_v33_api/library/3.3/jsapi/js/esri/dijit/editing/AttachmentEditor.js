/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/editing/AttachmentEditor",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated"],function(_1,_2,_3){_2.provide("esri.dijit.editing.AttachmentEditor");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.declare("esri.dijit.editing.AttachmentEditor",[_1._Widget,_1._Templated],{widgetsInTemplate:true,templateString:"<div class=\"attachmentEditor\">\r\n    <br />\r\n    <div>\r\n        <b>${NLS_attachments}</b>\r\n        <hr />\r\n        <div dojoAttachPoint=\"_attachmentError\" style='color:red;display:none'></div>\r\n        <br />\r\n        <span dojoAttachPoint='_attachmentList' style='word-wrap: break-word;'></span>\r\n        <br><br>\r\n        <form dojoAttachPoint='_uploadForm'> ${NLS_add}:&nbsp;&nbsp;<input type='file' name='attachment' dojoAttachPoint='_uploadField' /> </form>\r\n    </div>\r\n</div>",basePath:_2.moduleUrl("esri.dijit.editing"),_listHtml:"<span id='node_${oid}_${attid}'><a href='${href}' target='_blank'>${name}</a>",_deleteBtnHtml:"(<span style='cursor:pointer;color:red;font-weight:bold;' class='deleteAttachment' id='${attid}');'>X</span>)",_endHtml:"<br/></span>",_aeConnects:[],_layerEditingCapChecked:{},_layerEditingCap:{},constructor:function(_4,_5){_2.mixin(this,esri.bundle.widgets.attachmentEditor);},startup:function(){this.inherited(arguments);this._uploadField_connect=_2.connect(this._uploadField,"onchange",this,"_addAttachment");this._uploadFieldFocus_connect=_2.connect(this._uploadField,"onfocus",_2.hitch(this,function(e){esri.hide(this._attachmentError);}));},destroy:function(){_2.forEach(this._aeConnects,_2.disconnect);_2.disconnect(this._uploadField_connect);_2.disconnect(this._uploadFieldFocus_connect);this.inherited(arguments);},showAttachments:function(_6,_7){var _8=this._attachmentList;_8.innerHTML=this.NLS_none;this._uploadField.value="";_2.forEach(this.domNode.children,function(_9,_a){esri.show(_9);});esri.hide(this._attachmentError);if(!_6){return;}this._featureLayer=_6.getLayer()||_7;if(!this._featureLayer){return;}if(this._featureLayer.declaredClass!=="esri.layers.FeatureLayer"||!this._featureLayer.getEditCapabilities){esri.hide(this._uploadForm);_2.forEach(this.domNode.children,function(_b,_c){esri.hide(_b);});return;}this._currentLayerId=this._featureLayer.id;if(!this._layerEditingCapChecked[this._currentLayerId]){this._layerEditingCap[this._currentLayerId]=this._featureLayer.getEditCapabilities();this._layerEditingCapChecked[this._currentLayerId]=true;}this._featureCanUpdate=this._featureLayer.getEditCapabilities({feature:_6}).canUpdate;this._oid=_6.attributes[this._featureLayer.objectIdField];this._getAttachments(_6);},_getAttachments:function(_d){if(!this._featureLayer||!this._featureLayer.queryAttachmentInfos){return;}this._featureLayer.queryAttachmentInfos(this._oid,_2.hitch(this,"_onQueryAttachmentInfosComplete"));},_addAttachment:function(){esri.hide(this._attachmentError);if(!this._featureLayer||!this._featureLayer.addAttachment){return;}this._featureLayer.addAttachment(this._oid,this._uploadForm,_2.hitch(this,"_onAddAttachmentComplete"),_2.hitch(this,"_onAddAttachmentError"));},_deleteAttachment:function(_e,_f){this._featureLayer.deleteAttachments(_e,[_f],_2.hitch(this,"_onDeleteAttachmentComplete"));},_onQueryAttachmentInfosComplete:function(_10){var _11=this._listHtml+this._deleteBtnHtml+this._endHtml;this._uploadForm.style.display="block";if((!this._featureCanUpdate&&this._layerEditingCap[this._currentLayerId].canUpdate)||(!this._layerEditingCap[this._currentLayerId].canCreate&&!this._layerEditingCap[this._currentLayerId].canUpdate)){_11=this._listHtml+this._endHtml;this._uploadForm.style.display="none";}else{if(this._layerEditingCap[this._currentLayerId].canCreate&&!this._layerEditingCap[this._currentLayerId].canUpdate){_11=this._listHtml+this._endHtml;}}var _12=this._attachmentList,_13=_2.map(_10,_2.hitch(this,function(_14){return esri.substitute({href:_14.url,name:_14.name,oid:_14.objectId,attid:_14.id},_11);}));_12.innerHTML=_13.join("")||this.NLS_none;this._updateConnects();},_onAddAttachmentComplete:function(_15){var _16=this._uploadField;var _17=_16.value;var pos=_17.lastIndexOf("\\");if(pos>-1){_17=_17.substring(pos+1,_17.length);}_17=_17.replace(/\ /g,"_");var _18=this._attachmentList,_19=_2.objectToQuery({gdbVersion:this._featureLayer.gdbVersion,token:this._featureLayer._getToken()});var _1a=this._listHtml+this._deleteBtnHtml+this._endHtml;if(this._layerEditingCap[this._currentLayerId].canCreate&&!this._layerEditingCap[this._currentLayerId].canUpdate){_1a=this._listHtml+this._endHtml;}var _1b=esri.substitute({href:this._featureLayer._url.path+"/"+_15.objectId+"/attachments/"+_15.attachmentId+(_19?("?"+_19):""),name:_17,oid:_15.objectId,attid:_15.attachmentId},_1a);_18.innerHTML=_18.innerHTML==this.NLS_none?_1b:(_18.innerHTML+_1b);this._updateConnects();_16.value="";},_onAddAttachmentError:function(_1c){if(_1c&&esri._isDefined(_1c.code)){var _1d,_1e=this._attachmentError;if(_1c.code===400){_1d=this.NLS_fileNotSupported;}else{_1d=_1c.message||(_1c.details&&_1c.details.length&&_1c.details[0]);}_2.attr(_1e,"innerHTML",(_1d||this.NLS_error));esri.show(_1e);}},_onDeleteAttachmentComplete:function(_1f){var _20=_2.every(_1f,function(_21){return _21.success;}),_22=this._attachmentList;if(_20){_2.query("#node_"+_1f[0].objectId+"_"+_1f[0].attachmentId).orphan();if(!_22.children||!_22.children.length){_22.innerHTML=this.NLS_none;}}},_updateConnects:function(){_2.forEach(this._aeConnects,_2.disconnect);_2.query(".deleteAttachment").forEach(function(_23){this._aeConnects.push(_2.connect(_23,"onclick",_2.hitch(this,"_deleteAttachment",this._oid,_23.id)));},this);}});});