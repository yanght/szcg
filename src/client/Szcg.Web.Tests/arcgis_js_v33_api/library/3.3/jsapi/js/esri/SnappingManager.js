/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/SnappingManager",["dijit","dojo","dojox","dojo/require!esri/tasks/query"],function(_1,_2,_3){_2.provide("esri.SnappingManager");_2.require("esri.tasks.query");_2.declare("esri.SnappingManager",null,{constructor:function(_4){_4=_4||{};if(!_4.map){console.error("map is not specified for SnappingManager");}this.map=_4.map;this.tolerance=_4.tolerance||15;this.layerInfos=[];if(_4.layerInfos){this.layerInfos=_4.layerInfos;}else{var i;for(i=0;i<this.map.graphicsLayerIds.length;i++){var _5=this.map.getLayer(this.map.graphicsLayerIds[i]);this.layerInfos.push({"layer":_5});}this.layerInfos.push({"layer":this.map.graphics});}if(_4.snapPointSymbol){this.snapPointSymbol=_4.snapPointSymbol;}else{this.snapPointSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CROSS,15,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new _2.Color([0,255,255]),1),new _2.Color([0,255,0,0]));}if(_4.alwaysSnap){this.alwaysSnap=_4.alwaysSnap;}else{this.alwaysSnap=false;}if(_4.snapKey){this.snapKey=_4.snapKey;}else{this.snapKey=_2.keys.copyKey;}this._SelectionLyrQuery=new esri.tasks.Query();this._SelectionLyrQuery.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;this._snappingGraphic=new esri.Graphic();this.setLayerInfos(this.layerInfos);this._currentGraphicOption={snapToPoint:true,snapToVertex:true,snapToEdge:true};this._snappingCallback=_2.hitch(this,this._snappingCallback);},getSnappingPoint:function(_6){var _7=this.layers,_8=this.tolerance,_9=this.map,_a=this.layerOptions,_b=_9.toMap(_6.offset(-_8,_8)),_c=_9.toMap(_6.offset(_8,-_8)),_d=new esri.geometry.Extent(_b.x,_b.y,_c.x,_c.y,_9.spatialReference),_e=new esri.tasks.Query();_e.geometry=_d;_e.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;var _f=[],_10=[],_11,_12=this._extractPointsAndLines,_13=new _2.Deferred(),_14=0,_15,_16=_d.xmin,_17=_d.xmax;_2.forEach(_7,function(_18,idx){if(_18.visible&&_18.loaded&&_18.declaredClass==="esri.layers.FeatureLayer"&&_18.mode!==esri.layers.FeatureLayer.MODE_SELECTION){_14++;}});if(_9.spatialReference._isWrappable()){_16=esri.geometry.Extent.prototype._normalizeX(_d.xmin,_9.spatialReference._getInfo()).x;_17=esri.geometry.Extent.prototype._normalizeX(_d.xmax,_9.spatialReference._getInfo()).x;}var _19=new esri.geometry.Extent(_16,_d.ymin,_17,_d.ymax,_9.spatialReference);_2.forEach(_7,function(_1a,idx){if(_1a.declaredClass==="esri.layers.GraphicsLayer"&&_1a.visible){var _1b=[];_2.forEach(_1a.graphics,function(_1c){if(_1c){if(_1c.visible&&_19.intersects(_1c.geometry)){_1b.push(_1c);}}});var _1d=_12(_1b,_a[idx]);_f=_f.concat(_1d[0]);_10=_10.concat(_1d[1]);}});var _1e=_2.hitch(this,function(_1f){_14--;if(_1f instanceof Error){var msg="getSnappingPoint: query features failed";console.log(msg);}else{var _20=_12(_1f.features,_a[_15]);_f=_f.concat(_20[0]);_10=_10.concat(_20[1]);}if(!_14){_11=this._getSnappingPoint(_f,_10,_6);_13.callback(_11);}});var _21=false;_2.forEach(_7,function(_22,idx){if(_22.visible&&_22.loaded){_15=idx;if((_22.declaredClass==="esri.layers.FeatureLayer")&&_22.mode!==esri.layers.FeatureLayer.MODE_SELECTION){_21=true;_22.queryFeatures(_e,_1e,_1e);}}});if(!_21){_11=this._getSnappingPoint(_f,_10,_6);_13.callback(_11);}return _13;},setLayerInfos:function(_23){this.layers=[];this.layerOptions=[];var i;for(i=0;i<_23.length;i++){this.layers.push(_23[i].layer);this.layerOptions.push({snapToPoint:true,snapToVertex:true,snapToEdge:true});if(_23[i].snapToPoint===false){this.layerOptions[i].snapToPoint=_23[i].snapToPoint;}if(_23[i].snapToVertex===false){this.layerOptions[i].snapToVertex=_23[i].snapToVertex;}if(_23[i].snapToEdge===false){this.layerOptions[i].snapToEdge=_23[i].snapToEdge;}}this._featurePtsFromSelectionLayer=[];this._featureLinesFromSelectionLayer=[];this._selectionLayers=[];this._selectionLayerOptions=[];_2.forEach(this.layers,function(_24,idx){if(_24.declaredClass==="esri.layers.FeatureLayer"&&_24.mode===esri.layers.FeatureLayer.MODE_SELECTION){this._selectionLayers.push(_24);this._selectionLayerOptions.push(this.layerOptions[idx]);}},this);this.layerInfos=_23;},destroy:function(){_2.disconnect(this._onExtentChangeConnect);this._killOffSnapping();this._featurePtsFromSelectionLayer=this._featureLinesFromSelectionLayer=this._currentFeaturePts=this._currentFeatureLines=this.layers=this.map=null;},_startSelectionLayerQuery:function(){_2.disconnect(this._onExtentChangeConnect);this._mapExtentChangeHandler(this._selectionLayers,this._selectionLayerOptions,this.map.extent);this._onExtentChangeConnect=_2.connect(this.map,"onExtentChange",_2.hitch(this,"_mapExtentChangeHandler",this._selectionLayers,this._selectionLayerOptions));},_stopSelectionLayerQuery:function(){_2.disconnect(this._onExtentChangeConnect);},_mapExtentChangeHandler:function(_25,_26,_27){this._featurePtsFromSelectionLayer=[];this._featureLinesFromSelectionLayer=[];var _28;this._SelectionLyrQuery.geometry=_27;var _29=_2.hitch(this,function(_2a){if(_2a instanceof Error){var msg="getSnappingPoint: query features failed";console.log(msg);}else{var _2b=this._extractPointsAndLines(_2a.features,_26[_28]);this._featurePtsFromSelectionLayer=this._featurePtsFromSelectionLayer.concat(_2b[0]);this._featureLinesFromSelectionLayer=this._featureLinesFromSelectionLayer.concat(_2b[1]);}});_2.forEach(_25,function(_2c,idx){if(_2c.visible&&_2c.loaded){_28=idx;_2c.queryFeatures(this._SelectionLyrQuery,_29,_29);}},this);},_extractPointsAndLines:function(_2d,_2e){var _2f=[],_30=[];var i,j;_2.forEach(_2d,function(_31,idx){if(_31.visible&&_31.geometry){if(_31.geometry.type==="point"&&_2e.snapToPoint){_2f.push(_31.geometry);}else{if(_31.geometry.type==="polyline"){for(i=0;i<_31.geometry.paths.length;i++){_30.push("lineStart");for(j=0;j<_31.geometry.paths[i].length;j++){var _32=_31.geometry.getPoint(i,j);if(_2e.snapToVertex){_2f.push(_32);}if(_2e.snapToEdge){_30.push(_32);}}_30.push("lineEnd");}}else{if(_31.geometry.type==="polygon"){for(i=0;i<_31.geometry.rings.length;i++){_30.push("lineStart");for(j=0;j<_31.geometry.rings[i].length;j++){var _33=_31.geometry.getPoint(i,j);if(_2e.snapToVertex){_2f.push(_33);}if(_2e.snapToEdge){_30.push(_33);}}_30.push("lineEnd");}}}}}});return [_2f,_30];},_getSnappingPoint:function(_34,_35,_36){var _37,_38,_39=this.tolerance;var map=this.map;var _3a=this.map._getFrameWidth();_34=_34.concat(this._featurePtsFromSelectionLayer);_35=_35.concat(this._featureLinesFromSelectionLayer);if(this._currentGraphic){var _3b=this._extractPointsAndLines([this._currentGraphic],this._currentGraphicOption);_34=_34.concat(_3b[0]);_35=_35.concat(_3b[1]);}var _3c,_3d;_2.forEach(_34,function(pt,idx){var _3e=map.toScreen(pt,true);if(_3a!==-1){_3e.x=_3e.x%_3a;if(_3e.x<0){_3e.x+=_3a;}if(map.width>_3a){var _3f=(map.width-_3a)/2;while(_3e.x<_3f){_3e.x+=_3a;}}}_37=Math.sqrt((_3e.x-_36.x)*(_3e.x-_36.x)+(_3e.y-_36.y)*(_3e.y-_36.y));if(_37<=_39){_39=_37;_3c=_3e.x;_3d=_3e.y;}});if(_3c){var _40=new esri.geometry.ScreenPoint(_3c,_3d);_40=map.toMap(_40);_38=_40;}else{var _41,_42,i,j;_39=this.tolerance;for(i=0;i<_35.length;i++){if(_35[i]==="lineStart"){for(j=i+1;j<_35.length;j++){if(_35[j+1]!=="lineEnd"&&_35[j+1]!=="lineStart"&&_35[j]!=="lineEnd"&&_35[j]!=="lineStart"){var _43=map.toScreen(_35[j],true),_44=map.toScreen(_35[j+1],true),_45=(_43.x>=_44.x)?_43:_44,_46=(_43.x>=_44.x)?_44:_43;if(_3a!==-1){_45.x=_45.x%_3a;if(_45.x<0){_45.x+=_3a;}_46.x=_46.x%_3a;if(_46.x<0){_46.x+=_3a;}if(_46.x>_45.x){_46.x-=_3a;}}var x1=_45.x,y1=_45.y,x2=_46.x,y2=_46.y;var _47,_48,_49,_4a,_4b,_4c;if(x1===x2){_47=x1;_48=_36.y;_49=_4a=x1;_4b=(y1<=y2)?y1:y2;_4c=(y1<=y2)?y2:y1;}else{if(y1===y2){_47=_36.x;_48=y1;_49=(x1<=x2)?x1:x2;_4a=(x1<=x2)?x2:x1;_4b=_4c=y1;}else{var a=(y2-y1)/(x2-x1),b=(y1*x2-x1*y2)/(x2-x1),_4d=(x1-x2)/(y2-y1),_4e=(_36.y*y2-_36.y*y1-_36.x*x1+_36.x*x2)/(y2-y1);_47=(b-_4e)/(_4d-a);_48=a*_47+b;_49=(x1<=x2)?x1:x2;_4a=(x1<=x2)?x2:x1;_4b=(y1<=y2)?y1:y2;_4c=(y1<=y2)?y2:y1;}}if(_47>=_49&&_47<=_4a&&_48>=_4b&&_48<=_4c){var _4f=Math.sqrt((_36.x-_47)*(_36.x-_47)+(_36.y-_48)*(_36.y-_48));if(_4f<=_39){_39=_4f;_41=_47;_42=_48;}}else{var _50=Math.sqrt((x1-_36.x)*(x1-_36.x)+(y1-_36.y)*(y1-_36.y));var _51=Math.sqrt((x2-_36.x)*(x2-_36.x)+(y2-_36.y)*(y2-_36.y));var _52;if(_50<=_51){_52=_50;_47=x1;_48=y1;}else{_52=_51;_47=x2;_48=y2;}if(_52<=_39){_39=_52;_41=_47;_42=_48;}}}if(_35[j]==="lineEnd"){i=j;break;}}}}if(_41){var _53=new esri.geometry.ScreenPoint(_41,_42);_53=map.toMap(_53);_38=_53;}}return _38;},_setGraphic:function(_54){this._currentGraphic=_54;},_addSnappingPointGraphic:function(){var map=this.map;var _55=this.snapPointSymbol;this._snappingGraphic.setSymbol(_55);map.graphics.add(this._snappingGraphic);},_setUpSnapping:function(){var map=this.map;this._onSnapKeyDown_connect=_2.connect(map,"onKeyDown",this,"_onSnapKeyDownHandler");this._onSnapKeyUp_connect=_2.connect(map,"onKeyUp",this,"_onSnapKeyUpHandler");this._onSnappingMouseMove_connect=_2.connect(map,"onMouseMove",this,"_onSnappingMouseMoveHandler");this._onSnappingMouseDrag_connect=_2.connect(map,"onMouseDrag",this,"_onSnappingMouseMoveHandler");if(this.alwaysSnap){this._activateSnapping();}},_killOffSnapping:function(){_2.disconnect(this._onSnapKeyDown_connect);_2.disconnect(this._onSnapKeyUp_connect);_2.disconnect(this._onSnappingMouseMove_connect);_2.disconnect(this._onSnappingMouseDrag_connect);this._deactivateSnapping();},_onSnapKeyDownHandler:function(evt){if(evt.keyCode===this.snapKey){_2.disconnect(this._onSnapKeyDown_connect);if(this.alwaysSnap){this._deactivateSnapping();}else{this._activateSnapping();}}},_activateSnapping:function(){this._snappingActive=true;this._addSnappingPointGraphic();if(this._currentLocation){this._onSnappingMouseMoveHandler(this._currentLocation);}},_onSnapKeyUpHandler:function(evt){if(evt.keyCode===this.snapKey){this._onSnapKeyDown_connect=_2.connect(this.map,"onKeyDown",this,"_onSnapKeyDownHandler");if(this.alwaysSnap){this._activateSnapping();}else{this._deactivateSnapping();}}},_deactivateSnapping:function(){this._snappingActive=false;this._snappingPoint=null;this.map.graphics.remove(this._snappingGraphic);this._snappingGraphic.setGeometry(null);},_onSnappingMouseMoveHandler:function(evt){this._currentLocation=evt;this._snappingPoint=null;if(this._snappingActive){this._snappingGraphic.hide();var _56=this.getSnappingPoint(evt.screenPoint);_56.addCallback(this._snappingCallback);}},_snappingCallback:function(_57){this._snappingPoint=_57;if(_57){this._snappingGraphic.show();this._snappingGraphic.setGeometry(_57);}}});});