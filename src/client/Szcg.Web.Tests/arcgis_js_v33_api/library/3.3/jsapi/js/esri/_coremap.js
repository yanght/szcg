/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/_coremap",["dijit","dojo","dojox","dojo/require!esri/Evented,dijit/_base/manager,esri/geometry,esri/utils,esri/fx,dojox/gfx/matrix,esri/layers/graphics,esri/dijit/InfoWindow"],function(_1,_2,_3){_2.provide("esri._coremap");_2.require("esri.Evented");_2.require("dijit._base.manager");_2.require("esri.geometry");_2.require("esri.utils");_2.require("esri.fx");_2.require("dojox.gfx.matrix");_2.require("esri.layers.graphics");_2.require("esri.dijit.InfoWindow");_2.declare("esri._CoreMap",[esri.Evented],(function(){var _4=esri.geometry.toMapPoint,_5=esri.geometry.toScreenPoint,dc=_2.connect,_6=_2.disconnect,dh=_2.hitch,ds=_2.style,_7=_2.indexOf,_8=_2.mixin,_9=esri.geometry.Point,_a=esri.geometry.ScreenPoint,_b=esri.geometry.Extent,_c=esri.layers.GraphicsLayer,_d=esri.geometry.Rect,_e=0,_f=esri.config.defaults.map;var _10=1000000,_11=0.75,_12=0.25,_13=3,_14=20,_15=40;function _16(_17,_18){var _19=_17.lods;_19.sort(function(l1,l2){if(l1.scale>l2.scale){return -1;}else{if(l1.scale<l2.scale){return 1;}}return 0;});var _1a=[];_19=_2.filter(_19,function(l){if(_7(_1a,l.scale)===-1){_1a.push(l.scale);return true;}});var pl=(_18.lods=[]),l;_2.forEach(_19,function(lod,_1b){l=(pl[_1b]=new esri.layers.LOD(lod));l.level=_1b;});_18.tileInfo=new esri.layers.TileInfo(_8(_17,{lods:pl}));};return {resizeDelay:300,invalidExtent:"Map does not have a valid extent.",invalidGeometry:"Geometry (wkid: ${geometry}) cannot be converted to spatial reference of the map (wkid: ${map})",unknownBasemap:"Unable to find basemap definition for: \"${basemapName}\". Try one of these: ${list}",invalidBasemap:"Unable to add basemap: \"${basemapName}\".",unknownLayerType:"Unknown basemap layer type: \"${type}\" found in basemap definition for: \"${basemapName}\".",constructor:function(_1c,_1d){this.registerConnectEvents({"basemap-change":["BasemapChange"],"extent-change":["ExtentChange","extent","delta","levelChange","lod"],"layer-add":["LayerAdd","layer"],"layer-add-result":["LayerAddResult","layer","error"],"layer-remove":["LayerRemove","layer"],"layer-reorder":["LayerReorder","layer","index"],"layer-resume":["LayerResume","layer"],"layer-suspend":["LayerSuspend","layer"],"layers-add-result":["LayersAddResult","layers"],"layers-removed":["LayersRemoved"],"layers-reordered":["LayersReordered","layerIds"],"load":["Load","map"],"pan":["Pan","extent","delta"],"pan-end":["PanEnd","extent","delta"],"pan-start":["PanStart","extent","screenPoint"],"reposition":["Reposition","x","y"],"resize":["Resize","extent","width","height"],"scale":["Scale","matrix","immediate"],"time-extent-change":["TimeExtentChange","timeExtent"],"unload":["Unload","map"],"update-end":["UpdateEnd","error"],"update-start":["UpdateStart"],"zoom":["Zoom","extent","zoomFactor","anchor"],"zoom-end":["ZoomEnd","extent","zoomFactor","anchor","level"],"zoom-start":["ZoomStart","extent","zoomFactor","anchor","level"]});_8(this,{_internalLayerIds:[],_layers:[],_layerDivs:[],_layerSize:0,_clickHandles:[],_connects:[]});_8(this,{_zoomAnimDiv:null,_zoomAnim:null,_layersDiv:null,_firstLayerId:null,_delta:null,_cursor:null,_ratioW:1,_ratioH:1,_params:null});_8(this,{cursor:null,layerIds:[],graphicsLayerIds:[],graphics:null,loaded:false});_8(this,{__panning:false,__zooming:false,__container:null,root:null,__LOD:null,__tileInfo:null,__visibleRect:null,__visibleDelta:null});var _1e=(this.container=_2.byId(_1c));var id=(this.id=_2.attr(_1e,"id")||_1.getUniqueId(this.declaredClass));_2.addClass(_1e,"map");var box=_2.contentBox(_1e),dac=_2.addClass,dcr=_2.create;this.position=new _a(0,0);this._reposition();var _1f=(this.width=(box.w||_f.width));var _20=(this.height=box.h||_f.height);if(box.w===0){ds(_1e,"width",_1f+"px");}if(box.h===0){ds(_1e,"height",_20+"px");}var _21=(this.root=dcr("div",{id:id+"_root",style:{width:_1f+"px",height:_20+"px"}}));dac(_21,"container");var _22=(this.__container=dcr("div",{id:id+"_container"},_21));ds(_22,"position","absolute");dac(_22,"container");_1e.appendChild(_21);var _23=(this._params=_8({slider:true,nav:false,zoom:-1,minZoom:-1,maxZoom:-1,scale:-1,minScale:0,maxScale:0,showInfoWindowOnClick:true,displayGraphicsOnPan:true,wrapAround180:true,fitExtent:false},_1d||{}));this.wrapAround180=_23.wrapAround180;if(esri.isDefined(_23.resizeDelay)){this.resizeDelay=_23.resizeDelay;}if(_23.lods){_16({rows:512,cols:512,dpi:96,format:"JPEG",compressionQuality:75,origin:{x:-180,y:90},spatialReference:{wkid:4326},lods:_23.lods},_23);this.__tileInfo=_23.tileInfo;}var ext=(this.extent=_23.extent);this._extentUtil({mapCenter:_23.center,targetLevel:_23.zoom,targetScale:_23.scale});this.__visibleRect=new _d(0,0,_1f,_20);this.__visibleDelta=new _d(0,0,_1f,_20);var _24=(this._layersDiv=dcr("div",{id:id+"_layers"}));dac(_24,"layersDiv");_22.appendChild(_24);this._zoomAnimDiv=dcr("div",{style:{position:"absolute"}});if(_23.infoWindow){this.infoWindow=_23.infoWindow;}else{var iw=(this.infoWindow=new esri.dijit.InfoWindow({map:this,title:"",id:id+"_infowindow"},dcr("div",null,_21)));iw.startup();iw._ootb=true;ds(iw.domNode,"zIndex",_15);}this._zoomStartHandler=dh(this,this._zoomStartHandler);this._zoomingHandler=dh(this,this._zoomingHandler);this._zoomEndHandler=dh(this,this._zoomEndHandler);this._panningHandler=dh(this,this._panningHandler);this._panEndHandler=dh(this,this._panEndHandler);this._endTranslate=dh(this,this._endTranslate);_2.addOnWindowUnload(this,this.destroy);},_cleanUp:function(){var iw=this.infoWindow;if(iw){if(iw._ootb){iw.destroy();}else{iw.unsetMap(this);}delete this.infoWindow;}var _25=this._connects,i;for(i=_25.length-1;i>=0;i--){_6(_25[i]);delete _25[i];}_6(this._tsTimeExtentChange_connect);this.setInfoWindowOnClick(false);_2.destroy(this.root);this.root=null;},_addLayer:function(_26,_27,_28){var id=(_26.id=_26.id||(_26 instanceof _c?_f.graphicsLayerNamePrefix:_f.layerNamePrefix)+(_e++));this._layers[id]=_26;var i,lyr;if(_27===this.layerIds||_27===this.graphicsLayerIds){i=this._layerSize;this._layerSize++;}_26._isRefLayer=(_28==="top");_28=(!esri.isDefined(_28)||_28<0||_28>_27.length||_28==="top")?_27.length:_28;if(i===0){this._firstLayerId=id;}if(!_26._isRefLayer){while((lyr=this.getLayer(_27[_28-1]))&&lyr._isRefLayer){_28--;}}_27.splice(_28,0,id);var _29=dh(this,this._addLayerHandler),_2a=this,_2b=this._connects,_2c=function(){if(_26.loaded){_29(_26);}else{_2a[id+"_addtoken_load"]=dc(_26,"onLoad",_2a,"_addLayerHandler");_2a[id+"_addtoken_err"]=dc(_26,"onError",_2a,function(_2d){_29(_26,_2d,_27);});}};if(this.loaded||i===0||(_26.loaded&&_7(this.graphicsLayerIds,id)===-1)){_2c();}else{_2b.push(dc(this,"onLoad",_2c));}return _26;},_addLayerHandler:function(_2e,_2f,_30){var id=this.id,_31=_2e.id,_32=_7(_2e instanceof _c?this.graphicsLayerIds:this.layerIds,_31),_33=_32,_34=false,_35=this._params,_36,_37,_38,_39;_6(this[_31+"_addtoken_load"]);_6(this[_31+"_addtoken_err"]);if(_2f){delete this._layers[_31];if(_32!==-1){_30.splice(_32,1);this.onLayerAddResult(_2e,_2f);}return;}if(_32===-1){_32=_7(this._internalLayerIds,_31);_33=_14+_32;_34=true;}if(_2e instanceof _c){if(!this._gc){this._gc=new esri.layers._GraphicsContainer();var gc=this._gc._setMap(this,this._layersDiv);gc.id=id+"_gc";}var _3a=_2e._setMap(this,this._gc._surface);_3a.id=id+"_"+_31;this._layerDivs[_31]=_3a;this._reorderLayers(this.graphicsLayerIds);if(_35.showInfoWindowOnClick){this._clickHandles.push(dc(_2e,"onClick",this,"_gClickHandler"));}}else{var _3b=_2e._setMap(this,this._layersDiv,_33,this.__LOD);_3b.id=id+"_"+_31;this._layerDivs[_31]=_3b;this._reorderLayers(this.layerIds);if(!_34&&_2e.declaredClass.indexOf("VETiledLayer")!==-1){this._onBingLayerAdd(_2e);}}if(_31===this._firstLayerId){_37=_2e.spatialReference;_38=(this.extent&&this.extent.spatialReference);if(_38&&!_38.equals(_37)&&(_2e.tileInfo||!_2e.url)){_38=null;}_36=(this.spatialReference=(_38||_37));this.wrapAround180=(this.wrapAround180&&_36&&_36._isWrappable())?true:false;if(_2e.tileInfo){if(!this.__tileInfo){_16(_8({},_2e.tileInfo),_35);this.__tileInfo=_35.tileInfo;}else{_39=this.__tileInfo.lods;this.__tileInfo=_8({},_2e.tileInfo);this.__tileInfo.lods=_39;}}if(this.wrapAround180){var _3c=this.__tileInfo,_3d=_36._getInfo();if(!_3c||Math.abs(_3d.origin[0]-_3c.origin.x)>_3d.dx){this.wrapAround180=false;}if(this.wrapAround180&&_3c){esri.TileUtils._addFrameInfo(_3c,_3d);}}_35.units=_2e.units;_39=this.__tileInfo&&this.__tileInfo.lods;if(_39&&_39.length){var _3e=_35.minScale,_3f=_35.maxScale,_40=-1,_41=-1,_42=false,_43=false,i;for(i=0;i<_39.length;i++){if(_3e>0&&!_42&&_3e>=_39[i].scale){_40=_39[i].level;_42=true;}if(_3f>0&&!_43&&_3f>=_39[i].scale){_41=(i>0)?_39[i-1].level:-1;_43=true;}}if(_35.minZoom===-1){_35.minZoom=(_3e===0)?_39[0].level:_40;}if(_35.maxZoom===-1){_35.maxZoom=(_3f===0)?_39[_39.length-1].level:_41;}for(i=0;i<_39.length;i++){if(_35.minZoom===_39[i].level){_35.minScale=_39[i].scale;}if(_35.maxZoom===_39[i].level){_35.maxScale=_39[i].scale;}}}else{_35.minZoom=_35.maxZoom=_35.zoom=-1;}this.graphics=new _c({id:id+"_graphics",displayOnPan:_35.displayGraphicsOnPan});this._addLayer(this.graphics,this._internalLayerIds,_14);}if(_2e===this.graphics){var _44,_45=this._layers[this._firstLayerId],_46,_47=_35.zoom,_48=_35.scale,_49=_35.center,_4a=_45.initialExtent||_45.fullExtent;this._firstLayerId=null;if(this.extent){this.extent=this._convertGeometry(this,this.extent);}if(!this.extent&&_4a){if(_49){_49=this._convertGeometry(_4a,_49);}if(_49){_4a=_4a.centerAt(_49);_49=null;}}_46=this.extent||_4a;if(_46){if(_47>-1){_46=this.__getExtentForLevel(_47,null,_46).extent;}else{if(_48>0){_46=esri.geometry.getExtentForScale(this,_48,_46);}}}if(!_46){console.log("Map: "+this.invalidExtent);return;}_44=this._fixExtent(_46,_35.fitExtent);this.extent=_44.extent;this.__LOD=_44.lod;this.__setExtent(this.extent,null,null,_35.fitExtent);this.loaded=true;this.infoWindow.setMap(this);this.onLoad(this);}if(!_34){this.onLayerAdd(_2e);this.onLayerAddResult(_2e);}_6(this[_31+"_addLayerHandler_connect"]);},_convertGeometry:function(_4b,_4c){var _4d=_4b&&_4b.spatialReference,_4e=_4c&&_4c.spatialReference;if(_4d&&_4e&&!_4d.equals(_4e)){if(_4d._canProject(_4e)){if(_4d.isWebMercator()){_4c=esri.geometry.geographicToWebMercator(_4c);}else{if(_4d.wkid===4326){_4c=esri.geometry.webMercatorToGeographic(_4c,true);}}}else{console.log("Map: "+esri.substitute({geometry:_4e.wkid||_4e.wkt,map:_4d.wkid||_4d.wkt},this.invalidGeometry));_4c=null;}}return _4c;},_reorderLayers:function(_4f){var _50=this.onLayerReorder,djp=_2.place,_51=this._layerDivs,_52=this._layers,_53=this._gc?this._gc._surface.getEventSource():null;if(_4f===this.graphicsLayerIds){_2.forEach(_4f,function(id,i){var _54=_51[id];if(_54){djp(_54.getEventSource(),_53,i);_50(_52[id],i);}});}else{var g=this.graphics,gId=g?g.id:null,_55=this._layersDiv,_56;_2.forEach(_4f,function(id,i){_56=_51[id];if(id!==gId&&_56){djp(_56,_55,i);_50(_52[id],i);}});if(_53){_53=(_2.isIE<9)?_53.parentNode:_53;djp(_53,_53.parentNode,_4f.length);}}this.onLayersReordered([].concat(_4f));},_zoomStartHandler:function(){this.__zoomStart(this._zoomAnimDiv.startingExtent,this._zoomAnimDiv.anchor);},_zoomingHandler:function(_57){var rl=parseFloat(_57.left),rt=parseFloat(_57.top),_58=new _b(rl,rt-parseFloat(_57.height),rl+parseFloat(_57.width),rt,this.spatialReference),_59=this.extent.getWidth()/_58.getWidth();this.__zoom(_58,_59,this._zoomAnimDiv.anchor);},_zoomEndHandler:function(){var _5a=this._zoomAnimDiv,_5b=_5a.extent,_5c=this.extent.getWidth()/_5b.getWidth();var _5d=_5a.anchor,_5e=_5a.newLod,_5f=_5a.levelChange;_5a.extent=_5a.anchor=_5a.levelChange=_5a.startingExtent=_5a.newLod=this._delta=this._zoomAnim=null;this.__zoomEnd(_5b,_5c,_5d,_5e,_5f);},_panningHandler:function(_60){if(isNaN(parseFloat(_60.left))||isNaN(parseFloat(_60.top))){var _61=Math.round,_62=_2.style,_63=this._panAnim.node;_60.left=(-1*(this._delta.x-_61(this.width/2)))+"px";_60.top=(-1*(this._delta.y-_61(this.height/2)))+"px";_62(_63,"left",_60.left);_62(_63,"top",_60.top);}var d=new _a(parseFloat(_60.left),parseFloat(_60.top)),dm=this.toMap(d);this.onPan(this.extent.offset(dm.x,dm.y),d);},_panEndHandler:function(_64){this.__panning=false;var _65=Math.round,_66=new _a(-_65(parseFloat(_64.style.left)),-_65(parseFloat(_64.style.top))),dx=_66.x,dy=_66.y,_67=this.__visibleRect,_68=this.__visibleDelta;_67.x+=-dx;_67.y+=-dy;_68.x+=-dx;_68.y+=-dy;ds(this._zoomAnimDiv,{left:"0px",top:"0px"});var _69=this.extent,rw=this._ratioW,rh=this._ratioH;_69=new _b(_69.xmin+(dx/rw),_69.ymin-(dy/rh),_69.xmax+(dx/rw),_69.ymax-(dy/rh),this.spatialReference);_66.setX(-_66.x);_66.setY(-_66.y);this._delta=this._panAnim=null;this._updateExtent(_69);this.onPanEnd(_69,_66);this.onExtentChange(_69,_66,false,this.__LOD);},_fixExtent:function(_6a,fit){var _6b=this._reshapeExtent(_6a),_6c=1+_12;while(fit===true&&(_6b.extent.getWidth()<_6a.getWidth()||_6b.extent.getHeight()<_6a.getHeight())&&_6b.lod.level>0&&_6c<=_13){_6b=this._reshapeExtent(_6a.expand(_6c));_6c+=_12;}return _6b;},_getFrameWidth:function(){var _6d=-1,_6e=this.spatialReference._getInfo();if(this.__LOD){var _6f=this.__LOD._frameInfo;if(_6f){_6d=_6f[3];}}else{if(_6e){_6d=Math.round((2*_6e.valid[1])/(this.extent.getWidth()/this.width));}}return _6d;},_reshapeExtent:function(_70){var w=_70.getWidth(),h=_70.getHeight(),r=w/h,_71=this.width/this.height,dw=0,dh=0;if(this.width>this.height){if(w>h){if(_71>r){dw=(h*_71)-w;}else{dh=(w/_71)-h;}}else{if(w<h){dw=(h*_71)-w;}else{dw=(h*_71)-w;}}}else{if(this.width<this.height){if(w>h){dh=(w/_71)-h;}else{if(w<h){if(_71>r){dw=(h*_71)-w;}else{dh=(w/_71)-h;}}else{dh=(w/_71)-h;}}}else{if(w<h){dw=h-w;}else{if(w>h){dh=(w/_71)-h;}}}}if(dw){_70.xmin-=dw/2;_70.xmax+=dw/2;}if(dh){_70.ymin-=dh/2;_70.ymax+=dh/2;}return this._getAdjustedExtent(_70);},_getAdjustedExtent:function(_72){if(this.__tileInfo){return esri.TileUtils.getCandidateTileInfo(this,this.__tileInfo,_72);}else{var _73=esri.geometry.getScale(this,_72),_74=this.getMinScale(),_75=this.getMaxScale(),_76=!_74||(_73<=_74),_77=!_75||(_73>=_75);if(!_76){_72=esri.geometry.getExtentForScale(this,_74,_72);}else{if(!_77){_72=esri.geometry.getExtentForScale(this,_75,_72);}}return {extent:_72};}},_fixedPan:function(dx,dy){this._extentUtil(null,{dx:dx,dy:dy});},_gClickHandler:function(evt){var _78=evt.graphic,iw=this.infoWindow;if(_78._getEffInfoTemplate()&&iw){_2.stopEvent(evt);var _79=_78.geometry,_7a=(_79&&_79.type==="point")?_79:evt.mapPoint;iw.setTitle(_78.getTitle());iw.setContent(_78.getContent());iw.show(_7a);}},_onBingLayerAdd:function(_7b){this["__"+_7b.id+"_vis_connect"]=_2.connect(_7b,"onVisibilityChange",this,"_toggleBingLogo");this._toggleBingLogo(_7b.visible);},_onBingLayerRemove:function(_7c){_2.disconnect(this["__"+_7c.id+"_vis_connect"]);delete this["__"+_7c.id+"_vis_connect"];var _7d=this.layerIds;var _7e=_2.some(_7d,function(_7f){var _80=this._layers[_7f];return _80&&_80.visible&&_80.declaredClass.indexOf("VETiledLayer")!==-1;},this);this._toggleBingLogo(_7e);},_toggleBingLogo:function(_81){if(_81&&!this._bingLogo){var _82={left:(this._mapParams&&this._mapParams.nav?"25px":"")};if(_2.isIE===6){_82.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled='true', sizingMethod='crop', src='"+_2.moduleUrl("esri")+"images/map/bing-logo-lg.png"+"')";}var _83=this._bingLogo=_2.create("div",{style:_82},this.root);_2.addClass(_83,"bingLogo-lg");}else{if(!_81&&this._bingLogo){_2.destroy(this._bingLogo);delete this._bingLogo;}}},__panStart:function(x,y){var _84=this._zoomAnim,_85=this._panAnim;if(_84&&_84._active){_84.stop();_84._fire("onEnd",[_84.node]);}else{if(_85&&_85._active){_85.stop();this._panAnim=null;var _86=_85.curve.getValue(_85._getStep()),rl=Math.round(parseFloat(_86.left)),rt=Math.round(parseFloat(_86.top)),_87=this.navigationManager._dragOrigin;this.__pan(rl,rt);if(_87){_87.x-=rl;_87.y-=rt;}return;}}this.__panning=true;this.onPanStart(this.extent,new _a(x,y));},__pan:function(dx,dy){var _88=this.extent,rw=this._ratioW,rh=this._ratioH;this.onPan(new _b(_88.xmin-(dx/rw),_88.ymin+(dy/rh),_88.xmax-(dx/rw),_88.ymax+(dy/rh),this.spatialReference),new _a(dx,dy));},__panEnd:function(dx,dy){var _89=this.__visibleRect,_8a=this.__visibleDelta;_89.x+=dx;_89.y+=dy;_8a.x+=dx;_8a.y+=dy;var d=new _a(dx,dy),_8b=this.extent,rw=this._ratioW,rh=this._ratioH;_8b=new _b(_8b.xmin-(dx/rw),_8b.ymin+(dy/rh),_8b.xmax-(dx/rw),_8b.ymax+(dy/rh),this.spatialReference);this.__panning=false;this._updateExtent(_8b);this.onPanEnd(_8b,d);this.onExtentChange(_8b,d,false,this.__LOD);},__zoomStart:function(_8c,_8d){this.__zooming=true;this.onZoomStart(_8c,1,_8d,this.__LOD?this.__LOD.level:null);},__zoom:function(_8e,_8f,_90){this.onZoom(_8e,_8f,_90);},__zoomEnd:function(_91,_92,_93,lod,_94){ds(this._layersDiv,{left:"0px",top:"0px"});this._delta=new _a(0,0);this.__visibleRect.x=(this.__visibleRect.y=0);_91=new _b(_91);this.__LOD=lod;this._ratioW=this.width/_91.getWidth();this._ratioH=this.height/_91.getHeight();var _95=this._delta;this._delta=null;this.__zooming=false;this._updateExtent(_91,_94);this.onZoomEnd(_91,_92,_93,lod?lod.level:null);this.onExtentChange(_91,_95,_94,lod);},_extentUtil:function(_96,pan,_97,fit,_98){var _99,_9a,_9b,_9c,_9d,_9e,_9f,_a0,dx,dy,_a1=this.width,_a2=this.height,_a3,_a4,_a5;if(_96){_99=_96.numLevels;_9a=_96.targetLevel;_a3=esri.isDefined(_9a);_9b=_96.factor;_9c=_96.mapAnchor;_9d=_96.screenAnchor;_9e=_96.mapCenter;_a4=_96.levelOrFactor;_9f=_96.targetScale;_a0=esri.isDefined(_9f)&&_9f>0;}if(pan){dx=pan.dx;dy=pan.dy;_9e=pan.mapCenter;}if(_2.isArray(_9e)){_9e=new esri.geometry.Point(_9e);}var _a6=this._panAnim,_a7=this._stopAnim(),_a8=_a7?_a7.divExtent:this.extent,_a9=this.__tileInfo,_aa,_ab,ewd,eht,_ac=this._params;if(!this.loaded){if(_97){if(_a8){_97=this._convertGeometry(_a8,_97);}if(_97){this.extent=_97;_ac.zoom=_ac.scale=-1;_ac.center=null;}}else{if(_9e||_a3||_a0){if(_9e){if(_a8){_9e=this._convertGeometry(_a8,_9e);if(_9e){this.extent=_a8.centerAt(_9e);_ac.center=null;}}else{_ac.center=_9e;}}if(_a3&&_9a>-1){_ac.zoom=_9a;_ac.scale=-1;}else{if(_a0){_ac.scale=_9f;_ac.zoom=-1;}}}}return;}if(_9e){_9e=this._convertGeometry(this,_9e);if(!_9e){return;}}if(_9c){_9c=this._convertGeometry(this,_9c);if(!_9c){return;}}if(_97){_97=this._convertGeometry(this,_97);if(!_97){return;}}if(_a6&&_9c&&_9d){_9c=_4(this.extent,_a1,_a2,_9d);}if(_a7&&_9c&&_9d){_9c=_4(_a7.divExtent,_a1,_a2,_9d);}if(_a3){if(_a9){var _ad=this.getMinZoom(),_ae=this.getMaxZoom();if(_9a<_ad){_9a=_ad;}else{if(_9a>_ae){_9a=_ae;}}_99=_9a-(_a7?_a7.level:this.getLevel());}else{_99=_9a>0?-1:1;_a5=_a4?_9a:null;}}if(_97){}else{if(esri.isDefined(_99)){var _af;if(_a9){var _b0=_a7?_a7.level:this.getLevel();_af=this.__getExtentForLevel(_b0+_99,_9e,_a8).extent;}else{var _b1=_a7?_a7.end:this.extent;_af=_b1.expand(_a5||(_99>0?0.5*_99:2*-_99));if(_a5&&_9e){_af=_af.centerAt(_9e);}}if(_af){if(_9e){_97=_af;}else{var _b2=_9c||_a8.getCenter(),_b3=_a8.ymax-((_af.getHeight()-_a8.getHeight())*(_b2.y-_a8.ymax)/_a8.getHeight());_aa=_a8.xmin-((_af.getWidth()-_a8.getWidth())*(_b2.x-_a8.xmin)/_a8.getWidth());_97=new _b(_aa,_b3-_af.getHeight(),_aa+_af.getWidth(),_b3,this.spatialReference);}}}else{if(_a0){_97=esri.geometry.getExtentForScale(this,_9f,_a8);}else{if(esri.isDefined(_9b)){_97=_a8.expand(_9b);}else{if(dx||dy){if(_a7){var end=_a7.end,c1=end.getCenter(),c2=_5(end,_a1,_a2,c1);c2.x+=dx;c2.y+=dy;c2=_4(end,_a1,_a2,c2);_97=end.offset(c2.x-c1.x,c2.y-c1.y);}else{var _b4=new _a((_a1/2)+dx,(_a2/2)+dy),_b5=_4(_a8,_a1,_a2,_b4);ewd=_a8.getWidth();eht=_a8.getHeight();_aa=_b5.x-(ewd/2);_ab=_b5.y-(eht/2);_97=new _b(_aa,_ab,_aa+ewd,_ab+eht,this.spatialReference);}}}}}}if(!_97){if(_9e){var ext=_a7?_a7.end:_a8;ewd=ext.getWidth();eht=ext.getHeight();_aa=_9e.x-(ewd/2);_ab=_9e.y-(eht/2);_97=new _b(_aa,_ab,_aa+ewd,_ab+eht,this.spatialReference);}else{if(_a7){_97=_a7.end;}}}if(_97){this.__setExtent(_97,null,_9d,fit,_a7,_98);}},__setExtent:function(_b6,_b7,_b8,fit,_b9,_ba){try{if(this._firstLayerId){this.extent=_b6;return;}var _bb=true,sr=this.spatialReference,ext=_b9?_b9.divExtent:this.extent,_bc=this._fixExtent(_b6,fit||false);_b6=_bc.extent;var _bd=_b6.getWidth(),_be=_b6.getHeight(),_bf=Math.round;if(ext){var tw=_bf(ext.getWidth()*_10),w=_bf(_bd*_10),th=_bf(ext.getHeight()*_10),h=_bf(_be*_10);_bb=(tw!==w)||(th!==h);}var _c0,end,_c1,_c2,_c3=_b9&&_b9.rect,_c4=_b9&&_b9.divExtent;if(_f.zoomDuration&&_bb&&ext){_c4=_c4||new _b(ext);_c3=_c3||{left:ext.xmin,top:ext.ymax,width:ext.getWidth(),height:ext.getHeight()};end={left:_b6.xmin,top:_b6.ymax,width:_bd,height:_be};_c1=_c3.width/end.width;_c2=_c3.height/end.height;var mtl=new _9(_b6.xmin,_b6.ymax,sr),mbl=new _9(_b6.xmin,_b6.ymin,sr),etl=new _9(this.extent.xmin,this.extent.ymax,sr),ebl=new _9(this.extent.xmin,this.extent.ymin,sr);_c0=esri.geometry.getLineIntersection(etl,mtl,ebl,mbl,sr);if(!_c0&&!_b9){_bb=false;}}this._ratioW=this.width/_bd;this._ratioH=this.height/_be;var _c5=this._zoomAnimDiv;if(_bb){ds(this._layersDiv,{left:"0px",top:"0px"});_b7=new _a(0,0);this.__visibleRect.x=(this.__visibleRect.y=0);if(_c3&&end){this._delta=_b7;_c5.id="_zAD";_c5.startingExtent=_c4;_c5.extent=_b6;_c5.levelChange=_bb;_c5.newLod=_bc.lod;if(_b8){_c5.anchor=_b8;}else{if(!_c0&&_b9){_c5.anchor=_b9.anchor;}else{_c5.anchor=_5(this.extent,this.width,this.height,_c0);}}this._zoomAnim=esri.fx.resize({node:_c5,start:_c3,end:end,duration:_f.zoomDuration,rate:_f.zoomRate,beforeBegin:!_b9?this._zoomStartHandler:null,onAnimate:this._zoomingHandler,onEnd:this._zoomEndHandler}).play();this._fireOnScale(this.extent.getWidth()/_b6.getWidth(),_c5.anchor);}else{this._updateExtent(_b6,_bb);this.onExtentChange(this.extent,_b7,_bb,(this.__LOD=_bc.lod));}}else{if(!this.__panning){if(this.loaded===false||_ba){this._updateExtent(_b6,_bb);this.onExtentChange(this.extent,_b7,_bb,(this.__LOD=_bc.lod));}else{this.__panning=true;_c3=new _d(0,0,this.width,this.height,this.spatialReference).getCenter();_c3.x=_bf(_c3.x);_c3.y=_bf(_c3.y);this.onPanStart(this.extent,new _a(0,0));var _c6=(this._delta=this.toScreen(_b6.getCenter()));this._panAnim=esri.fx.slideTo({node:_c5,left:_c3.x-_c6.x,top:_c3.y-_c6.y,duration:_f.panDuration,rate:_f.panRate,onAnimate:this._panningHandler,onEnd:this._panEndHandler});this._panAnim.play();}}}}catch(e){console.log(e.stack);console.error(e);}},_fireOnScale:function(_c7,_c8,_c9){if(this.navigationMode==="css-transforms"){var vd=this.__visibleDelta;this.onScale(_3.gfx.matrix.scaleAt(_c7,{x:-1*((this.width/2)-(_c8.x-vd.x)),y:-1*((this.height/2)-(_c8.y-vd.y))}),_c9);}},_stopAnim:function(){var _ca=this._zoomAnim,_cb=this._panAnim;if(_ca&&_ca._active){_ca.stop();var _cc=_ca.curve.getValue(_ca._getStep()),rl=parseFloat(_cc.left),rt=parseFloat(_cc.top),_cd=_ca.node;return {anchor:_cd.anchor,start:_cd.startingExtent,end:_cd.extent,level:_cd.newLod&&_cd.newLod.level,rect:_cc,divExtent:new _b(rl,rt-parseFloat(_cc.height),rl+parseFloat(_cc.width),rt,this.spatialReference)};}else{if(_cb&&_cb._active){_cb.stop();_cb._fire("onEnd",[_cb.node]);}}},__getExtentForLevel:function(_ce,_cf,_d0){var ti=this.__tileInfo,_d1=ti&&ti.lods;_ce=esri.isDefined(_ce)?_ce:0;_d0=_d0||this.extent;_cf=_cf||(_d0&&_d0.getCenter());if(_d1){if(!_cf){console.log("Map: "+this.invalidExtent);return;}var _d2=this.getMinZoom(),_d3=this.getMaxZoom();if(_ce>_d3){_ce=_d3;}if(_ce<_d2){_ce=_d2;}var lod=_d1[_ce],_d4=this.width*lod.resolution/2,_d5=this.height*lod.resolution/2;return {extent:new _b(_cf.x-_d4,_cf.y-_d5,_cf.x+_d4,_cf.y+_d5,_cf.spatialReference),lod:lod};}else{if(!_d0){console.log("Map: "+this.invalidExtent);return;}_ce=(!_ce||_ce<1)?1:_ce;return {extent:_d0.expand(_ce).centerAt(_cf)};}},_jobs:0,_incr:function(){if((++this._jobs)===1){this.updating=true;this.onUpdateStart();}},_decr:function(){var _d6=--this._jobs;if(!_d6){this.updating=false;this.onUpdateEnd();}else{if(_d6<0){this._jobs=0;}}},_fireEvent:function(_d7,_d8){if(this[_d7]){this[_d7].apply(this,_d8);}},_updateExtent:function(_d9,_da){this.extent=_d9;if(_da){this._setClipRect();}var _db=this.spatialReference;if(_db){if(_db.isWebMercator()){this.geographicExtent=esri.geometry.webMercatorToGeographic(this._getAvailExtent(),true);}else{if(_db.wkid===4326){this.geographicExtent=new esri.geometry.Extent(this._getAvailExtent().toJson());}}}},onUpdateStart:function(){},onUpdateEnd:function(){},onLoad:function(){this._setClipRect();},onUnload:function(){},onExtentChange:function(a,b,_dc){},onTimeExtentChange:function(){},onLayerAdd:function(){},onLayerAddResult:function(){},onLayersAddResult:function(){},onLayerRemove:function(){},onLayersRemoved:function(){},onLayerReorder:function(){},onLayersReordered:function(){},onLayerSuspend:function(){},onLayerResume:function(){},onPanStart:function(){},onPan:function(){},onPanEnd:function(){},onScale:function(){},onZoomStart:function(){},onZoom:function(){},onZoomEnd:function(){},onResize:function(){this._setClipRect();},onReposition:function(){},destroy:function(){if(!this._destroyed){this.removeAllLayers();this._cleanUp();if(this._gc){this._gc._cleanUp();}this._destroyed=true;this.onUnload(this);}},setCursor:function(_dd){ds(this.__container,"cursor",(this.cursor=_dd));},setMapCursor:function(c){this.setCursor((this._cursor=c));},resetMapCursor:function(){this.setCursor(this._cursor);},setInfoWindow:function(_de){var iw=this.infoWindow;if(iw){iw.unsetMap(this);}this.infoWindow=_de;if(this.loaded&&_de){_de.setMap(this);}},setInfoWindowOnClick:function(_df){var _e0=this._params;if(_df){if(!_e0.showInfoWindowOnClick){var _e1=[this.graphics].concat(_2.map(this.graphicsLayerIds,this.getLayer,this));_2.map(_e1,function(_e2){if(_e2&&_e2.loaded){this._clickHandles.push(dc(_e2,"onClick",this,"_gClickHandler"));}},this);}}else{_2.forEach(this._clickHandles,_6);this._clickHandles=[];}_e0.showInfoWindowOnClick=_df;},getInfoWindowAnchor:function(pt){var w2=this.width/2,h2=this.height/2,_e3;if(pt.y<h2){_e3="LOWER";}else{_e3="UPPER";}if(pt.x<w2){return esri.dijit.InfoWindow["ANCHOR_"+_e3+"RIGHT"];}else{return esri.dijit.InfoWindow["ANCHOR_"+_e3+"LEFT"];}},toScreen:function(pt,_e4){return _5(this.extent,this.width,this.height,pt,_e4);},toMap:function(pt){return _4(this.extent,this.width,this.height,pt);},addLayer:function(_e5,_e6){return this._addLayer(_e5,_e5 instanceof _c?this.graphicsLayerIds:this.layerIds,_e6);},addLayers:function(_e7){var _e8=[],_e9=_e7.length,_ea,i,len=_e7.length;var _eb=function(_ec,_ed){if(_2.indexOf(_e7,_ec)!==-1){_e9--;_e8.push({"layer":_ec,"success":!_ed,"error":_ed});if(!_e9){_2.disconnect(_ea);this.onLayersAddResult(_e8);}}};_ea=_2.connect(this,"onLayerAddResult",_eb);for(i=0;i<len;i++){this.addLayer(_e7[i]);}return this;},removeLayer:function(_ee,_ef){var id=_ee.id,ids=_ee instanceof _c?this.graphicsLayerIds:this.layerIds,i=_7(ids,id);if(i>=0){ids.splice(i,1);if(_ee instanceof _c){_6(this["_gl_"+_ee.id+"_click_connect"]);if(_ee.loaded){_ee._unsetMap(this,this._gc._surface);}}else{if(_ee.loaded){_ee._unsetMap(this,this._layersDiv);if(_ee.declaredClass.indexOf("VETiledLayer")!==-1){this._onBingLayerRemove(_ee);}}}delete this._layers[id];delete this._layerDivs[id];if(!_ef){this._reorderLayers(ids);}this.onLayerRemove(_ee);}},removeAllLayers:function(){var ids=this.layerIds,i;for(i=ids.length-1;i>=0;i--){this.removeLayer(this._layers[ids[i]],1);}ids=this.graphicsLayerIds;for(i=ids.length-1;i>=0;i--){this.removeLayer(this._layers[ids[i]],1);}this.onLayersRemoved();},reorderLayer:function(_f0,_f1){if(_2.isString(_f0)){_2.deprecated(this.declaredClass+": "+esri.bundle.map.deprecateReorderLayerString,null,"v2.0");_f0=this.getLayer(_f0);}var id=_f0.id,i,ids=_f0 instanceof _c?this.graphicsLayerIds:this.layerIds;if(_f1<0){_f1=0;}else{if(_f1>=ids.length){_f1=ids.length-1;}}i=_7(ids,id);if(i===-1||i===_f1){return;}ids.splice(i,1);ids.splice(_f1,0,id);this._reorderLayers(ids);},getLayer:function(id){return this._layers[id];},setExtent:function(_f2,fit){_f2=new esri.geometry.Extent(_f2.toJson());var _f3=_f2.getWidth(),_f4=_f2.getHeight();if(_f3===0&&_f4===0){this.centerAt(new esri.geometry.Point({x:_f2.xmin,y:_f2.ymin,spatialReference:_f2.spatialReference&&_f2.spatialReference.toJson()}));}else{this._extentUtil(null,null,_f2,fit);}},centerAt:function(_f5){this._extentUtil(null,{mapCenter:_f5});},centerAndZoom:function(_f6,_f7){this._extentUtil({targetLevel:_f7,mapCenter:_f6,levelOrFactor:true});},getScale:function(){return this.__LOD?this.__LOD.scale:esri.geometry.getScale(this);},getMinScale:function(){return this._params.minScale;},getMaxScale:function(){return this._params.maxScale;},setScale:function(_f8){this._extentUtil({targetScale:_f8});},getLayersVisibleAtScale:function(_f9){var _fa=[];_f9=_f9||this.getScale();if(_f9){_2.forEach(this.layerIds.concat(this.graphicsLayerIds),function(_fb){_fb=this.getLayer(_fb);if(_fb.isVisibleAtScale(_f9)){_fa.push(_fb);}},this);}return _fa;},getNumLevels:function(){var _fc=this.getMinZoom(),_fd=this.getMaxZoom();return ((_fc===_fd)&&_fc<0)?0:(_fd-_fc+1);},getLevel:function(){return this.__LOD?this.__LOD.level:-1;},setLevel:function(_fe){if(_fe>-1){this._extentUtil({targetLevel:_fe});}},getZoom:function(){return this.getLevel();},setZoom:function(_ff){this.setLevel(_ff);},getMinZoom:function(){return this._params.minZoom;},getMaxZoom:function(){return this._params.maxZoom;},setBasemap:function(_100){var _101,_102="Map.setBasemap: ";if(_2.isObject(_100)){_101=_100;_100=_101.title;}else{_101=_f.basemaps&&_f.basemaps[_100];}if(_101){if(this._basemapDfd&&this._basemapDfd.fired===-1){this._basemapDfd.cancel();}var _103=[],_104=[],_105=0;_2.forEach(_101.baseMapLayers||_101.layers,function(_106){var _107,_108={id:_106.id,displayLevels:_106.displayLevels,opacity:esri.isDefined(_106.opacity)?_106.opacity:null,visible:esri.isDefined(_106.visibility)?_106.visibility:null};if(_106.type){switch(_106.type){case "OpenStreetMap":_107=new esri.layers.OpenStreetMapLayer(_108);break;default:console.log(_102+esri.substitute({basemapName:_100,type:_106.type},this.unknownLayerType));break;}}else{var url=_106.url;if(window.location.protocol==="https:"&&((url.search(/^http\:\/\/server\.arcgisonline\.com/i)!==-1)||(url.search(/^http\:\/\/services\.arcgisonline\.com/i)!==-1)||(url.search(/^http\:\/\/.+\.arcgis\.com/i)!==-1))){url=url.replace(/http:/i,"https:");}_107=new esri.layers.ArcGISTiledMapServiceLayer(url,_108);}if(_107){_103.push(_107);_104.push(_106);if(!_106.isReference){_105++;}}},this);if(!_103.length||!_105){console.log(_102+esri.substitute({basemapName:_100},this.invalidBasemap));return;}var _109={basemapName:_100,infos:_104,layers:_103};if(!this.loaded){this._basemapLoaded(_109);return;}var self=this,dfd=new _2.Deferred(esri._dfdCanceller),_10a=function(_10b){dfd._pendingLayers--;var idx=_2.indexOf(_109.layers,this);if(idx>-1){var _10c=dfd._layerEvents[idx];if(_10c){_2.disconnect(_10c[0]);_2.disconnect(_10c[1]);}}if(dfd._pendingLayers<=0){delete dfd._layerEvents;delete self._basemapDfd;dfd.callback(_109);}};this._basemapDfd=dfd;dfd._pendingLayers=0;dfd._layerEvents={};_2.forEach(_103,function(_10d,i){if(_10d){dfd._pendingLayers++;if(_10d.loaded){_10a(_10d);}else{dfd._layerEvents[i]=[_2.connect(_10d,"onLoad",_10d,_10a),_2.connect(_10d,"onError",_10d,_10a)];}}});dfd.addCallback(_2.hitch(this,this._basemapLoaded));}else{var _10e=[],_10f;for(_10f in _f.basemaps){_10e.push(_10f);}console.log(_102+esri.substitute({basemapName:_100,list:_10e.join(",")},this.unknownBasemap));}},_basemapLoaded:function(_110){var _111=_110.layers,_112=_110.infos,_113=0,_114=true;if(this.loaded){_2.forEach(_111,function(_115,i){if(_115.loaded){if(!_112[i].isReference){_113++;}}});_114=_113;}if(_114){this._removeBasemap();this._basemap=_110.basemapName;this.basemapLayerIds=this._addBasemap(_111,_112);this._fireEvent("onBasemapChange");}},_addBasemap:function(_116,_117){var _118=[],ids=[],_119=0;_2.forEach(_116,function(_11a,i){if(_117[i].isReference){_118.push(_11a);}else{this.addLayer(_11a,_119++);ids.push(_11a.id);}},this);if(_118.length){_2.forEach(_118,function(_11b){this.addLayer(_11b,"top");ids.push(_11b.id);},this);}return ids;},_removeBasemap:function(){var ids=this.basemapLayerIds,_11c;if(ids&&ids.length){_2.forEach(ids,function(id){_11c=this.getLayer(id);if(_11c){this.removeLayer(_11c);}},this);}},getBasemap:function(){return this._basemap||"";},translate:function(dx,dy){dx=dx||0;dy=dy||0;if(!this._txTimer){this._tx=this._ty=0;var _11d=this.toScreen(this.extent.getCenter());this.__panStart(_11d.x,_11d.y);}this._tx+=dx;this._ty+=dy;this.__pan(this._tx,this._ty);clearTimeout(this._txTimer);this._txTimer=setTimeout(this._endTranslate,150);},_endTranslate:function(){clearTimeout(this._txTimer);this._txTimer=null;var dx=this._tx,dy=this._ty;this._tx=this._ty=0;this.__panEnd(dx,dy);},setTimeExtent:function(_11e){this.timeExtent=_11e;var arg=_11e?new esri.TimeExtent(_11e.startTime,_11e.endTime):null;this.onTimeExtentChange(arg);},setTimeSlider:function(_11f){if(this.timeSlider){_6(this._tsTimeExtentChange_connect);this._tsTimeExtentChange_connect=null;this.timeSlider=null;}if(_11f){this.timeSlider=_11f;this.setTimeExtent(_11f.getCurrentTimeExtent());this._tsTimeExtentChange_connect=dc(_11f,"onTimeExtentChange",this,"setTimeExtent");}},resize:function(_120){var self=this,_121=function(){clearTimeout(self._resizeT);self.reposition();self._resize();};clearTimeout(self._resizeT);if(_120===true){_121();}else{self._resizeT=setTimeout(_121,self.resizeDelay);}},_resize:function(){var w=this.width,h=this.height,box=_2.contentBox(this.container);if(w===box.w&&h===box.h){return;}var _122=this._zoomAnim||this._panAnim;if(_122){_122.stop();_122._fire("onEnd",[_122.node]);}ds(this.root,{width:(this.width=box.w)+"px",height:(this.height=box.h)+"px"});var wd=this.width,ht=this.height;if(this.attribution&&this.attribution.domNode){_2.style(this.attribution.domNode,"width",Math.floor(wd*this._mapParams.attributionWidth)+"px");}this.__visibleRect.update(this.__visibleRect.x,this.__visibleRect.y,wd,ht);this.__visibleDelta.update(this.__visibleDelta.x,this.__visibleDelta.y,wd,ht);var r=esri.geometry._extentToRect(this.extent),ne=(esri.geometry._rectToExtent(new _d(r.x,r.y,r.width*(wd/w),r.height*(ht/h),this.spatialReference)));this.onResize(ne,wd,ht);this._extentUtil(null,null,ne,null,true);},reposition:function(){this._reposition();this.onReposition(this.position.x,this.position.y);},_reposition:function(){var pos=_2.coords(this.container,true),brdr=_2._getPadBorderExtents(this.container);this.position.update(pos.x+brdr.l,pos.y+brdr.t);},_setClipRect:function(){delete this._clip;var _123=_2.isIE?"rect(auto,auto,auto,auto)":null;if(this.wrapAround180){var _124=this.width,_125=this.height,_126=this._getFrameWidth(),diff=_124-_126;if(diff>0){var left=diff/2;_123="rect(0px,"+(left+_126)+"px,"+_125+"px,"+left+"px)";var _127=this.extent.getWidth(),_128=_127*(_126/_124);this._clip=[(_127-_128)/2,_128];}}ds(this.__container,"clip",_123);},_getAvailExtent:function(){var _129=this.extent,clip=this._clip;if(clip){if(!_129._clip){var rect=new esri.geometry._extentToRect(_129);rect.width=clip[1];rect.x=rect.x+clip[0];_129._clip=rect.getExtent();}return _129._clip;}return _129;},panUp:function(){this._fixedPan(0,this.height*-_11);},panUpperRight:function(){this._fixedPan(this.width*_11,this.height*-_11);},panRight:function(){this._fixedPan(this.width*_11,0);},panLowerRight:function(){this._fixedPan(this.width*_11,this.height*_11);},panDown:function(){this._fixedPan(0,this.height*_11);},panLowerLeft:function(){this._fixedPan(this.width*-_11,this.height*_11);},panLeft:function(){this._fixedPan(this.width*-_11,0);},panUpperLeft:function(){this._fixedPan(this.width*-_11,this.height*-_11);},enableSnapping:function(_12a){if(!_12a){_12a={};}if(_12a.declaredClass==="esri.SnappingManager"){this.snappingManager=_12a;}else{this.snappingManager=new esri.SnappingManager(_2.mixin({map:this},_12a));}return this.snappingManager;},disableSnapping:function(){if(this.snappingManager){this.snappingManager.destroy();}this.snappingManager=null;}};}()));});