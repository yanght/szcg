/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/BasemapGallery",["dijit","dojo","dojox","dojo/require!esri/virtualearth/VETiledLayer,esri/layers/osm,dijit/_Widget,dijit/_Templated,dojo/DeferredList"],function(_1,_2,_3){_2.provide("esri.dijit.BasemapGallery");_2.require("esri.virtualearth.VETiledLayer");_2.require("esri.layers.osm");_2.require("dijit._Widget");_2.require("dijit._Templated");_2.require("dojo.DeferredList");esri.dijit._arcgisUrl="http://www.arcgis.com/sharing/rest";_2.declare("esri.dijit.BasemapGallery",[_1._Widget,_1._Templated],{widgetsInTemplate:true,templateString:"<div class=\"esriBasemapGallery\">\r\n  <div dojoAttachPoint=\"flowContainer\">\r\n  </div>\r\n</div>",basePath:_2.moduleUrl("esri.dijit"),loaded:false,basemaps:[],bingMapsKey:null,flowContainer:null,_hasUI:false,_selectedBasemap:null,_selectBasemapInProgress:false,constructor:function(_4,_5){_4=_4||{};if(!_4.map){console.error("esri.dijit.BasemapGallery: Unable to find the 'map' property in parameters");}this.map=_4.map;this._hasUI=_5?true:false;this.bingMapsKey=(_4.bingMapsKey&&_4.bingMapsKey.length>0)?_4.bingMapsKey:null;this.showArcGISBasemaps=(_4.showArcGISBasemaps===false)?false:true;this.basemaps=_4.basemaps?_4.basemaps:[];this.basemapIds=_4.basemapIds;this.referenceIds=_4.referenceIds;this.basemapsGroup=_4.basemapsGroup;if(location.protocol==="https:"){esri.dijit._arcgisUrl=esri.dijit._arcgisUrl.replace("http:","https:");}this.init();},init:function(){this.inherited(arguments);_2.forEach(this.basemaps,function(_6,i){if(!_6.id||_6.id.length===0){_6.id=this._getUniqueId();}_2.forEach(_6.layers,function(_7){_7.opacity=(_7.opacity>=0)?_7.opacity:1;_7.visibility=true;},this);},this);if(this.basemapIds&&this.basemapIds.length>0){_2.forEach(this.basemapIds,function(_8){var _9=this.map.getLayer(_8);_9._basemapGalleryLayerType="basemap";},this);}if(this.referenceIds&&this.referenceIds.length>0){_2.forEach(this.referenceIds,function(_a){var _b=this.map.getLayer(_a);_b._basemapGalleryLayerType="reference";},this);}if(this.basemapsGroup&&((this.basemapsGroup.owner&&this.basemapsGroup.title)||this.basemapsGroup.id)){this._findCustomBasemapsGroup(_2.hitch(this,"_handleArcGISBasemapsResponse"));}else{if(this.showArcGISBasemaps){this._findArcGISBasemapsGroup(_2.hitch(this,"_handleArcGISBasemapsResponse"));}else{this._finishStartup();}}},startup:function(){if(this.loaded){this._refreshUI();}else{_2.connect(this,"onLoad",_2.hitch(this,function(){this._refreshUI();}));}},select:function(id){this._select(id);},getSelected:function(){return this._selectedBasemap;},get:function(id){for(var i=0;i<this.basemaps.length;i++){if(this.basemaps[i].id==id){return this.basemaps[i];}}return null;},add:function(_c){if(_c&&!_c.id){_c.id=this._getUniqueId();this.basemaps.push(_c);this._refreshUI();this.onAdd(_c);return true;}else{if(_c&&this._isUniqueId(_c.id)){this.basemaps.push(_c);this._refreshUI();this.onAdd(_c);return true;}}return false;},remove:function(id){for(var i=0;i<this.basemaps.length;i++){var _d=this.basemaps[i];if(_d.id===id){if(this._selectedBasemap&&this._selectedBasemap.id===_d.id){this._selectedBasemap=null;}this.basemaps.splice(i,1);this._refreshUI();this.onRemove(_d);return _d;}}return null;},onLoad:function(){},onSelectionChange:function(){},onAdd:function(_e){},onRemove:function(_f){},onError:function(msg){},_defaultBasemapGalleryGroupQuery:"title:\"ArcGIS Online Basemaps\" AND owner:esri",_basemapGalleryGroupQuery:null,_finishStartup:function(){this.loaded=true;this.onLoad();if(this.map.layerIds.length===0&&this.basemaps.length>0&&!this._selectBasemapInProgress){this._select(this.basemaps[0].id);}},_findCustomBasemapsGroup:function(_10){if(this.basemapsGroup&&this.basemapsGroup.id){this._findArcGISBasemaps(this.basemapsGroup.id,_10);}else{this._basemapGalleryGroupQuery="title:\""+this.basemapsGroup.title+"\" AND owner:"+this.basemapsGroup.owner;this._findArcGISBasemapsGroup(_10);}},_findArcGISBasemapsGroup:function(_11){if(!this._basemapGalleryGroupQuery){var url=esri.dijit._arcgisUrl+"/accounts/self";var _12={};_12.f="json";_12.culture=_2.locale;esri.request({url:url,content:_12,callbackParamName:"callback",load:_2.hitch(this,function(_13,_14){if(_13&&_13.basemapGalleryGroupQuery){this._basemapGalleryGroupQuery=_13.basemapGalleryGroupQuery;}else{this._basemapGalleryGroupQuery=this._defaultBasemapGalleryGroupQuery;}this._findArcGISBasemapsGroupContent(_11);}),error:function(_15,_16){this._basemapGalleryGroupQuery=this._defaultBasemapGalleryGroupQuery;}});}else{this._findArcGISBasemapsGroupContent(_11);}},_findArcGISBasemapsGroupContent:function(_17){var _18=_2.hitch(this,"_findArcGISBasemaps");var url=esri.dijit._arcgisUrl+"/community/groups";var _19={};_19.q=this._basemapGalleryGroupQuery;_19.f="json";esri.request({url:url,content:_19,callbackParamName:"callback",load:function(_1a,_1b){if(_1a.results.length>0){_18(_1a.results[0].id,_17);}else{console.error("esri.dijit.BasemapGallery: could not find group for basemaps.");}},error:esriConfig.defaults.io.errorHandler});},_findArcGISBasemaps:function(_1c,_1d){var url=esri.dijit._arcgisUrl+"/search";var _1e={};_1e.q="group:"+_1c+" AND type:\"web map\"";_1e.sortField="name";_1e.sortOrder="desc";_1e.num=50;_1e.f="json";esri.request({url:url,content:_1e,callbackParamName:"callback",load:function(_1f,_20){_1d(_1f.results);},error:esriConfig.defaults.io.errorHandler});},_handleArcGISBasemapsResponse:function(_21){if(_21.length>0){_2.forEach(_21,function(_22,i){if(this.bingMapsKey||(!this.bingMapsKey&&_22.title&&_22.title.indexOf("Bing Maps")==-1)){var _23={};_23.id=this._getUniqueId();_23.title=_22.title;_23.thumbnailUrl=(_22.thumbnail&&_22.thumbnail.length>0)?(esri.dijit._arcgisUrl+"/content/items/"+_22.id+"/info/"+_22.thumbnail):"";_23.itemId=_22.id;var _24=new esri.dijit.Basemap(_23);this.basemaps.splice(0,0,_24);}},this);this._finishStartup();}},_refreshUI:function(){if(this._hasUI){_2.empty(this.flowContainer);_2.forEach(this.basemaps,function(_25,i){if(!_25.id){_25.id="basemap_"+i;}this.flowContainer.appendChild(this._buildNodeLayout(_25));},this);_2.create("br",{style:{clear:"both"}},this.flowContainer);this._markSelected(this._selectedBasemap);}},_buildNodeLayout:function(_26){var nId="galleryNode_"+_26.id;var n=_2.create("div",{id:nId,"class":"esriBasemapGalleryNode"});var _27=_2.create("a",{href:"#"},n);_2.connect(_27,"onclick",_2.hitch(this,"_onNodeClick",_26));if(_26.thumbnailUrl){_2.create("img",{"class":"esriBasemapGalleryThumbnail",src:_26.thumbnailUrl},_27);}else{_2.create("img",{"class":"esriBasemapGalleryThumbnail",src:this.basePath.toString()+"images/transparent.gif"},_27);}var _28=_2.create("div",{"class":"esriBasemapGalleryLabelContainer"},n);var _29=_26.title||"";_2.create("span",{innerHTML:_29,alt:_29,title:_29},_28);return n;},_onNodeClick:function(_2a,e){e.preventDefault();this._markSelected(_2a);this.select(_2a.id);},_markSelected:function(_2b){if(_2b){_2.forEach(_2.query(".esriBasemapGallerySelectedNode",this.domNode),function(_2c){_2.removeClass(_2c,"esriBasemapGallerySelectedNode");});var _2d=_2.byId("galleryNode_"+_2b.id);if(_2d){_2.addClass(_2d,"esriBasemapGallerySelectedNode");}}},_select:function(id){this._selectBasemapInProgress=true;var _2e=this.get(id);if(_2e){if(_2e.layers){this._getServiceInfos(_2e);}else{var _2f=_2e.getLayers();if(_2.isArray(_2f)){this._getServiceInfos(_2e);}else{_2f.addCallback(_2.hitch(this,function(_30){this._getServiceInfos(_2e);}));}}this._markSelected(_2e);}else{this._selectBasemapInProgress=false;}},_getServiceInfos:function(_31){if(location.protocol=="https:"){_2.forEach(_31.layers,function(_32){if(this._isAgolService(_32.url)||this._isHostedService(_32.url)){_32.url=_32.url.replace("http:","https:");}},this);}this._selectedBasemap=_31;var _33=[];_2.forEach(_31.layers,function(_34){if(_34.url&&_34.url.length>0&&!_34.isReference){_34.deferredsPos=_33.length;_33.push(this._getServiceInfo(_34.url));}},this);if(_33.length>0){var _35=new _2.DeferredList(_33);_35.addCallback(_2.hitch(this,function(_36){var _37=null;_2.forEach(_31.layers,function(_38){if(_38.deferredsPos===0||_38.deferredsPos){_38.serviceInfoResponse=_36[_38.deferredsPos][1];var ext=_38.serviceInfoResponse.fullExtent;if(!ext){ext=_38.serviceInfoResponse.extent;}if(!_37){_37=new esri.geometry.Extent(ext);}else{_37=_37.union(new esri.geometry.Extent(ext));}}},this);if(this.map.extent){var _39=this._getIntersectionPercent(_37,this.map.extent);if(_39<5){this.map.setExtent(_37,true);}}this._switchBasemapLayers(_31);this._updateReferenceLayer(_31);}));}else{this._switchBasemapLayers(_31);this._updateReferenceLayer(_31);}},_switchBasemapLayers:function(_3a){var _3b=_3a.layers;if(this.map.layerIds.length>0&&this.map.getNumLevels()===0&&(_3b[0].type==="OpenStreetMap"||(_3b[0].type&&_3b[0].type.indexOf("BingMaps")>-1))){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}_2.forEach(_3b,function(_3c){if(!_3c.isReference&&_3c.type&&_3c.type.indexOf("BingMaps")>-1&&!this.bingMapsKey){var msg="esri.dijit.BasemapGallery: Invalid Bing Maps key.";this.onError(msg);return;}},this);this._removeBasemapLayers();_2.forEach(_3b,function(_3d){if(!_3d.isReference){var _3e;if(_3d.type==="OpenStreetMap"){if(this.map.layerIds.length>0&&this.map.getNumLevels()===0){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}_3e=new esri.layers.OpenStreetMapLayer({id:"layer_osm",opacity:_3d.opacity});}else{if(_3d.type&&_3d.type.indexOf("BingMaps")>-1){if(this.map.layerIds.length>0&&this.map.getNumLevels()===0){var msg="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";this.onError(msg);return;}var _3f=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS;if(_3d.type=="BingMapsAerial"){_3f=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL;}else{if(_3d.type=="BingMapsRoad"){_3f=esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD;}}_3e=new esri.virtualearth.VETiledLayer({id:"layer_bing",bingMapsKey:this.bingMapsKey,mapStyle:_3f,opacity:_3d.opacity});}else{if(_3d.serviceInfoResponse&&_3d.serviceInfoResponse.mapName){if((this.map.layerIds.length===0||this.map.getNumLevels()>0)&&_3d.serviceInfoResponse.singleFusedMapCache===true){_3e=this._loadAsCached(_3d);}else{_3e=this._loadAsDynamic(_3d);}}else{if(_3d.serviceInfoResponse&&_3d.serviceInfoResponse.pixelSizeX){var _40=new esri.layers.ImageServiceParameters();_40.bandIds=_3d.bandIds;if(!_3d.bandIds&&_3d.serviceInfoResponse.bandCount&&parseInt(_3d.serviceInfoResponse.bandCount)>3){_40.bandIds=[0,1,2];}_3e=new esri.layers.ArcGISImageServiceLayer(_3d.url,{resourceInfo:_3d.serviceInfoResponse,opacity:_3d.opacity,visible:_3d.visibility,imageServiceParameters:_40});}}}}if(_3e){_3e._basemapGalleryLayerType="basemap";this.map.addLayer(_3e,0);}}},this);this._selectBasemapInProgress=false;this.onSelectionChange();},_removeBasemapLayers:function(){var _41=this.map.layerIds;var _42=[];_2.forEach(_41,function(id){var _43=this.map.getLayer(id);if(_43._basemapGalleryLayerType==="basemap"){_42.push(_43);}},this);if(_42.length===0&&_41.length>0){_42.push(this.map.getLayer(_41[0]));}if(_42.length>0){_2.forEach(_42,function(_44){this.map.removeLayer(_44);},this);}},_updateReferenceLayer:function(_45){this._removeReferenceLayer();for(var i=0;i<_45.layers.length;i++){if(_45.layers[i].isReference===true){this._addReferenceLayer(_45.layers[i]);}}},_removeReferenceLayer:function(){for(var i=this.map.layerIds.length-1;i>=0;i--){var id=this.map.layerIds[i];var _46=this.map.getLayer(id);if(_46._basemapGalleryLayerType==="reference"){this.map.removeLayer(_46);}}},_addReferenceLayer:function(_47){this._getServiceInfo(_47.url,_2.hitch(this,"_handleReferenceServiceInfoResponse",_47));},_handleReferenceServiceInfoResponse:function(_48,_49,_4a){var _4b;_48.serviceInfoResponse=_49;if(_49&&_49.mapName){if(_49.singleFusedMapCache===true){_4b=this._loadAsCached(_48);}else{_4b=this._loadAsDynamic(_48);}}else{if(_49&&_49.pixelSizeX){var _4c=new esri.layers.ImageServiceParameters();_4c.bandIds=_48.bandIds;if(!_48.bandIds&&_49.bandCount&&parseInt(_49.bandCount)>3){_4c.bandIds=[0,1,2];}_4b=new esri.layers.ArcGISImageServiceLayer(_48.url,{resourceInfo:_49,opacity:_48.opacity,visible:_48.visibility,imageServiceParameters:_4c});}}if(_4b){_4b._basemapGalleryLayerType="reference";this.map.addLayer(_4b);}},_getServiceInfo:function(url,_4d){var _4e={};_4e.f="json";var _4f=esri.request({url:url,content:_4e,callbackParamName:"callback",load:function(_50,_51){if(_4d){_4d(_50,_51);}},error:esriConfig.defaults.io.errorHandler});return _4f;},_loadAsCached:function(_52){var _53=[];if(!_52.displayLevels){_53=_2.map(_52.serviceInfoResponse.tileInfo.lods,function(lod){return lod.level;});}var _54=new esri.layers.ArcGISTiledMapServiceLayer(_52.url,{resourceInfo:_52.serviceInfoResponse,opacity:_52.opacity,visible:_52.visibility,displayLevels:(_52.displayLevels)?_52.displayLevels:_53});return _54;},_loadAsDynamic:function(_55){var _56=new esri.layers.ArcGISDynamicMapServiceLayer(_55.url,{resourceInfo:_55.serviceInfoResponse,opacity:_55.opacity,visible:_55.visibility});if(_55.visibleLayers){_56.setVisibleLayers(_55.visibleLayers);}return _56;},_getIntersectionPercent:function(_57,_58){var _59=_58.intersects(_57);if(_59){var _5a=_59.getWidth()*_59.getHeight();var _5b=_58.getWidth()*_58.getHeight();return (_5a/_5b)*100;}else{return 0;}},_getIds:function(){var ids=[];_2.forEach(this.basemaps,function(_5c){ids.push(_5c.id);},this);return ids;},_getUniqueId:function(){var _5d=","+this._getIds().toString()+",";var _5e=0;while(true){if(_5d.indexOf(",basemap_"+_5e+",")>-1){_5e++;}else{return "basemap_"+_5e;}}},_isUniqueId:function(id){var _5f=","+this._getIds().toString()+",";if(_5f.indexOf(","+id+",")===-1){return true;}return false;},_isAgolService:function(url){if(!url){return false;}return (url.indexOf("/services.arcgisonline.com/")!==-1||url.indexOf("/server.arcgisonline.com/")!==-1);},_isHostedService:function(url){if(!url){return false;}return (url.indexOf(".arcgis.com/")!==-1);}});_2.declare("esri.dijit.Basemap",null,{id:null,title:"",thumbnailUrl:null,layers:null,itemId:null,constructor:function(_60){_60=_60||{};if(!_60.layers&&!_60.itemId){console.error("esri.dijit.Basemap: unable to find the 'layers' property in parameters");}this.id=_60.id;this.itemId=_60.itemId;this.layers=_60.layers;this.title=_60.title?_60.title:"";this.thumbnailUrl=_60.thumbnailUrl;},getLayers:function(){if(this.layers){return this.layers;}else{if(this.itemId){var url=esri.dijit._arcgisUrl+"/content/items/"+this.itemId+"/data";var _61={};_61.f="json";var _62=esri.request({url:url,content:_61,callbackParamName:"callback",error:esriConfig.defaults.io.errorHandler});_62.addCallback(_2.hitch(this,function(_63,_64){this.layers=[];_2.forEach(_63.baseMap.baseMapLayers,function(_65){var _66={};if(_65.url){_66.url=_65.url;}if(_65.type){_66.type=_65.type;}if(_65.isReference){_66.isReference=_65.isReference;}if(_65.displayLevels){_66.displayLevels=_65.displayLevels;}if(_65.visibleLayers){_66.visibleLayers=_65.visibleLayers;}if(_65.bandIds){_66.bandIds=_65.bandIds;}this.layers.push(new esri.dijit.BasemapLayer(_66));},this);return this.layers;}));return _62;}}}});_2.declare("esri.dijit.BasemapLayer",null,{constructor:function(_67){_67=_67||{};if(!_67.url&&!_67.type){console.error("esri.dijit.BasemapLayer: unable to find the 'url' or 'type' property in parameters");}this.url=_67.url;this.type=_67.type;this.isReference=(_67.isReference===true)?true:false;this.displayLevels=_67.displayLevels;this.visibleLayers=_67.visibleLayers;this.bandIds=_67.bandIds;this.opacity=_67.opacity;}});});