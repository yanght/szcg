//>>built
define("dgrid/Selection",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/Deferred","dojo/on","dojo/has","dojo/aspect","./List","dojo/has!touch?./util/touch","put-selector/put","dojo/query"],function(_1,_2,_3,on,_4,_5,_6,_7,_8){var _9=_4("mac")?"metaKey":"ctrlKey";return _2("dgrid.Selection",[_6],{selectionDelegate:".dgrid-row",selectionEvents:"mousedown,dgrid-cellfocusin",deselectOnRefresh:true,allowSelectAll:false,create:function(){this.selection={};return this.inherited(arguments);},postCreate:function(){this.inherited(arguments);this._initSelectionEvents();},selection:{},selectionMode:"extended",_setSelectionMode:function(_a){if(_a==this.selectionMode){return;}this.clearSelection();this._lastSelected=null;this.selectionMode=_a;},setSelectionMode:function(_b){_1.deprecated("setSelectionMode(...)","use set(\"selectionMode\", ...) instead","dgrid 1.0");this.set("selectionMode",_b);},_handleSelect:function(_c,_d){if(this.selectionMode=="none"||(_c.type=="dgrid-cellfocusin"&&_c.parentType=="mousedown")){return;}var _e=_c.type=="mousedown"?_c[_9]:_c.ctrlKey;if(_c.type=="mousedown"||!_c.ctrlKey||_c.keyCode==32){var _f=this.selectionMode,row=_d,_10=this.row(row),_11=this._lastSelected;if(_f=="single"){if(_11==row){if(_e){this.select(row,null,null);}}else{this.clearSelection();this.select(row);}this._lastSelected=row;}else{var _12;if((_c.button!=2&&_f=="extended"&&!_e)||(_c.button==2&&!(this.selection[_10.id]))){this.clearSelection(_10.id);}if(!_c.shiftKey){_11=_12=_e?null:undefined;}this.select(row,_11,_12);if(!_11){this._lastSelected=row;}}if(_c.type=="mousedown"&&(_c.shiftKey||_e)){_c.preventDefault();}}},_initSelectionEvents:function(){var _13=this,_14=this.selectionDelegate;on(this.domNode,"selectstart",function(_15){var tag=_15.target&&_15.target.tagName;if(tag!="INPUT"&&tag!="TEXTAREA"){_15.preventDefault();}});function _16(_17){_13._handleSelect(_17,this);};if(_7){on(this.contentNode,_7.selector(_14,_7.tap),function(evt){_13._handleSelect(evt,this);});}else{on(this.contentNode,on.selector(_14,this.selectionEvents),_16);}if(this.allowSelectAll){this.on("keydown",function(_18){if(_18[_9]&&_18.keyCode==65){_18.preventDefault();_13[_13.allSelected?"clearSelection":"selectAll"]();}});}_5.before(this,"removeRow",function(_19,_1a){if(!_1a){if(this.row(_19).id in this.selection){this.deselect(_19);}}});},allowSelect:function(row){return true;},_selectionEventQueue:function(_1b,_1c){var _1d=this,_1e="dgrid-"+(_1b?"select":"deselect"),_1f=this[_1e];if(_1f){return _1f;}setTimeout(this._fireSelectionEvent=function(){if(!_1f){return;}var _20={bubbles:true,grid:_1d};_20[_1c]=_1f;on.emit(_1d.contentNode,_1e,_20);_1f=null;delete _1d[_1e];},0);return (_1f=this[_1e]=[]);},select:function(row,_21,_22){if(_22===undefined){_22=true;}if(!row.element){row=this.row(row);}if(this.allowSelect(row)){var _23=this.selection;var _24=_23[row.id];if(_22===null){_22=!_24;}var _25=row.element;if(!_22&&!this.allSelected){delete this.selection[row.id];}else{_23[row.id]=_22;}if(_25){if(_22){_8(_25,".dgrid-selected.ui-state-active");}else{_8(_25,"!dgrid-selected!ui-state-active");}}if(_22!=_24&&_25){this._selectionEventQueue(_22,"rows").push(row);}if(_21){if(!_21.element){_21=this.row(_21);}var _26=_21.element;var _27=row.element;var _28=(_26&&(_26.compareDocumentPosition?_26.compareDocumentPosition(_27)==2:_26.sourceIndex>_27.sourceIndex))?"down":"up";while(row.element!=_26&&(row=this[_28](row))){this.select(row);}}}},deselect:function(row,_29){this.select(row,_29,false);},clearSelection:function(_2a){this.allSelected=false;for(var id in this.selection){if(_2a!==id){this.deselect(id);}}},selectAll:function(){this.allSelected=true;this.selection={};for(var i in this._rowIdToObject){var row=this.row(this._rowIdToObject[i]);this.select(row.id);}},isSelected:function(_2b){if(!_2b){return false;}if(!_2b.element){_2b=this.row(_2b);}return !!this.selection[_2b.id];},refresh:function(){if(this.deselectOnRefresh){this.clearSelection();this._fireSelectionEvent&&this._fireSelectionEvent();}this._lastSelected=null;this.inherited(arguments);},renderArray:function(){var _2c=this,_2d=this.inherited(arguments);_3.when(_2d,function(_2e){var _2f=_2c.selection,i,row,_30;for(i=0;i<_2e.length;i++){row=_2c.row(_2e[i]);_30=row.id in _2f?_2f[row.id]:_2c.allSelected;if(_30){_2c.select(row,null,_30);}}});return _2d;}});});