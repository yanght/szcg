/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/TouchEvents",["dojo/_base/declare","dojo/_base/html","dojo/_base/lang","dojo/_base/sniff","dojo/dom","esri","esri/Evented","esri/utils","esri/geometry"],function(_1,_2,_3,_4,_5,_6,_7){var _8=_6.geometry;var _9=_1([_7],{tapRadius:8,doubleTapRadius:10,tapStartTolerance:50,doubleTapDuration:300,map:null,constructor:function(_a,_b){this.registerConnectEvents({"basic-tap":["BasicTap"],"click":["Click"],"double-click":["DblClick"],"double-tap":["DoubleTap"],"mouse-down":["MouseDown"],"mouse-out":["MouseOut"],"mouse-over":["MouseOver"],"mouse-up":["MouseUp"],"pinch-end":["PinchEnd"],"pinch-move":["PinchMove"],"pinch-start":["PinchStart"],"processed-double-tap":["ProcessedDoubleTap"],"processed-tap":["ProcessedTap"],"swipe-end":["SwipeEnd"],"swipe-move":["SwipeMove"],"swipe-start":["SwipeStart"],"tap":["Tap"],"two-finger-tap":["TwoFingerTap"]},{normalized:true});this.node=_a;_3.mixin(this,_b);_2.setSelectable(_a,false);this._touchStart=_3.hitch(this,this._touchStart);this._touchMove=_3.hitch(this,this._touchMove);this._touchEnd=_3.hitch(this,this._touchEnd);this._touchCancel=_3.hitch(this,this._touchCancel);_a.addEventListener("touchstart",this._touchStart,false);_a.addEventListener("touchmove",this._touchMove,false);_a.addEventListener("touchend",this._touchEnd,false);_a.addEventListener("touchcancel",this._touchCancel,false);if(this.map){this._mouseOver=_3.hitch(this,this._mouseOver);this._mouseOut=_3.hitch(this,this._mouseOut);this._mouseDown=_3.hitch(this,this._mouseDown);this._mouseUp=_3.hitch(this,this._mouseUp);this._mouseClick=_3.hitch(this,this._mouseClick);_a.addEventListener("mouseover",this._mouseOver,false);_a.addEventListener("mouseout",this._mouseOut,false);_a.addEventListener("mousedown",this._mouseDown,false);_a.addEventListener("mouseup",this._mouseUp,false);_a.addEventListener("click",this._mouseClick,false);}this._numTouches=0;this._nodeTouches=[];this._touches={};this._touchIds=[];this._taps=[];this._immediate=false;},_touchStart:function(_c){var _d=this._touches,i,_e=_c.changedTouches.length,_f,_10,_11,_12,ts=(new Date()).getTime();if(_4("android")&&_4("safari")&&_c.targetTouches.length===1&&_c.touches.length===_c.targetTouches.length&&_c.targetTouches.length===_c.changedTouches.length&&_c.changedTouches[0].identifier===0&&_d[_c.changedTouches[0].identifier]){return;}this._addTouch(_c);for(i=0;i<_e;i++){_f=_c.changedTouches[i];_10=(_d[_f.identifier]={});_10.startX=_f.pageX;_10.startY=_f.pageY;_10.startTS=ts;if(this._touchIds.indexOf(_f.identifier)===-1){this._touchIds.push(_f.identifier);}}if(this._swipeActive){_11=this._nodeTouches[0];}if(this._pinchActive){_12=this._nodeTouches[1];}if(this._numTouches===1){if(this._swipeActive){this._swipeActive=false;this._fire("onSwipeEnd",this._processTouchEvent(_c,_11));}else{if(this._pinchActive){this._pinchActive=false;this._fire("onPinchEnd",this._processTouchEvent(_c,[_11,_12]));}}}else{if(this._numTouches===2){if(this._swipeActive){if(_11){_10=_d[this._touchIds[0]];_10.startX=_11.pageX;_10.startY=_11.pageY;_10.moved=false;}this._swipeActive=false;this._fire("onSwipeEnd",this._processTouchEvent(_c,_11));}}else{if(this._swipeActive){this._swipeActive=false;this._fire("onSwipeEnd",this._processTouchEvent(_c,_11));}else{if(this._pinchActive){this._pinchActive=false;this._fire("onPinchEnd",this._processTouchEvent(_c,[_11,_12]));}}}}},_touchMove:function(_13){_13.preventDefault();this._updateTouch(_13);var _14=this._touches,i,len=_13.changedTouches.length,_15,_16,dx,dy,_17;if(_4("android")&&_4("safari")&&_13.targetTouches.length===1&&_13.touches.length===_13.targetTouches.length&&_13.targetTouches.length===_13.changedTouches.length&&_13.changedTouches[0].identifier===0&&_14[_13.changedTouches[0].identifier]&&this._touchIds.length>1){return;}for(i=0;i<len;i++){_15=_13.changedTouches[i];_16=_14[_15.identifier];if(!_16){continue;}dx=Math.abs(_15.pageX-_16.startX);dy=Math.abs(_15.pageY-_16.startY);if(!_16.moved&&((dx>=this.tapRadius)||(dy>=this.tapRadius))){_16.moved=_16.absMoved=true;}_17=_17?_17:_16.moved;}if(this._numTouches===1){var _18=_13.changedTouches[0];if(!this._swipeActive){if(_17){this._swipeActive=true;this._fire("onSwipeStart",this._processTouchEvent(_13,_18));}}else{this._fire("onSwipeMove",this._processTouchEvent(_13,_18));}}else{if(this._numTouches===2){var _19=this._nodeTouches[0],_1a=this._nodeTouches[1];if(!this._pinchActive){if(_17){var _1b=_14[_19.identifier],_1c=_14[_1a.identifier],_1d=Math.abs(_1b.startX-_1c.startX),_1e=Math.abs(_1b.startY-_1c.startY),_1f=Math.sqrt((_1d*_1d)+(_1e*_1e)),_20=Math.abs(_19.pageX-_1a.pageX),_21=Math.abs(_19.pageY-_1a.pageY),_22=Math.sqrt((_20*_20)+(_21*_21));if(Math.abs(_22-_1f)>=(2*this.tapRadius)){this._pinchActive=true;this._fire("onPinchStart",this._processTouchEvent(_13,[_19,_1a]));}}}else{this._fire("onPinchMove",this._processTouchEvent(_13,[_19,_1a]));}}}},_touchEnd:function(_23){this._removeTouch(_23);var _24=this._touches,_25=_23.changedTouches,i,len=_25.length,_26,_27,ts=(new Date()).getTime(),ids=this._touchIds;for(i=0;i<len;i++){_27=_24[_25[i].identifier];if(!_27){continue;}if(_27.absMoved){_26=true;}_27.pageX=_25[i].pageX;_27.pageY=_25[i].pageY;_27.endTS=ts;}if(this._numTouches===0){this._touches={};this._touchIds=[];if(this._swipeActive){this._swipeActive=false;this._fire("onSwipeEnd",this._processTouchEvent(_23,_25[0]));}else{if(this._pinchActive){this._pinchActive=false;this._fire("onPinchEnd",this._processTouchEvent(_23,_25));}else{if(!_26){var _28=Infinity,_29=-Infinity,_2a=Infinity,_2b=-Infinity,_2c=this.tapStartTolerance,_2d=[],_2e=true;for(i=0;i<ids.length;i++){_27=_24[ids[i]];_2d.push(_27);if(_27.startTS<_28){_28=_27.startTS;}if(_27.startTS>_29){_29=_27.startTS;}if(_27.endTS<_2a){_2a=_27.endTS;}if(_27.endTS>_2b){_2b=_27.endTS;}delete _24[ids[i]];}if(_2d.length===1&&_25[0]){var dx=Math.abs(_25[0].pageX-_2d[0].startX),dy=Math.abs(_25[0].pageY-_2d[0].startY);if((dx>=this.tapRadius)||(dy>=this.tapRadius)){_2e=false;}}if(_2e&&Math.abs(_29-_28)<=_2c&&Math.abs(_2b-_2a)<=_2c){this._basicTap(_23,_2d);}}}}}else{if(this._numTouches===1){if(this._pinchActive){var _2f=this._nodeTouches[0];_27=_24[_2f.identifier];_27.startX=_2f.pageX;_27.startY=_2f.pageY;_27.moved=false;this._pinchActive=false;this._fire("onPinchEnd",this._processTouchEvent(_23,[_25[0],_2f]));}}}},_touchCancel:function(_30){if(this._numTouches){this._touchEnd(_30);}},_basicTap:function(_31,_32){var ts=(new Date()).getTime(),_33=this;_31=this._processTouchEvent(_31,_32);this._taps.push({touchInfos:_32,ts:ts,event:_31});if(this._taps.length>2){this._taps.shift();}this._fire("onBasicTap",_31);clearTimeout(this._tapTimer);if(this._immediate){this._analyzeTap(true);}else{var _34=(this._taps.length===2)?(this.doubleTapDuration/2):this.doubleTapDuration;this._tapTimer=setTimeout(function(){var _35=_33;_33=null;clearTimeout(_35._tapTimer);_35._analyzeTap();},_34);}},_analyzeTap:function(_36){var _37=this._taps,_38=_37[0],_39=_37[1],_3a=_38.touchInfos,_3b=_39&&_39.touchInfos;if(!_37.length){return;}if(!_36){this._taps=[];}if(_38&&_39){if(_3a.length===_3b.length){if((_39.ts-_38.ts)<=this.doubleTapDuration){var _3c,dx,dy;if(_3a.length===1){dx=Math.abs(_3a[0].startX-_3b[0].startX);dy=Math.abs(_3a[0].startY-_3b[0].startY);_3c=(dx<=this.doubleTapRadius)&&(dy<=this.doubleTapRadius);}else{_3c=true;}if(_3c){this._processedDoubleTap(_37);}else{this._processedTap(_39);}}else{this._processedTap(_39);}}else{this._processedTap(_39);}}else{this._processedTap(_38||_39);}},_processedTap:function(tap){var _3d=tap.event;this._fire("onProcessedTap",_3d);if(tap.touchInfos.length===1){this._fire("onTap",this._fixEvent(_3d));}else{if(tap.touchInfos.length===2){this._fire("onTwoFingerTap",_3d);}}},_processedDoubleTap:function(_3e){var _3f=(_3e[1].touchInfos.length===1),_40,_41;if(_3f){_40=[this._fixEvent(_3e[0].event),this._fixEvent(_3e[1].event)];_40[1].relatedEvents=_40;}_41=[_3e[0].event,_3e[1].event];_41[1].relatedEvents=_41;this._fire("onProcessedDoubleTap",_41[1]);if(_3f){this._fire("onDoubleTap",_40[1]);this._fire("onDblClick",_40[1]);}},_addTouch:function(_42){var i,_43=_42.changedTouches,_44=this._nodeTouches;this._numTouches+=_43.length;for(i=0;i<_43.length;i++){_44.push(_43[i]);}for(i=_44.length-1;i>=0;i--){if(!_5.isDescendant(_44[i].target,document.body)){_44.splice(i,1);this._numTouches--;}}if(this._numTouches<0){this._numTouches=0;}},_removeTouch:function(_45){var i,_46=[],_47=[],_48=_45.changedTouches,_49=this._nodeTouches;this._numTouches-=_48.length;if(this._numTouches<0){this._numTouches=0;}for(i=0;i<_48.length;i++){_46.push(_48[i].identifier);}for(i=_49.length-1;i>=0;i--){if(_46.indexOf(_49[i].identifier)!==-1){_47.push(_49.splice(i,1)[0]);}}return _47;},_updateTouch:function(_4a){var i,ids=[],idx,_4b=_4a.changedTouches,_4c=this._nodeTouches;for(i=0;i<_4b.length;i++){ids.push(_4b[i].identifier);}for(i=0;i<_4c.length;i++){idx=ids.indexOf(_4c[i].identifier);if(idx!==-1){_4c.splice(i,1,_4b[idx]);}}},_mouseOver:function(_4d){this._fire("onMouseOver",this._processMouseEvent(_4d));},_mouseOut:function(_4e){this._fire("onMouseOut",this._processMouseEvent(_4e));},_mouseDown:function(_4f){this._fire("onMouseDown",this._processMouseEvent(_4f));},_mouseUp:function(_50){this._fire("onMouseUp",this._processMouseEvent(_50));},_mouseClick:function(_51){this._fire("onClick",this._processMouseEvent(_51));},_fire:function(_52,evt){if(this[_52]){this[_52](evt);}if(this.map){if(this.map[_52]){this.map[_52](evt);}}},_fixEvent:function(_53){var _54={},i;for(i in _53){_54[i]=_53[i];}if(this.map){_54.screenPoint=_54.screenPoints[0];_54.mapPoint=_54.mapPoints[0];}return _54;},_processTouchEvent:function(evt,_55){var map=this.map,pos=map&&map.position,_56=0;if(pos&&_55){if(_3.isArray(_55)){var i,_57;evt.screenPoints=[];evt.mapPoints=[];for(i=0;i<_55.length;i++){if(_55[i]){_57=new _8.ScreenPoint(_55[i].pageX-pos.x,_55[i].pageY-pos.y);evt.screenPoints.push(_57);evt.mapPoints.push(map.extent?map.toMap(_57):new _8.Point());}else{_56++;}}}else{evt.screenPoint=new _8.ScreenPoint(_55.pageX-pos.x,_55.pageY-pos.y);evt.mapPoint=map.extent?map.toMap(evt.screenPoint):new _8.Point();}}evt.numPoints=_55?(_3.isArray(_55)?(_55.length-_56):1):0;return evt;},_processMouseEvent:function(evt){var map=this.map,pos=map&&map.position;if(pos){evt.screenPoint=new _8.ScreenPoint(evt.pageX-pos.x,evt.pageY-pos.y);evt.mapPoint=map.extent?map.toMap(evt.screenPoint):new _8.Point();}return evt;},setImmediateTap:function(_58){this._immediate=_58;},destroy:function(){var _59=this.node;_59.removeEventListener("touchstart",this._touchStart,false);_59.removeEventListener("touchmove",this._touchMove,false);_59.removeEventListener("touchend",this._touchEnd,false);_59.removeEventListener("touchcancel",this._touchCancel,false);if(this.map){_59.removeEventListener("mouseover",this._mouseOver,false);_59.removeEventListener("mouseout",this._mouseOut,false);_59.removeEventListener("mousedown",this._mouseDown,false);_59.removeEventListener("mouseup",this._mouseUp,false);_59.removeEventListener("click",this._mouseClick,false);}_2.setSelectable(_59,true);clearTimeout(this._tapTimer);this.node=this.map=this._numTouches=this._nodeTouches=this._touches=this._touchIds=this._taps=null;}});if(_4("extend-esri")){_6.TouchEvents=_9;}return _9;});