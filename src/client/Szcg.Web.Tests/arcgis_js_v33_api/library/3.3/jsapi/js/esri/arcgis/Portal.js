/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/arcgis/Portal",["esri/main","dojo/_base/declare","dojo/Evented","dojo/_base/lang","dojo/_base/kernel","dojo/_base/Deferred","dojo/DeferredList","dojo/_base/array","esri/IdentityManager"],function(_1,_2,_3,_4,_5,_6,_7,_8){var _9={"options":{"disableIdentityLookup":true},"requestParams":{"f":"json"}},_a=_2("esri.arcgis.Portal",[_3],{onLoad:function(){},constructor:function(_b){_4.mixin(this,{"url":_b});this.init(_b).then(_4.hitch(this,function(){this.emit("ready",this);this.onLoad(this);}));},init:function(_c,_d){_c=(_c||this.portalUrl).replace(/\/+$/,"");var _e=_c.indexOf("/sharing");this.portalUrl=(_e!==-1?(_c+"/"):(_c+"/sharing/rest/"));return this._getSelf(this.portalUrl).then(_4.hitch(this,function(_f){_9.self=_4.mixin({},_f);var _10=_f.user;if(_10){_10.portal=this;_10=new _11(_10);}if(_9.self.id&&_9.self.canSearchPublic===false){_9.extraQuery=" AND orgid:"+_9.self.id;}_4.mixin(this,_9.self);_9.loggedInUser=_4.mixin({},_4.mixin(_10,{"credential":_d}));this.thumbnailUrl=_12.formatUrl(this.portalUrl+"accounts/self/resources/"+this.thumbnail);this.isOrganization=(this.access&&this.access.length)||false;this.created=new Date(this.created);this.modified=new Date(this.modified);return this;}));},signIn:function(){_9.options.disableIdentityLookup=false;return _1.id.getCredential(this.url).then(_4.hitch(this,"init",this.url)).then(function(){return _9.loggedInUser;},function(_13){_9.options.disableIdentityLookup=true;throw _13;});},signOut:function(){_9.loggedInUser.credential&&_9.loggedInUser.credential.destroy();_9.loggedInUser=null;_9.options.disableIdentityLookup=true;_12.clearFieldsFromObject(_9.self,this);_9.self=null;return this.init(this.url);},getPortalUser:function(){return _9.loggedInUser;},queryGroups:function(_14){return this._queryPortal(this.portalUrl+"community/groups",_12.formatQueryParams({},_14),_15);},queryItems:function(_16){return this._queryPortal(this.portalUrl+"search",_12.formatQueryParams({},_16),_17);},queryUsers:function(_18){return this._queryPortal(this.portalUrl+"community/users",_12.formatQueryParams({"sortField":"username"},_18),_11);},_getSelf:function(url){var _19=url+"accounts/self?"+"culture="+_5.locale;return _12.request(_19);},_queryPortal:function(url,_1a,_1b){var _1c=_4.mixin({"num":10,"start":0,"sortField":"title","sortOrder":"asc"},_1a),_1d=["start","query","num","nextStart"],dfd=_12.request(url,_1c).then(_4.hitch(this,function(_1e){_1e.results=_12.resultsToTypedArray(_1b,{"portal":this},_1e.results);_1e.queryParams=_4.mixin({},_1c);_1e.nextQueryParams=_4.mixin(_1c,{"start":_1e.nextStart});return _12.clearFieldsFromObject(_1d,_1e);}));dfd=_4.delegate(dfd);dfd.queryParams=_4.mixin({},_1c);dfd.nextQueryParams=_6.when(dfd,function(_1f){return _1f.nextQueryParams;});return _20(dfd);}}),_21=_2("esri.arcgis.PortalFolder",[],{constructor:function(_22){_4.mixin(this,_22);this.url=(this.portal&&this.portal.portalUrl)+"content/users/"+this.username+"/"+this.id;this.created=new Date(this.created);},getItems:function(){return _12.requestToTypedArray(this.url,null,null,_17,{"portal":this.portal,"folderId":this.id});}}),_15=_2("esri.arcgis.PortalGroup",[],{constructor:function(_23){_4.mixin(this,_23);this.url=(this.portal&&this.portal.portalUrl)+"community/groups/"+this.id;this.thumbnailUrl=_12.formatUrl(this.url+"/info/"+this.thumbnail);this.modified=new Date(this.modified);this.created=new Date(this.created);},getMembers:function(){return _12.request(this.url+"/users");},queryItems:function(_24){_24=_12.formatQueryParams({},_24);_24.q="group:"+this.id+(_24.q?(" "+_24.q):"");return this.portal.queryItems(_24);}}),_17=_2("esri.arcgis.PortalItem",[],{constructor:function(_25){_4.mixin(this,_25);this.itemUrl=(this.portal&&this.portal.portalUrl)+"content/items/"+this.id;this.userItemUrl=_12.formatUrl(this.itemUrl.replace("content",("content/users/"+this.owner)+(this.folderId?"/"+this.folderId:"")));this.itemDataUrl=_12.formatUrl(this.itemUrl+"/data");this.thumbnailUrl=_12.formatUrl(this.itemUrl+"/info/"+this.thumbnail);this.created=new Date(this.created);this.uploaded=new Date(this.uploaded);this.modified=new Date(this.modified);},addComment:function(_26){var _27=_4.isString(_26)?{"comment":_26}:_26;return _12.request(this.itemUrl+"/addComment",_27,{"usePost":true}).then(_4.hitch(this,function(_28){return _29(_4.mixin(_27,{"id":_28.commentId,"item":this}));}));},updateComment:function(_2a){if(_2a&&_2a.url&&_2a.comment){var _2b={"comment":_2a.comment};return _12.request(_2a.url+"/update",_2b,{"usePost":true}).then(function(_2c){_2a.id=_2c.commentId;return _2a;});}else{throw new Error();}},getComments:function(){return _12.requestToTypedArray(this.itemUrl+"/comments",null,null,_29,{"item":this});},deleteComment:function(_2d){if(_2d&&_2d.url){return _12.request(_2d.url+"/delete",null,{"usePost":true});}else{throw new Error();}},addRating:function(_2e){var _2f=_4.isObject(_2e)?_2e:{"rating":parseFloat(_2e)};return _12.request(this.itemUrl+"/addRating",_2f,{"usePost":true}).then(_4.hitch(this,function(_30){return new _31(_4.mixin(_2f,{"id":_30.ratingId,"item":this}));}));},getRating:function(){return _12.request(this.itemUrl+"/rating").then(_4.hitch(this,function(_32){return new _31(_4.mixin(_32,{"item":this}));}));},deleteRating:function(){return _12.request(this.itemUrl+"/deleteRating",null,{"usePost":true});}}),_29=_2("esri.arcgis.PortalComment",[],{constructor:function(_33){_4.mixin(this,_33);this.url=this.item.itemUrl+"/comments/"+this.id;this.created=new Date(this.created);}}),_31=_2("esri.arcgis.PortalRating",[],{constructor:function(_34){_4.mixin(this,_34);this.url=this.item.itemUrl+"/rating";this.created=new Date(this.created);}}),_11=_2("esri.arcgis.PortalUser",[],{constructor:function(_35){_4.mixin(this,_35);this.url=(this.portal&&this.portal.portalUrl)+"community/users/"+this.username;this.userContentUrl=(this.portal&&this.portal.portalUrl)+"content/users/"+this.username;console.log(this.userContentUrl);this.thumbnailUrl=_12.formatUrl(this.url+"/info/"+this.thumbnail);this.modified=new Date(this.modified);this.created=new Date(this.created);},getGroups:function(){return _20(_12.request(this.url).then(function(_36){return _12.resultsToTypedArray(_15,{"portal":this.portal},_36.groups);}));},getNotifications:function(){return _12.requestToTypedArray(this.url+"/notifications",null,null,null,{"portal":this.portal});},getGroupInvitations:function(){return _12.requestToTypedArray(this.url+"/invitations",null,null,null,{"portal":this.portal});},getTags:function(){return _12.requestToTypedArray(this.url+"/tags",null,null,null,{"portal":this.portal});},getFolders:function(){return _20(this.getContent().then(function(_37){return _37.folders;}));},getItems:function(_38){return _20(this.getContent(_38).then(function(_39){return _39.items;}));},getContent:function(_3a){var url=(this.url.replace("community","content"))+(_3a?("/"+_3a):"");return _12.request(url).then(_4.hitch(this,function(_3b){_3b.folders=_12.resultsToTypedArray(_21,{"portal":this.portal},_3b.folders);_3b.items=_12.resultsToTypedArray(_17,{"portal":this.portal,"folderId":_3a},_3b.items);return _3b;}));}}),_20=function(_3c){if(!_3c){return _3c;}if(_3c.then){_3c=_4.delegate(_3c);}if(!_3c.total){_3c.total=_6.when(_3c,function(_3d){return _1._isDefined(_3d.total)?_3d.total:(_3d.length||0);});}function _3e(_3f){if(!_3c[_3f]){_3c[_3f]=function(){var _40=arguments;return _6.when(_3c,function(_41){Array.prototype.unshift.call(_40,(_41.results||_41));return _20(_5[_3f].apply(_5,_40));});};}};_3e("forEach");_3e("filter");_3e("map");_3e("some");_3e("every");return _3c;},_12={useSSL:function(_42,url){return (_42.indexOf("https:")!==-1||(_9.self&&_9.self.allSSL))?url.replace("http:","https:"):url;},formatUrl:function(url){var _43=_9.loggedInUser&&_9.loggedInUser.credential&&_9.loggedInUser.credential.token;return url.indexOf("null")!==-1?null:_12.useSSL(window.location.protocol,(_43?url+(url.indexOf("?")!==-1?"&":"?")+("token="+_43):url));},resultsToTypedArray:function(_44,_45,_46){_46=_46?(_46.notifications||_46.userInvitations||_46.tags||_46.items||_46.groups||_46.comments||_46.results||_46):[];return _8.map(_46,function(_47){_47=_4.mixin(_47,_45||{});return _44?new _44(_47):_47;});},clearFieldsFromObject:function(_48,obj){if(!_4.isArray(_48)){for(var fld in _48){delete obj[fld];}}else{for(var i=0,l=_48.length;i<l;i++){delete obj[_48[i]];}}return obj;},requestToTypedArray:function(url,_49,_4a,_4b,_4c){return _20(_12.request(url,_49,_4a).then(_4.partial(_12.resultsToTypedArray,_4b,_4c)));},request:function(url,_4d,_4e){_4d&&_4d.portal&&delete _4d.portal;var _4f=_4.mixin(_4.mixin({},_4d||{}),_9.requestParams);var _50=_4.mixin(_4e||{},_9.options);return _1.request({url:_12.useSSL(window.location.protocol,(url.url||url)),content:_4f,callbackParamName:"callback",timeout:(_50&&_50.timeout)||0},_50);},formatQueryParams:function(_51,_52){var qp=_4.mixin(_4.mixin({},_51),(_4.isString(_52)?{"q":_52}:(_52||{})));qp.q=_9.extraQuery?"("+qp.q+")"+_9.extraQuery:qp.q;return qp;}};return {Portal:_a,PortalFolder:_21,PortalGroup:_15,PortalItem:_17,PortalComment:_29,PortalRating:_31,PortalUtil:_12,PortalResult:_20};});